(function(K){var fa;"undefined"==typeof exports?"function"==typeof define&&"object"==typeof define.amd&&define.amd?(fa={},define(function(){return fa})):fa="undefined"!=typeof window?window:K:fa=exports;(function(t){if(!la)var la=1E-6;if(!da)var da="undefined"!=typeof Float32Array?Float32Array:Array;if(!ha)var ha=Math.random;var z={setMatrixArrayType:function(a){da=a}};"undefined"!=typeof t&&(t.glMatrix=z);var pa=Math.PI/180;z.toRadian=function(a){return a*pa};var E={create:function(){var a=new da(2);
return a[0]=0,a[1]=0,a},clone:function(a){var b=new da(2);return b[0]=a[0],b[1]=a[1],b},fromValues:function(a,b){var d=new da(2);return d[0]=a,d[1]=b,d},copy:function(a,b){return a[0]=b[0],a[1]=b[1],a},set:function(a,b,d){return a[0]=b,a[1]=d,a},add:function(a,b,d){return a[0]=b[0]+d[0],a[1]=b[1]+d[1],a},subtract:function(a,b,d){return a[0]=b[0]-d[0],a[1]=b[1]-d[1],a}};E.sub=E.subtract;E.multiply=function(a,b,d){return a[0]=b[0]*d[0],a[1]=b[1]*d[1],a};E.mul=E.multiply;E.divide=function(a,b,d){return a[0]=
b[0]/d[0],a[1]=b[1]/d[1],a};E.div=E.divide;E.min=function(a,b,d){return a[0]=Math.min(b[0],d[0]),a[1]=Math.min(b[1],d[1]),a};E.max=function(a,b,d){return a[0]=Math.max(b[0],d[0]),a[1]=Math.max(b[1],d[1]),a};E.scale=function(a,b,d){return a[0]=b[0]*d,a[1]=b[1]*d,a};E.scaleAndAdd=function(a,b,d,f){return a[0]=b[0]+d[0]*f,a[1]=b[1]+d[1]*f,a};E.distance=function(a,b){var d=b[0]-a[0];a=b[1]-a[1];return Math.sqrt(d*d+a*a)};E.dist=E.distance;E.squaredDistance=function(a,b){var d=b[0]-a[0];a=b[1]-a[1];return d*
d+a*a};E.sqrDist=E.squaredDistance;E.length=function(a){var b=a[0];a=a[1];return Math.sqrt(b*b+a*a)};E.len=E.length;E.squaredLength=function(a){var b=a[0];a=a[1];return b*b+a*a};E.sqrLen=E.squaredLength;E.negate=function(a,b){return a[0]=-b[0],a[1]=-b[1],a};E.normalize=function(a,b){var d=b[0],f=b[1];d=d*d+f*f;return 0<d&&(d=1/Math.sqrt(d),a[0]=b[0]*d,a[1]=b[1]*d),a};E.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]};E.cross=function(a,b,d){b=b[0]*d[1]-b[1]*d[0];return a[0]=a[1]=0,a[2]=b,a};E.lerp=function(a,
b,d,f){var k=b[0];b=b[1];return a[0]=k+f*(d[0]-k),a[1]=b+f*(d[1]-b),a};E.random=function(a,b){b=b||1;var d=2*ha()*Math.PI;return a[0]=Math.cos(d)*b,a[1]=Math.sin(d)*b,a};E.transformMat2=function(a,b,d){var f=b[0];b=b[1];return a[0]=d[0]*f+d[2]*b,a[1]=d[1]*f+d[3]*b,a};E.transformMat2d=function(a,b,d){var f=b[0];b=b[1];return a[0]=d[0]*f+d[2]*b+d[4],a[1]=d[1]*f+d[3]*b+d[5],a};E.transformMat3=function(a,b,d){var f=b[0];b=b[1];return a[0]=d[0]*f+d[3]*b+d[6],a[1]=d[1]*f+d[4]*b+d[7],a};E.transformMat4=
function(a,b,d){var f=b[0];b=b[1];return a[0]=d[0]*f+d[4]*b+d[12],a[1]=d[1]*f+d[5]*b+d[13],a};E.forEach=function(){var a=E.create();return function(b,d,f,k,l,m){var q;d||=2;f||=0;for(k?q=Math.min(k*d+f,b.length):q=b.length;f<q;f+=d)a[0]=b[f],a[1]=b[f+1],l(a,a,m),b[f]=a[0],b[f+1]=a[1];return b}}();E.str=function(a){return"vec2("+a[0]+", "+a[1]+")"};"undefined"!=typeof t&&(t.vec2=E);var F={create:function(){var a=new da(3);return a[0]=0,a[1]=0,a[2]=0,a},clone:function(a){var b=new da(3);return b[0]=
a[0],b[1]=a[1],b[2]=a[2],b},fromValues:function(a,b,d){var f=new da(3);return f[0]=a,f[1]=b,f[2]=d,f},copy:function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a},set:function(a,b,d,f){return a[0]=b,a[1]=d,a[2]=f,a},add:function(a,b,d){return a[0]=b[0]+d[0],a[1]=b[1]+d[1],a[2]=b[2]+d[2],a},subtract:function(a,b,d){return a[0]=b[0]-d[0],a[1]=b[1]-d[1],a[2]=b[2]-d[2],a}};F.sub=F.subtract;F.multiply=function(a,b,d){return a[0]=b[0]*d[0],a[1]=b[1]*d[1],a[2]=b[2]*d[2],a};F.mul=F.multiply;F.divide=function(a,
b,d){return a[0]=b[0]/d[0],a[1]=b[1]/d[1],a[2]=b[2]/d[2],a};F.div=F.divide;F.min=function(a,b,d){return a[0]=Math.min(b[0],d[0]),a[1]=Math.min(b[1],d[1]),a[2]=Math.min(b[2],d[2]),a};F.max=function(a,b,d){return a[0]=Math.max(b[0],d[0]),a[1]=Math.max(b[1],d[1]),a[2]=Math.max(b[2],d[2]),a};F.scale=function(a,b,d){return a[0]=b[0]*d,a[1]=b[1]*d,a[2]=b[2]*d,a};F.scaleAndAdd=function(a,b,d,f){return a[0]=b[0]+d[0]*f,a[1]=b[1]+d[1]*f,a[2]=b[2]+d[2]*f,a};F.distance=function(a,b){var d=b[0]-a[0],f=b[1]-a[1];
a=b[2]-a[2];return Math.sqrt(d*d+f*f+a*a)};F.dist=F.distance;F.squaredDistance=function(a,b){var d=b[0]-a[0],f=b[1]-a[1];a=b[2]-a[2];return d*d+f*f+a*a};F.sqrDist=F.squaredDistance;F.length=function(a){var b=a[0],d=a[1];a=a[2];return Math.sqrt(b*b+d*d+a*a)};F.len=F.length;F.squaredLength=function(a){var b=a[0],d=a[1];a=a[2];return b*b+d*d+a*a};F.sqrLen=F.squaredLength;F.negate=function(a,b){return a[0]=-b[0],a[1]=-b[1],a[2]=-b[2],a};F.normalize=function(a,b){var d=b[0],f=b[1],k=b[2];d=d*d+f*f+k*k;
return 0<d&&(d=1/Math.sqrt(d),a[0]=b[0]*d,a[1]=b[1]*d,a[2]=b[2]*d),a};F.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]};F.cross=function(a,b,d){var f=b[0],k=b[1];b=b[2];var l=d[0],m=d[1];d=d[2];return a[0]=k*d-b*m,a[1]=b*l-f*d,a[2]=f*m-k*l,a};F.lerp=function(a,b,d,f){var k=b[0],l=b[1];b=b[2];return a[0]=k+f*(d[0]-k),a[1]=l+f*(d[1]-l),a[2]=b+f*(d[2]-b),a};F.random=function(a,b){b=b||1;var d=2*ha()*Math.PI,f=2*ha()-1,k=Math.sqrt(1-f*f)*b;return a[0]=Math.cos(d)*k,a[1]=Math.sin(d)*k,a[2]=f*b,
a};F.transformMat4=function(a,b,d){var f=b[0],k=b[1];b=b[2];return a[0]=d[0]*f+d[4]*k+d[8]*b+d[12],a[1]=d[1]*f+d[5]*k+d[9]*b+d[13],a[2]=d[2]*f+d[6]*k+d[10]*b+d[14],a};F.transformMat3=function(a,b,d){var f=b[0],k=b[1];b=b[2];return a[0]=f*d[0]+k*d[3]+b*d[6],a[1]=f*d[1]+k*d[4]+b*d[7],a[2]=f*d[2]+k*d[5]+b*d[8],a};F.transformQuat=function(a,b,d){var f=b[0],k=b[1],l=b[2];b=d[0];var m=d[1],q=d[2];d=d[3];var n=d*f+m*l-q*k,p=d*k+q*f-b*l,x=d*l+b*k-m*f;f=-b*f-m*k-q*l;return a[0]=n*d+f*-b+p*-q-x*-m,a[1]=p*d+
f*-m+x*-b-n*-q,a[2]=x*d+f*-q+n*-m-p*-b,a};F.rotateX=function(a,b,d,f){var k=[],l=[];return k[0]=b[0]-d[0],k[1]=b[1]-d[1],k[2]=b[2]-d[2],l[0]=k[0],l[1]=k[1]*Math.cos(f)-k[2]*Math.sin(f),l[2]=k[1]*Math.sin(f)+k[2]*Math.cos(f),a[0]=l[0]+d[0],a[1]=l[1]+d[1],a[2]=l[2]+d[2],a};F.rotateY=function(a,b,d,f){var k=[],l=[];return k[0]=b[0]-d[0],k[1]=b[1]-d[1],k[2]=b[2]-d[2],l[0]=k[2]*Math.sin(f)+k[0]*Math.cos(f),l[1]=k[1],l[2]=k[2]*Math.cos(f)-k[0]*Math.sin(f),a[0]=l[0]+d[0],a[1]=l[1]+d[1],a[2]=l[2]+d[2],a};
F.rotateZ=function(a,b,d,f){var k=[],l=[];return k[0]=b[0]-d[0],k[1]=b[1]-d[1],k[2]=b[2]-d[2],l[0]=k[0]*Math.cos(f)-k[1]*Math.sin(f),l[1]=k[0]*Math.sin(f)+k[1]*Math.cos(f),l[2]=k[2],a[0]=l[0]+d[0],a[1]=l[1]+d[1],a[2]=l[2]+d[2],a};F.forEach=function(){var a=F.create();return function(b,d,f,k,l,m){var q;d||=3;f||=0;for(k?q=Math.min(k*d+f,b.length):q=b.length;f<q;f+=d)a[0]=b[f],a[1]=b[f+1],a[2]=b[f+2],l(a,a,m),b[f]=a[0],b[f+1]=a[1],b[f+2]=a[2];return b}}();F.str=function(a){return"vec3("+a[0]+", "+a[1]+
", "+a[2]+")"};"undefined"!=typeof t&&(t.vec3=F);var g={create:function(){var a=new da(4);return a[0]=0,a[1]=0,a[2]=0,a[3]=0,a},clone:function(a){var b=new da(4);return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b},fromValues:function(a,b,d,f){var k=new da(4);return k[0]=a,k[1]=b,k[2]=d,k[3]=f,k},copy:function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a},set:function(a,b,d,f,k){return a[0]=b,a[1]=d,a[2]=f,a[3]=k,a},add:function(a,b,d){return a[0]=b[0]+d[0],a[1]=b[1]+d[1],a[2]=b[2]+d[2],a[3]=
b[3]+d[3],a},subtract:function(a,b,d){return a[0]=b[0]-d[0],a[1]=b[1]-d[1],a[2]=b[2]-d[2],a[3]=b[3]-d[3],a}};g.sub=g.subtract;g.multiply=function(a,b,d){return a[0]=b[0]*d[0],a[1]=b[1]*d[1],a[2]=b[2]*d[2],a[3]=b[3]*d[3],a};g.mul=g.multiply;g.divide=function(a,b,d){return a[0]=b[0]/d[0],a[1]=b[1]/d[1],a[2]=b[2]/d[2],a[3]=b[3]/d[3],a};g.div=g.divide;g.min=function(a,b,d){return a[0]=Math.min(b[0],d[0]),a[1]=Math.min(b[1],d[1]),a[2]=Math.min(b[2],d[2]),a[3]=Math.min(b[3],d[3]),a};g.max=function(a,b,
d){return a[0]=Math.max(b[0],d[0]),a[1]=Math.max(b[1],d[1]),a[2]=Math.max(b[2],d[2]),a[3]=Math.max(b[3],d[3]),a};g.scale=function(a,b,d){return a[0]=b[0]*d,a[1]=b[1]*d,a[2]=b[2]*d,a[3]=b[3]*d,a};g.scaleAndAdd=function(a,b,d,f){return a[0]=b[0]+d[0]*f,a[1]=b[1]+d[1]*f,a[2]=b[2]+d[2]*f,a[3]=b[3]+d[3]*f,a};g.distance=function(a,b){var d=b[0]-a[0],f=b[1]-a[1],k=b[2]-a[2];a=b[3]-a[3];return Math.sqrt(d*d+f*f+k*k+a*a)};g.dist=g.distance;g.squaredDistance=function(a,b){var d=b[0]-a[0],f=b[1]-a[1],k=b[2]-
a[2];a=b[3]-a[3];return d*d+f*f+k*k+a*a};g.sqrDist=g.squaredDistance;g.length=function(a){var b=a[0],d=a[1],f=a[2];a=a[3];return Math.sqrt(b*b+d*d+f*f+a*a)};g.len=g.length;g.squaredLength=function(a){var b=a[0],d=a[1],f=a[2];a=a[3];return b*b+d*d+f*f+a*a};g.sqrLen=g.squaredLength;g.negate=function(a,b){return a[0]=-b[0],a[1]=-b[1],a[2]=-b[2],a[3]=-b[3],a};g.normalize=function(a,b){var d=b[0],f=b[1],k=b[2],l=b[3];d=d*d+f*f+k*k+l*l;return 0<d&&(d=1/Math.sqrt(d),a[0]=b[0]*d,a[1]=b[1]*d,a[2]=b[2]*d,a[3]=
b[3]*d),a};g.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]};g.lerp=function(a,b,d,f){var k=b[0],l=b[1],m=b[2];b=b[3];return a[0]=k+f*(d[0]-k),a[1]=l+f*(d[1]-l),a[2]=m+f*(d[2]-m),a[3]=b+f*(d[3]-b),a};g.random=function(a,b){return b=b||1,a[0]=ha(),a[1]=ha(),a[2]=ha(),a[3]=ha(),g.normalize(a,a),g.scale(a,a,b),a};g.transformMat4=function(a,b,d){var f=b[0],k=b[1],l=b[2];b=b[3];return a[0]=d[0]*f+d[4]*k+d[8]*l+d[12]*b,a[1]=d[1]*f+d[5]*k+d[9]*l+d[13]*b,a[2]=d[2]*f+d[6]*k+d[10]*l+d[14]*
b,a[3]=d[3]*f+d[7]*k+d[11]*l+d[15]*b,a};g.transformQuat=function(a,b,d){var f=b[0],k=b[1],l=b[2];b=d[0];var m=d[1],q=d[2];d=d[3];var n=d*f+m*l-q*k,p=d*k+q*f-b*l,x=d*l+b*k-m*f;f=-b*f-m*k-q*l;return a[0]=n*d+f*-b+p*-q-x*-m,a[1]=p*d+f*-m+x*-b-n*-q,a[2]=x*d+f*-q+n*-m-p*-b,a};g.forEach=function(){var a=g.create();return function(b,d,f,k,l,m){var q;d||=4;f||=0;for(k?q=Math.min(k*d+f,b.length):q=b.length;f<q;f+=d)a[0]=b[f],a[1]=b[f+1],a[2]=b[f+2],a[3]=b[f+3],l(a,a,m),b[f]=a[0],b[f+1]=a[1],b[f+2]=a[2],b[f+
3]=a[3];return b}}();g.str=function(a){return"vec4("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"};"undefined"!=typeof t&&(t.vec4=g);z={create:function(){var a=new da(4);return a[0]=1,a[1]=0,a[2]=0,a[3]=1,a},clone:function(a){var b=new da(4);return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b},copy:function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a},identity:function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=1,a},transpose:function(a,b){if(a===b){var d=b[1];a[1]=b[2];a[2]=d}else a[0]=b[0],a[1]=b[2],
a[2]=b[1],a[3]=b[3];return a},invert:function(a,b){var d=b[0],f=b[1],k=b[2];b=b[3];var l=d*b-k*f;return l?(l=1/l,a[0]=b*l,a[1]=-f*l,a[2]=-k*l,a[3]=d*l,a):null},adjoint:function(a,b){var d=b[0];return a[0]=b[3],a[1]=-b[1],a[2]=-b[2],a[3]=d,a},determinant:function(a){return a[0]*a[3]-a[2]*a[1]},multiply:function(a,b,d){var f=b[0],k=b[1],l=b[2];b=b[3];var m=d[0],q=d[1],n=d[2];d=d[3];return a[0]=f*m+l*q,a[1]=k*m+b*q,a[2]=f*n+l*d,a[3]=k*n+b*d,a}};z.mul=z.multiply;z.rotate=function(a,b,d){var f=b[0],k=
b[1],l=b[2];b=b[3];var m=Math.sin(d);d=Math.cos(d);return a[0]=f*d+l*m,a[1]=k*d+b*m,a[2]=f*-m+l*d,a[3]=k*-m+b*d,a};z.scale=function(a,b,d){var f=b[1],k=b[2],l=b[3],m=d[0];d=d[1];return a[0]=b[0]*m,a[1]=f*m,a[2]=k*d,a[3]=l*d,a};z.str=function(a){return"mat2("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"};z.frob=function(a){return Math.sqrt(Math.pow(a[0],2)+Math.pow(a[1],2)+Math.pow(a[2],2)+Math.pow(a[3],2))};z.LDU=function(a,b,d,f){return a[2]=f[2]/f[0],d[0]=f[0],d[1]=f[1],d[3]=f[3]-a[2]*d[1],[a,b,d]};"undefined"!=
typeof t&&(t.mat2=z);z={create:function(){var a=new da(6);return a[0]=1,a[1]=0,a[2]=0,a[3]=1,a[4]=0,a[5]=0,a},clone:function(a){var b=new da(6);return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b},copy:function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a[4]=b[4],a[5]=b[5],a},identity:function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=1,a[4]=0,a[5]=0,a},invert:function(a,b){var d=b[0],f=b[1],k=b[2],l=b[3],m=b[4];b=b[5];var q=d*l-f*k;return q?(q=1/q,a[0]=l*q,a[1]=-f*q,a[2]=-k*q,
a[3]=d*q,a[4]=(k*b-l*m)*q,a[5]=(f*m-d*b)*q,a):null},determinant:function(a){return a[0]*a[3]-a[1]*a[2]},multiply:function(a,b,d){var f=b[0],k=b[1],l=b[2],m=b[3],q=b[4];b=b[5];var n=d[0],p=d[1],x=d[2],w=d[3],r=d[4];d=d[5];return a[0]=f*n+l*p,a[1]=k*n+m*p,a[2]=f*x+l*w,a[3]=k*x+m*w,a[4]=f*r+l*d+q,a[5]=k*r+m*d+b,a}};z.mul=z.multiply;z.rotate=function(a,b,d){var f=b[0],k=b[1],l=b[2],m=b[3],q=b[4];b=b[5];var n=Math.sin(d);d=Math.cos(d);return a[0]=f*d+l*n,a[1]=k*d+m*n,a[2]=f*-n+l*d,a[3]=k*-n+m*d,a[4]=q,
a[5]=b,a};z.scale=function(a,b,d){var f=b[1],k=b[2],l=b[3],m=b[4],q=b[5],n=d[0];d=d[1];return a[0]=b[0]*n,a[1]=f*n,a[2]=k*d,a[3]=l*d,a[4]=m,a[5]=q,a};z.translate=function(a,b,d){var f=b[0],k=b[1],l=b[2],m=b[3],q=b[4];b=b[5];var n=d[0];d=d[1];return a[0]=f,a[1]=k,a[2]=l,a[3]=m,a[4]=f*n+l*d+q,a[5]=k*n+m*d+b,a};z.str=function(a){return"mat2d("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+")"};z.frob=function(a){return Math.sqrt(Math.pow(a[0],2)+Math.pow(a[1],2)+Math.pow(a[2],2)+Math.pow(a[3],
2)+Math.pow(a[4],2)+Math.pow(a[5],2)+1)};"undefined"!=typeof t&&(t.mat2d=z);var h={create:function(){var a=new da(9);return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=1,a[5]=0,a[6]=0,a[7]=0,a[8]=1,a},fromMat4:function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[4],a[4]=b[5],a[5]=b[6],a[6]=b[8],a[7]=b[9],a[8]=b[10],a},clone:function(a){var b=new da(9);return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8],b},copy:function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],
a[3]=b[3],a[4]=b[4],a[5]=b[5],a[6]=b[6],a[7]=b[7],a[8]=b[8],a},identity:function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=1,a[5]=0,a[6]=0,a[7]=0,a[8]=1,a},transpose:function(a,b){if(a===b){var d=b[1],f=b[2],k=b[5];a[1]=b[3];a[2]=b[6];a[3]=d;a[5]=b[7];a[6]=f;a[7]=k}else a[0]=b[0],a[1]=b[3],a[2]=b[6],a[3]=b[1],a[4]=b[4],a[5]=b[7],a[6]=b[2],a[7]=b[5],a[8]=b[8];return a},invert:function(a,b){var d=b[0],f=b[1],k=b[2],l=b[3],m=b[4],q=b[5],n=b[6],p=b[7];b=b[8];var x=b*m-q*p,w=-b*l+q*n,r=p*l-m*n,u=d*x+
f*w+k*r;return u?(u=1/u,a[0]=x*u,a[1]=(-b*f+k*p)*u,a[2]=(q*f-k*m)*u,a[3]=w*u,a[4]=(b*d-k*n)*u,a[5]=(-q*d+k*l)*u,a[6]=r*u,a[7]=(-p*d+f*n)*u,a[8]=(m*d-f*l)*u,a):null},adjoint:function(a,b){var d=b[0],f=b[1],k=b[2],l=b[3],m=b[4],q=b[5],n=b[6],p=b[7];b=b[8];return a[0]=m*b-q*p,a[1]=k*p-f*b,a[2]=f*q-k*m,a[3]=q*n-l*b,a[4]=d*b-k*n,a[5]=k*l-d*q,a[6]=l*p-m*n,a[7]=f*n-d*p,a[8]=d*m-f*l,a},determinant:function(a){var b=a[3],d=a[4],f=a[5],k=a[6],l=a[7],m=a[8];return a[0]*(m*d-f*l)+a[1]*(-m*b+f*k)+a[2]*(l*b-d*
k)},multiply:function(a,b,d){var f=b[0],k=b[1],l=b[2],m=b[3],q=b[4],n=b[5],p=b[6],x=b[7];b=b[8];var w=d[0],r=d[1],u=d[2],y=d[3],A=d[4],G=d[5],O=d[6],S=d[7];d=d[8];return a[0]=w*f+r*m+u*p,a[1]=w*k+r*q+u*x,a[2]=w*l+r*n+u*b,a[3]=y*f+A*m+G*p,a[4]=y*k+A*q+G*x,a[5]=y*l+A*n+G*b,a[6]=O*f+S*m+d*p,a[7]=O*k+S*q+d*x,a[8]=O*l+S*n+d*b,a}};h.mul=h.multiply;h.translate=function(a,b,d){var f=b[0],k=b[1],l=b[2],m=b[3],q=b[4],n=b[5],p=b[6],x=b[7];b=b[8];var w=d[0];d=d[1];return a[0]=f,a[1]=k,a[2]=l,a[3]=m,a[4]=q,a[5]=
n,a[6]=w*f+d*m+p,a[7]=w*k+d*q+x,a[8]=w*l+d*n+b,a};h.rotate=function(a,b,d){var f=b[0],k=b[1],l=b[2],m=b[3],q=b[4],n=b[5],p=b[6],x=b[7];b=b[8];var w=Math.sin(d);d=Math.cos(d);return a[0]=d*f+w*m,a[1]=d*k+w*q,a[2]=d*l+w*n,a[3]=d*m-w*f,a[4]=d*q-w*k,a[5]=d*n-w*l,a[6]=p,a[7]=x,a[8]=b,a};h.scale=function(a,b,d){var f=d[0];d=d[1];return a[0]=f*b[0],a[1]=f*b[1],a[2]=f*b[2],a[3]=d*b[3],a[4]=d*b[4],a[5]=d*b[5],a[6]=b[6],a[7]=b[7],a[8]=b[8],a};h.fromMat2d=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=0,a[3]=
b[2],a[4]=b[3],a[5]=0,a[6]=b[4],a[7]=b[5],a[8]=1,a};h.fromQuat=function(a,b){var d=b[0],f=b[1],k=b[2];b=b[3];var l=d+d,m=f+f,q=k+k;d*=l;var n=f*l;f*=m;var p=k*l,x=k*m;k*=q;l*=b;m*=b;b*=q;return a[0]=1-f-k,a[3]=n-b,a[6]=p+m,a[1]=n+b,a[4]=1-d-k,a[7]=x-l,a[2]=p-m,a[5]=x+l,a[8]=1-d-f,a};h.normalFromMat4=function(a,b){var d=b[0],f=b[1],k=b[2],l=b[3],m=b[4],q=b[5],n=b[6],p=b[7],x=b[8],w=b[9],r=b[10],u=b[11],y=b[12],A=b[13],G=b[14];b=b[15];var O=d*q-f*m,S=d*n-k*m,B=d*p-l*m,I=f*n-k*q,J=f*p-l*q,M=k*p-l*n,
L=x*A-w*y,P=x*G-r*y;x=x*b-u*y;var Y=w*G-r*A;w=w*b-u*A;r=r*b-u*G;return(u=O*r-S*w+B*Y+I*x-J*P+M*L)?(u=1/u,a[0]=(q*r-n*w+p*Y)*u,a[1]=(n*x-m*r-p*P)*u,a[2]=(m*w-q*x+p*L)*u,a[3]=(k*w-f*r-l*Y)*u,a[4]=(d*r-k*x+l*P)*u,a[5]=(f*x-d*w-l*L)*u,a[6]=(A*M-G*J+b*I)*u,a[7]=(G*B-y*M-b*S)*u,a[8]=(y*J-A*B+b*O)*u,a):null};h.str=function(a){return"mat3("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+")"};h.frob=function(a){return Math.sqrt(Math.pow(a[0],2)+Math.pow(a[1],2)+Math.pow(a[2],
2)+Math.pow(a[3],2)+Math.pow(a[4],2)+Math.pow(a[5],2)+Math.pow(a[6],2)+Math.pow(a[7],2)+Math.pow(a[8],2))};"undefined"!=typeof t&&(t.mat3=h);var c={create:function(){var a=new da(16);return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},clone:function(a){var b=new da(16);return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8],b[9]=a[9],b[10]=a[10],b[11]=a[11],b[12]=a[12],b[13]=a[13],
b[14]=a[14],b[15]=a[15],b},copy:function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a[4]=b[4],a[5]=b[5],a[6]=b[6],a[7]=b[7],a[8]=b[8],a[9]=b[9],a[10]=b[10],a[11]=b[11],a[12]=b[12],a[13]=b[13],a[14]=b[14],a[15]=b[15],a},identity:function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},transpose:function(a,b){if(a===b){var d=b[1],f=b[2],k=b[3],l=b[6],m=b[7],q=b[11];a[1]=b[4];a[2]=b[8];a[3]=b[12];a[4]=d;a[6]=
b[9];a[7]=b[13];a[8]=f;a[9]=l;a[11]=b[14];a[12]=k;a[13]=m;a[14]=q}else a[0]=b[0],a[1]=b[4],a[2]=b[8],a[3]=b[12],a[4]=b[1],a[5]=b[5],a[6]=b[9],a[7]=b[13],a[8]=b[2],a[9]=b[6],a[10]=b[10],a[11]=b[14],a[12]=b[3],a[13]=b[7],a[14]=b[11],a[15]=b[15];return a},invert:function(a,b){var d=b[0],f=b[1],k=b[2],l=b[3],m=b[4],q=b[5],n=b[6],p=b[7],x=b[8],w=b[9],r=b[10],u=b[11],y=b[12],A=b[13],G=b[14];b=b[15];var O=d*q-f*m,S=d*n-k*m,B=d*p-l*m,I=f*n-k*q,J=f*p-l*q,M=k*p-l*n,L=x*A-w*y,P=x*G-r*y,Y=x*b-u*y,W=w*G-r*A,aa=
w*b-u*A,ca=r*b-u*G,T=O*ca-S*aa+B*W+I*Y-J*P+M*L;return T?(T=1/T,a[0]=(q*ca-n*aa+p*W)*T,a[1]=(k*aa-f*ca-l*W)*T,a[2]=(A*M-G*J+b*I)*T,a[3]=(r*J-w*M-u*I)*T,a[4]=(n*Y-m*ca-p*P)*T,a[5]=(d*ca-k*Y+l*P)*T,a[6]=(G*B-y*M-b*S)*T,a[7]=(x*M-r*B+u*S)*T,a[8]=(m*aa-q*Y+p*L)*T,a[9]=(f*Y-d*aa-l*L)*T,a[10]=(y*J-A*B+b*O)*T,a[11]=(w*B-x*J-u*O)*T,a[12]=(q*P-m*W-n*L)*T,a[13]=(d*W-f*P+k*L)*T,a[14]=(A*S-y*I-G*O)*T,a[15]=(x*I-w*S+r*O)*T,a):null},adjoint:function(a,b){var d=b[0],f=b[1],k=b[2],l=b[3],m=b[4],q=b[5],n=b[6],p=b[7],
x=b[8],w=b[9],r=b[10],u=b[11],y=b[12],A=b[13],G=b[14];b=b[15];return a[0]=q*(r*b-u*G)-w*(n*b-p*G)+A*(n*u-p*r),a[1]=-(f*(r*b-u*G)-w*(k*b-l*G)+A*(k*u-l*r)),a[2]=f*(n*b-p*G)-q*(k*b-l*G)+A*(k*p-l*n),a[3]=-(f*(n*u-p*r)-q*(k*u-l*r)+w*(k*p-l*n)),a[4]=-(m*(r*b-u*G)-x*(n*b-p*G)+y*(n*u-p*r)),a[5]=d*(r*b-u*G)-x*(k*b-l*G)+y*(k*u-l*r),a[6]=-(d*(n*b-p*G)-m*(k*b-l*G)+y*(k*p-l*n)),a[7]=d*(n*u-p*r)-m*(k*u-l*r)+x*(k*p-l*n),a[8]=m*(w*b-u*A)-x*(q*b-p*A)+y*(q*u-p*w),a[9]=-(d*(w*b-u*A)-x*(f*b-l*A)+y*(f*u-l*w)),a[10]=d*
(q*b-p*A)-m*(f*b-l*A)+y*(f*p-l*q),a[11]=-(d*(q*u-p*w)-m*(f*u-l*w)+x*(f*p-l*q)),a[12]=-(m*(w*G-r*A)-x*(q*G-n*A)+y*(q*r-n*w)),a[13]=d*(w*G-r*A)-x*(f*G-k*A)+y*(f*r-k*w),a[14]=-(d*(q*G-n*A)-m*(f*G-k*A)+y*(f*n-k*q)),a[15]=d*(q*r-n*w)-m*(f*r-k*w)+x*(f*n-k*q),a},determinant:function(a){var b=a[0],d=a[1],f=a[2],k=a[3],l=a[4],m=a[5],q=a[6],n=a[7],p=a[8],x=a[9],w=a[10],r=a[11],u=a[12],y=a[13],A=a[14];a=a[15];return(b*m-d*l)*(w*a-r*A)-(b*q-f*l)*(x*a-r*y)+(b*n-k*l)*(x*A-w*y)+(d*q-f*m)*(p*a-r*u)-(d*n-k*m)*(p*
A-w*u)+(f*n-k*q)*(p*y-x*u)},multiply:function(a,b,d){var f=b[0],k=b[1],l=b[2],m=b[3],q=b[4],n=b[5],p=b[6],x=b[7],w=b[8],r=b[9],u=b[10],y=b[11],A=b[12],G=b[13],O=b[14];b=b[15];var S=d[0],B=d[1],I=d[2],J=d[3];return a[0]=S*f+B*q+I*w+J*A,a[1]=S*k+B*n+I*r+J*G,a[2]=S*l+B*p+I*u+J*O,a[3]=S*m+B*x+I*y+J*b,S=d[4],B=d[5],I=d[6],J=d[7],a[4]=S*f+B*q+I*w+J*A,a[5]=S*k+B*n+I*r+J*G,a[6]=S*l+B*p+I*u+J*O,a[7]=S*m+B*x+I*y+J*b,S=d[8],B=d[9],I=d[10],J=d[11],a[8]=S*f+B*q+I*w+J*A,a[9]=S*k+B*n+I*r+J*G,a[10]=S*l+B*p+I*u+J*
O,a[11]=S*m+B*x+I*y+J*b,S=d[12],B=d[13],I=d[14],J=d[15],a[12]=S*f+B*q+I*w+J*A,a[13]=S*k+B*n+I*r+J*G,a[14]=S*l+B*p+I*u+J*O,a[15]=S*m+B*x+I*y+J*b,a}};c.mul=c.multiply;c.translate=function(a,b,d){var f=d[0],k=d[1];d=d[2];var l,m,q,n,p,x,w,r,u,y,A,G;return b===a?(a[12]=b[0]*f+b[4]*k+b[8]*d+b[12],a[13]=b[1]*f+b[5]*k+b[9]*d+b[13],a[14]=b[2]*f+b[6]*k+b[10]*d+b[14],a[15]=b[3]*f+b[7]*k+b[11]*d+b[15]):(l=b[0],m=b[1],q=b[2],n=b[3],p=b[4],x=b[5],w=b[6],r=b[7],u=b[8],y=b[9],A=b[10],G=b[11],a[0]=l,a[1]=m,a[2]=
q,a[3]=n,a[4]=p,a[5]=x,a[6]=w,a[7]=r,a[8]=u,a[9]=y,a[10]=A,a[11]=G,a[12]=l*f+p*k+u*d+b[12],a[13]=m*f+x*k+y*d+b[13],a[14]=q*f+w*k+A*d+b[14],a[15]=n*f+r*k+G*d+b[15]),a};c.scale=function(a,b,d){var f=d[0],k=d[1];d=d[2];return a[0]=b[0]*f,a[1]=b[1]*f,a[2]=b[2]*f,a[3]=b[3]*f,a[4]=b[4]*k,a[5]=b[5]*k,a[6]=b[6]*k,a[7]=b[7]*k,a[8]=b[8]*d,a[9]=b[9]*d,a[10]=b[10]*d,a[11]=b[11]*d,a[12]=b[12],a[13]=b[13],a[14]=b[14],a[15]=b[15],a};c.rotate=function(a,b,d,f){var k=f[0],l=f[1];f=f[2];var m=Math.sqrt(k*k+l*l+f*f),
q,n,p,x,w,r,u,y,A,G,O,S,B,I,J,M,L,P,Y,W,aa,ca,T,V;return Math.abs(m)<la?null:(m=1/m,k*=m,l*=m,f*=m,q=Math.sin(d),n=Math.cos(d),p=1-n,x=b[0],w=b[1],r=b[2],u=b[3],y=b[4],A=b[5],G=b[6],O=b[7],S=b[8],B=b[9],I=b[10],J=b[11],M=k*k*p+n,L=l*k*p+f*q,P=f*k*p-l*q,Y=k*l*p-f*q,W=l*l*p+n,aa=f*l*p+k*q,ca=k*f*p+l*q,T=l*f*p-k*q,V=f*f*p+n,a[0]=x*M+y*L+S*P,a[1]=w*M+A*L+B*P,a[2]=r*M+G*L+I*P,a[3]=u*M+O*L+J*P,a[4]=x*Y+y*W+S*aa,a[5]=w*Y+A*W+B*aa,a[6]=r*Y+G*W+I*aa,a[7]=u*Y+O*W+J*aa,a[8]=x*ca+y*T+S*V,a[9]=w*ca+A*T+B*V,a[10]=
r*ca+G*T+I*V,a[11]=u*ca+O*T+J*V,b!==a&&(a[12]=b[12],a[13]=b[13],a[14]=b[14],a[15]=b[15]),a)};c.rotateX=function(a,b,d){var f=Math.sin(d);d=Math.cos(d);var k=b[4],l=b[5],m=b[6],q=b[7],n=b[8],p=b[9],x=b[10],w=b[11];return b!==a&&(a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a[12]=b[12],a[13]=b[13],a[14]=b[14],a[15]=b[15]),a[4]=k*d+n*f,a[5]=l*d+p*f,a[6]=m*d+x*f,a[7]=q*d+w*f,a[8]=n*d-k*f,a[9]=p*d-l*f,a[10]=x*d-m*f,a[11]=w*d-q*f,a};c.rotateY=function(a,b,d){var f=Math.sin(d);d=Math.cos(d);var k=b[0],l=b[1],
m=b[2],q=b[3],n=b[8],p=b[9],x=b[10],w=b[11];return b!==a&&(a[4]=b[4],a[5]=b[5],a[6]=b[6],a[7]=b[7],a[12]=b[12],a[13]=b[13],a[14]=b[14],a[15]=b[15]),a[0]=k*d-n*f,a[1]=l*d-p*f,a[2]=m*d-x*f,a[3]=q*d-w*f,a[8]=k*f+n*d,a[9]=l*f+p*d,a[10]=m*f+x*d,a[11]=q*f+w*d,a};c.rotateZ=function(a,b,d){var f=Math.sin(d);d=Math.cos(d);var k=b[0],l=b[1],m=b[2],q=b[3],n=b[4],p=b[5],x=b[6],w=b[7];return b!==a&&(a[8]=b[8],a[9]=b[9],a[10]=b[10],a[11]=b[11],a[12]=b[12],a[13]=b[13],a[14]=b[14],a[15]=b[15]),a[0]=k*d+n*f,a[1]=
l*d+p*f,a[2]=m*d+x*f,a[3]=q*d+w*f,a[4]=n*d-k*f,a[5]=p*d-l*f,a[6]=x*d-m*f,a[7]=w*d-q*f,a};c.fromRotationTranslation=function(a,b,d){var f=b[0],k=b[1],l=b[2],m=b[3],q=f+f,n=k+k,p=l+l;b=f*q;var x=f*n;f*=p;var w=k*n;k*=p;l*=p;q*=m;n*=m;m*=p;return a[0]=1-(w+l),a[1]=x+m,a[2]=f-n,a[3]=0,a[4]=x-m,a[5]=1-(b+l),a[6]=k+q,a[7]=0,a[8]=f+n,a[9]=k-q,a[10]=1-(b+w),a[11]=0,a[12]=d[0],a[13]=d[1],a[14]=d[2],a[15]=1,a};c.fromQuat=function(a,b){var d=b[0],f=b[1],k=b[2];b=b[3];var l=d+d,m=f+f,q=k+k;d*=l;var n=f*l;f*=
m;var p=k*l,x=k*m;k*=q;l*=b;m*=b;b*=q;return a[0]=1-f-k,a[1]=n+b,a[2]=p-m,a[3]=0,a[4]=n-b,a[5]=1-d-k,a[6]=x+l,a[7]=0,a[8]=p+m,a[9]=x-l,a[10]=1-d-f,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a};c.frustum=function(a,b,d,f,k,l,m){var q=1/(d-b),n=1/(k-f),p=1/(l-m);return a[0]=2*l*q,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2*l*n,a[6]=0,a[7]=0,a[8]=(d+b)*q,a[9]=(k+f)*n,a[10]=(m+l)*p,a[11]=-1,a[12]=0,a[13]=0,a[14]=m*l*2*p,a[15]=0,a};c.perspective=function(a,b,d,f,k){b=1/Math.tan(b/2);var l=1/(f-k);return a[0]=b/d,
a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=b,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=(k+f)*l,a[11]=-1,a[12]=0,a[13]=0,a[14]=2*k*f*l,a[15]=0,a};c.ortho=function(a,b,d,f,k,l,m){var q=1/(b-d),n=1/(f-k),p=1/(l-m);return a[0]=-2*q,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=-2*n,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=2*p,a[11]=0,a[12]=(b+d)*q,a[13]=(k+f)*n,a[14]=(m+l)*p,a[15]=1,a};c.lookAt=function(a,b,d,f){var k,l,m,q,n,p,x,w,r,u,y=b[0],A=b[1];b=b[2];var G=f[0],O=f[1];f=f[2];var S=d[0],B=d[1];d=d[2];return Math.abs(y-S)<la&&Math.abs(A-
B)<la&&Math.abs(b-d)<la?c.identity(a):(x=y-S,w=A-B,r=b-d,u=1/Math.sqrt(x*x+w*w+r*r),x*=u,w*=u,r*=u,k=O*r-f*w,l=f*x-G*r,m=G*w-O*x,u=Math.sqrt(k*k+l*l+m*m),u?(u=1/u,k*=u,l*=u,m*=u):(k=0,l=0,m=0),q=w*m-r*l,n=r*k-x*m,p=x*l-w*k,u=Math.sqrt(q*q+n*n+p*p),u?(u=1/u,q*=u,n*=u,p*=u):(q=0,n=0,p=0),a[0]=k,a[1]=q,a[2]=x,a[3]=0,a[4]=l,a[5]=n,a[6]=w,a[7]=0,a[8]=m,a[9]=p,a[10]=r,a[11]=0,a[12]=-(k*y+l*A+m*b),a[13]=-(q*y+n*A+p*b),a[14]=-(x*y+w*A+r*b),a[15]=1,a)};c.str=function(a){return"mat4("+a[0]+", "+a[1]+", "+a[2]+
", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+", "+a[9]+", "+a[10]+", "+a[11]+", "+a[12]+", "+a[13]+", "+a[14]+", "+a[15]+")"};c.frob=function(a){return Math.sqrt(Math.pow(a[0],2)+Math.pow(a[1],2)+Math.pow(a[2],2)+Math.pow(a[3],2)+Math.pow(a[4],2)+Math.pow(a[5],2)+Math.pow(a[6],2)+Math.pow(a[6],2)+Math.pow(a[7],2)+Math.pow(a[8],2)+Math.pow(a[9],2)+Math.pow(a[10],2)+Math.pow(a[11],2)+Math.pow(a[12],2)+Math.pow(a[13],2)+Math.pow(a[14],2)+Math.pow(a[15],2))};"undefined"!=typeof t&&(t.mat4=
c);var e={create:function(){var a=new da(4);return a[0]=0,a[1]=0,a[2]=0,a[3]=1,a}};e.rotationTo=function(){var a=F.create(),b=F.fromValues(1,0,0),d=F.fromValues(0,1,0);return function(f,k,l){var m=F.dot(k,l);return-.999999>m?(F.cross(a,b,k),1E-6>F.length(a)&&F.cross(a,d,k),F.normalize(a,a),e.setAxisAngle(f,a,Math.PI),f):.999999<m?(f[0]=0,f[1]=0,f[2]=0,f[3]=1,f):(F.cross(a,k,l),f[0]=a[0],f[1]=a[1],f[2]=a[2],f[3]=1+m,e.normalize(f,f))}}();e.setAxes=function(){var a=h.create();return function(b,d,f,
k){return a[0]=f[0],a[3]=f[1],a[6]=f[2],a[1]=k[0],a[4]=k[1],a[7]=k[2],a[2]=-d[0],a[5]=-d[1],a[8]=-d[2],e.normalize(b,e.fromMat3(b,a))}}();e.clone=g.clone;e.fromValues=g.fromValues;e.copy=g.copy;e.set=g.set;e.identity=function(a){return a[0]=0,a[1]=0,a[2]=0,a[3]=1,a};e.setAxisAngle=function(a,b,d){d*=.5;var f=Math.sin(d);return a[0]=f*b[0],a[1]=f*b[1],a[2]=f*b[2],a[3]=Math.cos(d),a};e.add=g.add;e.multiply=function(a,b,d){var f=b[0],k=b[1],l=b[2];b=b[3];var m=d[0],q=d[1],n=d[2];d=d[3];return a[0]=f*
d+b*m+k*n-l*q,a[1]=k*d+b*q+l*m-f*n,a[2]=l*d+b*n+f*q-k*m,a[3]=b*d-f*m-k*q-l*n,a};e.mul=e.multiply;e.scale=g.scale;e.rotateX=function(a,b,d){d*=.5;var f=b[0],k=b[1],l=b[2];b=b[3];var m=Math.sin(d);d=Math.cos(d);return a[0]=f*d+b*m,a[1]=k*d+l*m,a[2]=l*d-k*m,a[3]=b*d-f*m,a};e.rotateY=function(a,b,d){d*=.5;var f=b[0],k=b[1],l=b[2];b=b[3];var m=Math.sin(d);d=Math.cos(d);return a[0]=f*d-l*m,a[1]=k*d+b*m,a[2]=l*d+f*m,a[3]=b*d-k*m,a};e.rotateZ=function(a,b,d){d*=.5;var f=b[0],k=b[1],l=b[2];b=b[3];var m=Math.sin(d);
d=Math.cos(d);return a[0]=f*d+k*m,a[1]=k*d-f*m,a[2]=l*d+b*m,a[3]=b*d-l*m,a};e.calculateW=function(a,b){var d=b[0],f=b[1];b=b[2];return a[0]=d,a[1]=f,a[2]=b,a[3]=-Math.sqrt(Math.abs(1-d*d-f*f-b*b)),a};e.dot=g.dot;e.lerp=g.lerp;e.slerp=function(a,b,d,f){var k=b[0],l=b[1],m=b[2];b=b[3];var q=d[0],n=d[1],p=d[2];d=d[3];var x,w,r,u,y;return w=k*q+l*n+m*p+b*d,0>w&&(w=-w,q=-q,n=-n,p=-p,d=-d),1E-6<1-w?(x=Math.acos(w),r=Math.sin(x),u=Math.sin((1-f)*x)/r,y=Math.sin(f*x)/r):(u=1-f,y=f),a[0]=u*k+y*q,a[1]=u*l+
y*n,a[2]=u*m+y*p,a[3]=u*b+y*d,a};e.invert=function(a,b){var d=b[0],f=b[1],k=b[2];b=b[3];var l=d*d+f*f+k*k+b*b;l=l?1/l:0;return a[0]=-d*l,a[1]=-f*l,a[2]=-k*l,a[3]=b*l,a};e.conjugate=function(a,b){return a[0]=-b[0],a[1]=-b[1],a[2]=-b[2],a[3]=b[3],a};e.length=g.length;e.len=e.length;e.squaredLength=g.squaredLength;e.sqrLen=e.squaredLength;e.normalize=g.normalize;e.fromMat3=function(a,b){var d=b[0]+b[4]+b[8];if(0<d)d=Math.sqrt(d+1),a[3]=.5*d,d=.5/d,a[0]=(b[7]-b[5])*d,a[1]=(b[2]-b[6])*d,a[2]=(b[3]-b[1])*
d;else{var f=0;b[4]>b[0]&&(f=1);b[8]>b[3*f+f]&&(f=2);var k=(f+1)%3,l=(f+2)%3;d=Math.sqrt(b[3*f+f]-b[3*k+k]-b[3*l+l]+1);a[f]=.5*d;d=.5/d;a[3]=(b[3*l+k]-b[3*k+l])*d;a[k]=(b[3*k+f]+b[3*f+k])*d;a[l]=(b[3*l+f]+b[3*f+l])*d}return a};e.str=function(a){return"quat("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"};"undefined"!=typeof t&&(t.quat=e)})(fa)})(this);"use strict";
(function(K){function fa(g,h,c,e){this.gl=e=e||K.gl;this._context_id=e.context_id;if(g&&g.constructor!==Array)throw"FBO textures must be an Array";this.handler=null;this.height=this.width=-1;this.color_textures=[];this.depth_texture=null;this.stencil=!!c;this._stencil_enabled=!1;this._num_binded_textures=0;(g&&g.length||h)&&this.setTextures(g,h);this._old_fbo=null;this._old_viewport=new Float32Array(4)}var t=K.GL={};K.requestAnimationFrame=K.requestAnimationFrame||K.mozRequestAnimationFrame||K.webkitRequestAnimationFrame||
function(g){setTimeout(g,1E3/60)};t.blockable_keys={Up:!0,Down:!0,Left:!0,Right:!0};t.LEFT_MOUSE_BUTTON=1;t.MIDDLE_MOUSE_BUTTON=2;t.RIGHT_MOUSE_BUTTON=3;t.last_context_id=0;t.TEXTURE_2D=3553;t.TEXTURE_CUBE_MAP=34067;t.BYTE=5120;t.UNSIGNED_BYTE=5121;t.SHORT=5122;t.UNSIGNED_SHORT=5123;t.INT=5124;t.UNSIGNED_INT=5125;t.FLOAT=5126;t.HALF_FLOAT_OES=36193;t.DEPTH_COMPONENT16=33189;t.FLOAT_VEC2=35664;t.FLOAT_VEC3=35665;t.FLOAT_VEC4=35666;t.INT_VEC2=35667;t.INT_VEC3=35668;t.INT_VEC4=35669;t.BOOL=35670;t.BOOL_VEC2=
35671;t.BOOL_VEC3=35672;t.BOOL_VEC4=35673;t.FLOAT_MAT2=35674;t.FLOAT_MAT3=35675;t.FLOAT_MAT4=35676;t.DEPTH_COMPONENT=6402;t.ALPHA=6406;t.RGB=6407;t.RGBA=6408;t.LUMINANCE=6409;t.LUMINANCE_ALPHA=6410;t.NEAREST=9728;t.LINEAR=9729;t.NEAREST_MIPMAP_NEAREST=9984;t.LINEAR_MIPMAP_NEAREST=9985;t.NEAREST_MIPMAP_LINEAR=9986;t.LINEAR_MIPMAP_LINEAR=9987;t.REPEAT=10497;t.CLAMP_TO_EDGE=33071;t.MIRRORED_REPEAT=33648;t.ZERO=0;t.ONE=1;t.SRC_COLOR=768;t.ONE_MINUS_SRC_COLOR=769;t.SRC_ALPHA=770;t.ONE_MINUS_SRC_ALPHA=
771;t.DST_ALPHA=772;t.ONE_MINUS_DST_ALPHA=773;t.DST_COLOR=774;t.ONE_MINUS_DST_COLOR=775;t.SRC_ALPHA_SATURATE=776;t.CONSTANT_COLOR=32769;t.ONE_MINUS_CONSTANT_COLOR=32770;t.CONSTANT_ALPHA=32771;t.ONE_MINUS_CONSTANT_ALPHA=32772;t.VERTEX_SHADER=35633;t.FRAGMENT_SHADER=35632;t.CW=2304;t.CCW=2305;t.FRONT=1028;t.BACK=1029;t.FRONT_AND_BACK=1032;t.NEVER=512;t.LESS=513;t.EQUAL=514;t.LEQUAL=515;t.GREATER=516;t.NOTEQUAL=517;t.GEQUAL=518;t.ALWAYS=519;t.temp_vec3=vec3.create();t.temp2_vec3=vec3.create();t.temp_vec4=
vec4.create();t.temp_quat=quat.create();t.temp_mat3=mat3.create();t.temp_mat4=mat4.create();K.DEG2RAD=.0174532925;K.RAD2DEG=57.295779578552306;K.EPSILON=1E-6;K.isPowerOfTwo=t.isPowerOfTwo=function(g){return 0==Math.log(g)/Math.log(2)%1};K.getTime="undefined"!=typeof performance?performance.now.bind(performance):Date.now.bind(Date);t.getTime=K.getTime;K.isFunction=function(g){return!!(g&&g.constructor&&g.call&&g.apply)};K.isArray=function(g){return g&&g.constructor===Array};K.isNumber=function(g){return null!=
g&&g.constructor===Number};K.cloneObject=t.cloneObject=function(g,h){if(g.constructor!==Object)throw"cloneObject only can clone pure javascript objects, not classes";h=h||{};for(var c in g){var e=g[c];if(null===e)h[c]=null;else switch(e.constructor){case Int8Array:case Uint8Array:case Int16Array:case Uint16Array:case Int32Array:case Uint32Array:case Float32Array:case Float64Array:h[c]=new e.constructor(e);break;case Boolean:case Number:case String:h[c]=e;break;case Array:h[c]=e.concat();break;case Object:h[c]=
t.cloneObject(e)}}return h};K.regexMap=function(g,h,c){for(var e;null!=(e=g.exec(h));)c(e)};K.createCanvas=t.createCanvas=function(g,h){var c=document.createElement("canvas");c.width=g;c.height=h;return c};K.cloneCanvas=t.cloneCanvas=function(g){var h=document.createElement("canvas");h.width=g.width;h.height=g.height;h.getContext("2d").drawImage(g,0,0);return h};"undefined"!=typeof Image&&(Image.prototype.getPixels=function(){var g=document.createElement("canvas");g.width=this.width;g.height=this.height;
g=g.getContext("2d");g.drawImage(this,0,0);return g.getImageData(0,0,this.width,this.height).data});String.prototype.hasOwnProperty("replaceAll")||Object.defineProperty(String.prototype,"replaceAll",{value:function(g){var h=this,c;for(c in g)h=h.split(c).join(g[c]);return h},enumerable:!1});String.prototype.hasOwnProperty("hashCode")||Object.defineProperty(String.prototype,"hashCode",{value:function(){var g=0,h;if(0==this.length)return g;var c=0;for(h=this.length;c<h;++c){var e=this.charCodeAt(c);
g=(g<<5)-g+e;g|=0}return g},enumerable:!1});Array.prototype.hasOwnProperty("subarray")||Object.defineProperty(Array.prototype,"subarray",{value:Array.prototype.slice,enumerable:!1});K.wipeObject=function(g){for(var h in g)g.hasOwnProperty(h)&&delete g[h]};K.extendClass=t.extendClass=function(g,h){for(var c in h)g.hasOwnProperty(c)||(g[c]=h[c]);if(h.prototype){var e=Object.getOwnPropertyNames(h.prototype);for(c=0;c<e.length;++c){var a=e[c];g.prototype.hasOwnProperty(a)||(h.prototype.__lookupGetter__(a)?
g.prototype.__defineGetter__(a,h.prototype.__lookupGetter__(a)):g.prototype[a]=h.prototype[a],h.prototype.__lookupSetter__(a)&&g.prototype.__defineSetter__(a,h.prototype.__lookupSetter__(a)))}}g.hasOwnProperty("superclass")||Object.defineProperty(g,"superclass",{get:function(){return h},enumerable:!1})};K.HttpRequest=t.request=function(g,h,c,e,a){var b=!0;a&&void 0!==a.async&&(b=a.async);if(h){var d=null;d=[];for(var f in h)d.push(f+"="+h[f]);d=d.join("&");g=g+"?"+d}var k=new XMLHttpRequest;k.open("GET",
g,b);k.onload=function(l){this.getResponseHeader("Content-Type");200!=this.status?(E.trigger(k,"fail",this.status),e&&e(this.status)):(E.trigger(k,"done",this.response),c&&c(this.response))};k.onerror=function(l){E.trigger(k,"fail",l)};if(a){for(f in a)k[f]=a[f];a.binary&&(k.responseType="arraybuffer")}k.send();return k};XMLHttpRequest.prototype.hasOwnProperty("done")||Object.defineProperty(XMLHttpRequest.prototype,"done",{enumerable:!1,value:function(g){E.bind(this,"done",function(h,c){g(c)});return this}});
XMLHttpRequest.prototype.hasOwnProperty("fail")||Object.defineProperty(XMLHttpRequest.prototype,"fail",{enumerable:!1,value:function(g){E.bind(this,"fail",function(h,c){g(c)});return this}});K.getFileExtension=function(g){var h=g.indexOf("?");-1!=h&&(g=g.substr(0,h));h=g.lastIndexOf(".");return-1==h?"":g.substr(h+1).toLowerCase()};K.loadFileAtlas=t.loadFileAtlas=function(g,h,c){var e=null;HttpRequest(g,null,function(a){a=t.processFileAtlas(a);h&&h(a);e&&e(a)},alert,c);return{done:function(a){e=a}}};
K.processFileAtlas=t.processFileAtlas=function(g,h){g=g.split("\n");for(var c={},e=[],a="",b=0,d=g.length;b<d;b++){var f=h?g[b]:g[b].trim();f.length&&("\\"!=f[0]?e.push(f):(e.length&&(c[a]=e.join("\n")),e.length=0,a=f.substr(1)))}e.length&&(c[a]=e.join("\n"));return c};K.hexColorToRGBA=function(){function g(e,a,b){0>b&&(b+=1);1<b&&--b;return b<1/6?e+6*(a-e)*b:.5>b?a:b<2/3?e+(a-e)*(2/3-b)*6:e}function h(e,a,b,d){d=d||vec3.create();if(0==a)b=a=e=b;else{var f=.5>b?b*(1+a):b+a-b*a,k=2*b-f;b=g(k,f,e+1/
3);a=g(k,f,e);e=g(k,f,e-1/3)}d[0]=b;d[1]=a;d[2]=e;return d}var c={white:[1,1,1],black:[0,0,0],gray:[.501960813999176,.501960813999176,.501960813999176],red:[1,0,0],orange:[1,.6470588445663452,0],pink:[1,.7529411911964417,.7960784435272217],green:[0,.501960813999176,0],lime:[0,1,0],blue:[0,0,1],violet:[.9333333373069763,.5098039507865906,.9333333373069763],magenta:[1,0,1],cyan:[0,1,1],yellow:[1,1,0],brown:[.6470588445663452,.16470588743686676,.16470588743686676],silver:[.7529411911964417,.7529411911964417,
.7529411911964417],gold:[1,.843137264251709,0],transparent:[0,0,0,0]};return function(e,a,b){b=void 0===b?1:b;a=a||new Float32Array(4);a[3]=b;if("string"!=typeof e)return a;var d=c[e];if(void 0!==d)return a.set(d),a[3]=3==a.length?b:a[3]*b,a;d=e.indexOf("rgba(");if(-1!=d)return e=e.substr(5),e=e.split(","),a[0]=parseInt(e[0])/255,a[1]=parseInt(e[1])/255,a[2]=parseInt(e[2])/255,a[3]=parseFloat(e[3])*b,a;d=e.indexOf("hsla(");if(-1!=d)return e=e.substr(5),e=e.split(","),h(parseInt(e[0])/360,parseInt(e[1])/
100,parseInt(e[2])/100,a),a[3]=parseFloat(e[3])*b,a;a[3]=b;d=e.indexOf("rgb(");if(-1!=d)return e=e.substr(3),e=e.split(","),a[0]=parseInt(e[0])/255,a[1]=parseInt(e[1])/255,a[2]=parseInt(e[2])/255,a;d=e.indexOf("hsl(");if(-1!=d)return e=e.substr(5),e=e.split(","),h(parseInt(e[0])/360,parseInt(e[1])/100,parseInt(e[2])/100,a),a;e=e.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(f,k,l,m){return k+k+l+l+m+m});b=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);if(!b)return a;a[0]=parseInt(b[1],
16)/255;a[1]=parseInt(b[2],16)/255;a[2]=parseInt(b[3],16)/255;return a}}();var la=function(){function g(B){return B.charCodeAt(0)+(B.charCodeAt(1)<<8)+(B.charCodeAt(2)<<16)+(B.charCodeAt(3)<<24)}function h(B,I,J,M){var L=new Uint16Array(4),P=new Uint16Array(J*M),Y=J/4;M/=4;for(var W=0;W<M;W++)for(var aa=0;aa<Y;aa++){var ca=I+4*(W*Y+aa);L[0]=B[ca];L[1]=B[ca+1];var T=L[0]&31;var V=L[0]&2016;var ea=L[0]&63488;var ja=L[1]&31;var v=L[1]&2016;var D=L[1]&63488;L[2]=5*T+3*ja>>3|5*V+3*v>>3&2016|5*ea+3*D>>
3&63488;L[3]=5*ja+3*T>>3|5*v+3*V>>3&2016|5*D+3*ea>>3&63488;T=B[ca+2];V=4*W*J+4*aa;P[V]=L[T&3];P[V+1]=L[T>>2&3];P[V+2]=L[T>>4&3];P[V+3]=L[T>>6&3];V+=J;P[V]=L[T>>8&3];P[V+1]=L[T>>10&3];P[V+2]=L[T>>12&3];P[V+3]=L[T>>14];T=B[ca+3];V+=J;P[V]=L[T&3];P[V+1]=L[T>>2&3];P[V+2]=L[T>>4&3];P[V+3]=L[T>>6&3];V+=J;P[V]=L[T>>8&3];P[V+1]=L[T>>10&3];P[V+2]=L[T>>12&3];P[V+3]=L[T>>14]}return P}function c(B){for(var I=0,J=B.length,M;I<J;I+=4)M=B[I],B[I]=B[I+2],B[I+2]=M}function e(B,I,J,M){var L=new Int32Array(J,0,p),P,
Y;if(L[x]!=d)return console.error("Invalid magic number in DDS header"),0;if(!L[G]&l)return console.error("Unsupported format, must contain a FourCC code"),0;var W=L[O];switch(W){case m:var aa=8;var ca=I?I.COMPRESSED_RGB_S3TC_DXT1_EXT:null;break;case q:aa=16;ca=I?I.COMPRESSED_RGBA_S3TC_DXT3_EXT:null;break;case n:aa=16;ca=I?I.COMPRESSED_RGBA_S3TC_DXT5_EXT:null;break;default:aa=4,W=null,ca=B.RGBA}var T=1;L[r]&f&&!1!==M&&(T=Math.max(1,L[A]));var V=L[y];var ea=L[u];var ja=L[w]+4;if(L[S+1]&k)for(Y=0;6>
Y;++Y)for(V=L[y],ea=L[u],P=0;P<T;++P)W?(M=Math.max(4,V)/4*Math.max(4,ea)/4*aa,I=new Uint8Array(J,ja,M),B.compressedTexImage2D(B.TEXTURE_CUBE_MAP_POSITIVE_X+Y,P,ca,V,ea,0,I)):(B.pixelStorei(B.UNPACK_FLIP_Y_WEBGL,!1),M=V*ea*aa,I=new Uint8Array(J,ja,M),c(I),B.texImage2D(B.TEXTURE_CUBE_MAP_POSITIVE_X+Y,P,ca,V,ea,0,B.RGBA,B.UNSIGNED_BYTE,I)),ja+=M,V*=.5,ea*=.5;else if(I)for(B.pixelStorei(B.UNPACK_FLIP_Y_WEBGL,!0),P=0;P<T;++P)W?(M=Math.max(4,V)/4*Math.max(4,ea)/4*aa,I=new Uint8Array(J,ja,M),B.compressedTexImage2D(B.TEXTURE_2D,
P,ca,V,ea,0,I)):(M=V*ea*aa,I=new Uint8Array(J,ja,M),c(I),B.texImage2D(B.TEXTURE_2D,P,ca,V,ea,0,ca,B.UNSIGNED_BYTE,I)),ja+=M,V*=.5,ea*=.5;else if(W==m)Math.max(4,V),Math.max(4,ea),I=new Uint16Array(J),J=h(I,ja/2,V,ea),B.texImage2D(B.TEXTURE_2D,0,B.RGB,V,ea,0,B.RGB,B.UNSIGNED_SHORT_5_6_5,J),M&&B.generateMipmap(B.TEXTURE_2D);else return console.error("No manual decoder for",String.fromCharCode(W&255,W>>8&255,W>>16&255,W>>24&255),"and no native support"),0;return T}function a(B,I){var J=new Int32Array(B,
0,p),M,L,P;if(J[x]!=d)return console.error("Invalid magic number in DDS header"),0;if(!J[G]&l)return console.error("Unsupported format, must contain a FourCC code"),0;var Y=J[O];switch(Y){case m:var W=8;var aa="COMPRESSED_RGB_S3TC_DXT1_EXT";break;case q:W=16;aa="COMPRESSED_RGBA_S3TC_DXT3_EXT";break;case n:W=16;aa="COMPRESSED_RGBA_S3TC_DXT5_EXT";break;default:W=4,aa="RGBA"}var ca=1;J[r]&f&&!1!==loadMipmaps&&(ca=Math.max(1,J[A]));var T=J[y];var V=J[u];var ea=J[w]+4;var ja=[];if(J[S+1]&k)for(P=0;6>P;++P)for(T=
J[y],V=J[u],I=0;I<ca;++I)Y?(M=Math.max(4,T)/4*Math.max(4,V)/4*W,new Uint8Array(B,ea,M),ja.push({tex:"TEXTURE_CUBE_MAP",face:P,mipmap:I,internalFormat:aa,width:T,height:V,offset:0,dataOffset:ea,dataLength:M})):(M=T*V*W,L=new Uint8Array(B,ea,M),c(L),ja.push({tex:"TEXTURE_CUBE_MAP",face:P,mipmap:I,internalFormat:aa,width:T,height:V,offset:0,type:"UNSIGNED_BYTE",dataOffset:ea,dataLength:M})),ea+=M,T*=.5,V*=.5;else if(I)if(Y==m)Math.max(4,T),Math.max(4,V),L=new Uint16Array(B),J=h(L,ea/2,T,V),ja.push({tex:"TEXTURE_2D",
mipmap:0,internalFormat:"RGB",width:T,height:V,offset:0,format:"RGB",type:"UNSIGNED_SHORT_5_6_5",data:J});else return console.error("No manual decoder for",String.fromCharCode(Y&255,Y>>8&255,Y>>16&255,Y>>24&255),"and no native support"),0;else for(I=0;I<ca;++I)M=Math.max(4,T)/4*Math.max(4,V)/4*W,new Uint8Array(B,ea,M),ja.push({tex:"TEXTURE_2D",mipmap:I,internalFormat:aa,width:T,height:V,offset:0,type:"UNSIGNED_BYTE",dataOffset:ea,dataLength:M}),ea+=M,T*=.5,V*=.5;return ja}function b(B,I,J,M,L,P){var Y=
new XMLHttpRequest;Y.open("GET",J,!0);Y.responseType="arraybuffer";Y.onload=function(){if(200==this.status){var W=new Int32Array(this.response,0,p),aa=W[S+1]&k?B.TEXTURE_CUBE_MAP:B.TEXTURE_2D;B.bindTexture(aa,M);var ca=e(B,I,this.response,L);B.texParameteri(aa,B.TEXTURE_MAG_FILTER,B.LINEAR);B.texParameteri(aa,B.TEXTURE_MIN_FILTER,1<ca?B.LINEAR_MIPMAP_LINEAR:B.LINEAR);B.bindTexture(aa,null);M.texture_type=aa;M.width=W[y];M.height=W[u]}P&&P(M)};Y.send(null);return M}var d=542327876,f=131072,k=512,l=
4,m=g("DXT1"),q=g("DXT3"),n=g("DXT5"),p=31,x=0,w=1,r=2,u=3,y=4,A=7,G=20,O=21,S=27;return{dxtToRgb565:h,uploadDDSLevels:e,loadDDSTextureEx:b,loadDDSTexture:function(B,I,J,M){var L=B.createTexture();I=B.getExtension("WEBGL_compressed_texture_s3tc");b(B,I,J,L,!0,M);return L},loadDDSTextureFromMemoryEx:function(B,I,J,M,L){var P=new Int32Array(J,0,p),Y=!!(P[S+1]&k),W=Y?B.TEXTURE_CUBE_MAP:B.TEXTURE_2D;B.bindTexture(W,M.handler);I=e(B,I,J,L);B.texParameteri(W,B.TEXTURE_MAG_FILTER,B.LINEAR);B.texParameteri(W,
B.TEXTURE_MIN_FILTER,1<I?B.LINEAR_MIPMAP_LINEAR:B.LINEAR);Y&&(B.texParameteri(W,B.TEXTURE_WRAP_S,B.CLAMP_TO_EDGE),B.texParameteri(W,B.TEXTURE_WRAP_T,B.CLAMP_TO_EDGE));B.bindTexture(W,null);M.handler&&(M.texture_type=W,M.width=P[y],M.height=P[u]);return M},getDDSTextureFromMemoryEx:function(B){var I=new Int32Array(B,0,p),J=I[S+1]&k?"TEXTURE_CUBE_MAP":"TEXTURE_2D",M=a(B);return{type:J,buffers:M,data:B,width:I[y],height:I[u]}}}}();"undefined"!=typeof K&&(K.DDS=la);if("undefined"==typeof glMatrix)throw"You must include glMatrix on your project";
Math.clamp=function(g,h,c){return h>g?h:c<g?c:g};vec3.ZERO=vec3.fromValues(0,0,0);vec3.FRONT=vec3.fromValues(0,0,-1);vec3.UP=vec3.fromValues(0,1,0);vec3.RIGHT=vec3.fromValues(1,0,0);vec2.rotate=function(g,h,c){var e=h[0];h=h[1];var a=Math.cos(c);c=Math.sin(c);g[0]=e*a-h*c;g[1]=e*c+h*a;return g};vec3.zero=function(g){g[0]=g[1]=0;return g};vec2.perpdot=function(g,h){return g[1]*h[0]+-g[0]*h[1]};vec2.computeSignedAngle=function(g,h){return Math.atan2(vec2.perpdot(g,h),vec2.dot(g,h))};vec2.random=function(g){g[0]=
Math.random();g[1]=Math.random();return g};vec3.zero=function(g){g[0]=g[1]=g[2]=0;return g};vec3.minValue=function(g){return g[0]<g[1]&&g[0]<g[2]?g[0]:g[1]<g[2]?g[1]:g[2]};vec3.maxValue=function(g){return g[0]>g[1]&&g[0]>g[2]?g[0]:g[1]>g[2]?g[1]:g[2]};vec3.minValue=function(g){return g[0]<g[1]&&g[0]<g[2]?g[0]:g[1]<g[2]?g[1]:g[2]};vec3.addValue=function(g,h,c){g[0]=h[0]+c;g[1]=h[1]+c;g[2]=h[2]+c};vec3.subValue=function(g,h,c){g[0]=h[0]-c;g[1]=h[1]-c;g[2]=h[2]-c};vec3.toArray=function(g){return[g[0],
g[1],g[2]]};vec3.rotateX=function(g,h,c){var e=h[1],a=h[2],b=Math.cos(c);c=Math.sin(c);g[0]=h[0];g[1]=e*b-a*c;g[2]=e*c+a*b;return g};vec3.rotateY=function(g,h,c){var e=h[0],a=h[2],b=Math.cos(c);c=Math.sin(c);g[0]=e*b-a*c;g[1]=h[1];g[2]=e*c+a*b;return g};vec3.rotateZ=function(g,h,c){var e=h[0],a=h[1],b=Math.cos(c);c=Math.sin(c);g[0]=e*b-a*c;g[1]=e*c+a*b;g[2]=h[2];return g};vec3.angle=function(g,h){return Math.acos(vec3.dot(g,h))};vec3.random=function(g){g[0]=Math.random();g[1]=Math.random();g[2]=Math.random();
return g};vec3.polarToCartesian=function(g,h){var c=h[0],e=h[1];h=h[2];g[0]=c*Math.cos(e)*Math.sin(h);g[1]=c*Math.sin(e);g[2]=c*Math.cos(e)*Math.cos(h);return g};vec4.random=function(g){g[0]=Math.random();g[1]=Math.random();g[2]=Math.random();g[3]=Math.random();return g};vec4.toArray=function(g){return[g[0],g[1],g[2],g[3]]};mat3.IDENTITY=mat3.create();mat4.IDENTITY=mat4.create();mat4.toArray=function(g){return[g[0],g[1],g[2],g[3],g[4],g[5],g[6],g[7],g[8],g[9],g[10],g[11],g[12],g[13],g[14],g[15]]};
mat4.setUpAndOrthonormalize=function(g,h,c){h!=g&&mat4.copy(g,h);h=g.subarray(0,3);vec3.normalize(g.subarray(4,7),c);g=g.subarray(8,11);vec3.cross(h,c,g);vec3.normalize(h,h);vec3.cross(g,h,c);vec3.normalize(g,g)};mat4.multiplyVec3=function(g,h,c){var e=c[0],a=c[1];c=c[2];g[0]=h[0]*e+h[4]*a+h[8]*c+h[12];g[1]=h[1]*e+h[5]*a+h[9]*c+h[13];g[2]=h[2]*e+h[6]*a+h[10]*c+h[14];return g};mat4.projectVec3=function(g,h,c){var e=c[0],a=c[1];c=c[2];var b=h[1]*e+h[5]*a+h[9]*c+h[13],d=h[2]*e+h[6]*a+h[10]*c+h[14],f=
h[3]*e+h[7]*a+h[11]*c+h[15];g[0]=((h[0]*e+h[4]*a+h[8]*c+h[12])/f+1)/2;g[1]=(b/f+1)/2;g[2]=(d/f+1)/2;return g};vec3.project=function(g,h,c,e){e=e||gl.viewport_data;var a=h[0],b=h[1];h=h[2];var d=c[3]*a+c[7]*b+c[11]*h+c[15],f=1-((c[1]*a+c[5]*b+c[9]*h+c[13])/d+1)/2;g[0]=((c[0]*a+c[4]*b+c[8]*h+c[12])/d+1)/2*e[2]+e[0];g[1]=f*e[3]+e[1];g[2]=d;return g};var da=mat4.create(),ha=vec4.create();vec3.unproject=function(g,h,c,e){ha[0]=2*(h[0]-e[0])/e[2]-1;ha[1]=2*(h[1]-e[1])/e[3]-1;ha[2]=2*h[2]-1;ha[3]=1;if(!mat4.invert(da,
c))return null;vec4.transformMat4(ha,ha,da);if(0===ha[3])return null;g[0]=ha[0]/ha[3];g[1]=ha[1]/ha[3];g[2]=ha[2]/ha[3];return g};mat4.rotateVec3=function(g,h,c){var e=c[0],a=c[1];c=c[2];g[0]=h[0]*e+h[4]*a+h[8]*c;g[1]=h[1]*e+h[5]*a+h[9]*c;g[2]=h[2]*e+h[6]*a+h[10]*c;return g};mat4.fromTranslationFrontTop=function(g,h,c,e){vec3.cross(g.subarray(0,3),c,e);g.set(e,4);g.set(c,8);g.set(h,12);return g};mat4.translationMatrix=function(g){var h=mat4.create();h[12]=g[0];h[13]=g[1];h[14]=g[2];return h};mat4.setTranslation=
function(g,h){g[12]=h[0];g[13]=h[1];g[14]=h[2];return g};mat4.getTranslation=function(g,h){g[0]=h[12];g[1]=h[13];g[2]=h[14];return g};mat4.toRotationMat4=function(g,h){mat4.copy(g,h);g[12]=g[13]=g[14]=0;return g};mat4.swapRows=function(g,h,c,e){if(g!=h)return mat4.copy(g,h),g[4*c]=h[4*e],g[4*c+1]=h[4*e+1],g[4*c+2]=h[4*e+2],g[4*c+3]=h[4*e+3],g[4*e]=h[4*c],g[4*e+1]=h[4*c+1],g[4*e+2]=h[4*c+2],g[4*e+3]=h[4*c+3],g;h=new Float32Array(matrix.subarray(4*c,5*c));matrix.set(matrix.subarray(4*e,5*e),4*c);matrix.set(h,
4*e);return g};mat4.scaleAndAdd=function(g,h,c,e){g[0]=h[0]+c[0]*e;g[1]=h[1]+c[1]*e;g[2]=h[2]+c[2]*e;g[3]=h[3]+c[3]*e;g[4]=h[4]+c[4]*e;g[5]=h[5]+c[5]*e;g[6]=h[6]+c[6]*e;g[7]=h[7]+c[7]*e;g[8]=h[8]+c[8]*e;g[9]=h[9]+c[9]*e;g[10]=h[10]+c[10]*e;g[11]=h[11]+c[11]*e;g[12]=h[12]+c[12]*e;g[13]=h[13]+c[13]*e;g[14]=h[14]+c[14]*e;g[15]=h[15]+c[15]*e;return g};quat.fromAxisAngle=function(g,h){var c=quat.create();h*=.5;var e=Math.sin(h);c[0]=e*g[0];c[1]=e*g[1];c[2]=e*g[2];c[3]=Math.cos(h);return c};quat.toEuler=
function(g,h){var c=Math.atan2(2*h[1]*h[3]-2*h[0]*h[2],1-2*h[1]*h[1]-2*h[2]*h[2]),e=Math.asin(2*h[0]*h[1]+2*h[2]*h[3]);h=Math.atan2(2*h[0]*h[3]-2*h[1]*h[2],1-2*h[0]*h[0]-2*h[2]*h[2]);g||=vec3.create();vec3.set(g,c,e,h);return g};quat.fromEuler=function(g,h){var c=h[0],e=h[1];h=h[2];var a=Math.cos(c),b=Math.cos(e),d=Math.cos(h);c=Math.sin(c);e=Math.sin(e);h=Math.sin(h);var f=.5*Math.sqrt(1+a*b+a*d-c*e*h+b*d);0==f&&(f=1E-6);quat.set(g,(b*h+a*h+c*e*d)/(4*f),(c*b+c*d+a*e*h)/(4*f),(-c*h+a*e*d+e)/(4*f),
f);quat.normalize(g,g);return g};quat.fromMat4=function(g,h){var c=h[0]+h[5]+h[10];if(0<c){var e=Math.sqrt(c+1);g[3]=.5*e;e=.5/e;g[0]=(h[9]-h[6])*e;g[1]=(h[2]-h[8])*e;g[2]=(h[4]-h[1])*e}else{c=0;h[5]>h[0]&&(c=1);h[10]>h[4*c+c]&&(c=2);var a=(c+1)%3,b=(a+1)%3;e=Math.sqrt(h[4*c+c]-h[4*a+a]-h[4*b+b]+1);g[c]=.5*e;e=.5/e;g[3]=(h[4*b+a]-h[4*a+b])*e;g[a]=(h[4*a+c]+h[4*c+a])*e;g[b]=(h[4*b+c]+h[4*c+b])*e}quat.normalize(g,g)};quat.fromMat4.lookAt=function(){var g=vec3.create();return function(h,c,e){e=vec3.dot(vec3.FRONT,
c);if(1E-6>Math.abs(e- -1))return h.set(vec3.UP),h[3]=Math.PI,h;if(1E-6>Math.abs(e-1))return quat.identity(h);e=Math.acos(e);vec3.cross(g,vec3.FRONT,c);vec3.normalize(g,g);quat.setAxisAngle(h,g,e);return h}}();t.Indexer=function(){this.unique=[];this.indices=[];this.map={}};t.Indexer.prototype={add:function(g){var h=JSON.stringify(g);h in this.map||(this.map[h]=this.unique.length,this.unique.push(g));return this.map[h]}};t.Buffer=function(g,h,c,e,a){t.debug&&console.log("GL.Buffer created");null!==
a&&(a=a||K.gl);this.buffer=null;this.target=g;this.gl=a;this.data=h;this.spacing=c||3;this.data&&this.gl&&this.upload(e)};t.Buffer.prototype.forEach=function(g){for(var h=this.data,c=0,e=this.spacing,a=h.length;c<a;c+=e)g(h.subarray(c,c+e),c);return this};t.Buffer.prototype.applyTransform=function(g){for(var h=this.data,c=0,e=this.spacing,a=h.length;c<a;c+=e)e=h.subarray(c,c+e),vec3.transformMat4(e,e,g);return this};t.Buffer.prototype.upload=function(g){var h=this.spacing||3,c=this.gl;if(c){if(!this.data)throw"No data supplied";
var e=this.data;if(!e.buffer)throw"Buffers must be typed arrays";if(this.buffer=this.buffer||c.createBuffer()){this.buffer.length=e.length;this.buffer.spacing=h;switch(e.constructor){case Int8Array:this.buffer.gl_type=c.BYTE;break;case Uint8ClampedArray:case Uint8Array:this.buffer.gl_type=c.UNSIGNED_BYTE;break;case Int16Array:this.buffer.gl_type=c.SHORT;break;case Uint16Array:this.buffer.gl_type=c.UNSIGNED_SHORT;break;case Int32Array:this.buffer.gl_type=c.INT;break;case Uint32Array:this.buffer.gl_type=
c.UNSIGNED_INT;break;case Float32Array:this.buffer.gl_type=c.FLOAT;break;default:throw"unsupported buffer type";}c.bindBuffer(this.target,this.buffer);c.bufferData(this.target,e,g||this.stream_type||c.STATIC_DRAW)}}};t.Buffer.prototype.compile=t.Buffer.prototype.upload;t.Buffer.prototype.setData=function(g,h){if(!g.buffer)throw"Data must be typed array";h=h||0;if(this.data){if(this.data.length<g.length)throw"buffer is not big enough, you cannot set data to a smaller buffer";this.data!=g&&(this.data.length==
g.length?(this.data.set(g),this.upload()):(g=new Uint8Array(g.buffer,g.buffer.byteOffset,g.buffer.byteLength),(new Uint8Array(this.data.buffer)).set(g,h),this.uploadRange(h,g.length)))}else this.data=g,this.upload()};t.Buffer.prototype.uploadRange=function(g,h){if(!this.data)throw"No data stored in this buffer";if(!this.data.buffer)throw"Buffers must be typed arrays";h=new Uint8Array(this.data.buffer,g,h);var c=this.gl;c.bindBuffer(this.target,this.buffer);c.bufferSubData(this.target,g,h)};t.Buffer.prototype.clone=
function(g){var h=new t.Buffer;if(g)for(var c in this)h[c]=this[c];else this.target&&(h.target=this.target),this.gl&&(h.gl=this.gl),this.spacing&&(h.spacing=this.spacing),this.data&&(h.data=new K[this.data.constructor](this.data),h.upload());return h};K.Mesh=t.Mesh=function(g,h,c,e){t.debug&&console.log("GL.Mesh created");null!==e&&(this.gl=e=e||K.gl);this._context_id=e.context_id;this.vertexBuffers={};this.indexBuffers={};this.bounding=this.info=null;(g||h)&&this.addBuffers(g,h,c?c.stream_type:null);
if(c)for(var a in c)this[a]=c[a]};Mesh.common_buffers={vertices:{spacing:3,attribute:"a_vertex"},vertices2D:{spacing:2,attribute:"a_vertex2D"},normals:{spacing:3,attribute:"a_normal"},coords:{spacing:2,attribute:"a_coord"},coords1:{spacing:2,attribute:"a_coord1"},coords2:{spacing:2,attribute:"a_coord2"},colors:{spacing:4,attribute:"a_color"},tangents:{spacing:3,attribute:"a_tangent"},bone_indices:{spacing:4,attribute:"a_bone_indices",type:Uint8Array},weights:{spacing:4,attribute:"a_weights"},extra:{spacing:1,
attribute:"a_extra"},extra2:{spacing:2,attribute:"a_extra2"},extra3:{spacing:3,attribute:"a_extra3"},extra4:{spacing:4,attribute:"a_extra4"}};Mesh.default_datatype=Float32Array;Mesh.prototype.addBuffer=function(g,h){h.target==gl.ARRAY_BUFFER?this.vertexBuffers[g]=h:this.indexBuffers[g]=h;h.attribute||(h.attribute=t.Mesh.common_buffers[g].attribute)};Mesh.prototype.addBuffers=function(g,h,c){var e=0;this.vertexBuffers.vertices&&(e=this.vertexBuffers.vertices.data.length/3);for(var a in g){var b=g[a];
if(b){if(b.constructor==t.Buffer)b=b.data;else if("number"!=typeof b[0]){for(var d=[],f=0,k=1E4;f<b.length;f+=k)d=Array.prototype.concat.apply(d,b.slice(f,f+k));b=d}d=t.Mesh.common_buffers[a];b.constructor===Array&&(f=t.Mesh.default_datatype,d&&d.type&&(f=d.type),b=new f(b));"vertices"==a&&(e=b.length/3);f=b.length/e;d&&d.spacing&&(f=d.spacing);k="a_"+a;d&&d.attribute&&(k=d.attribute);this.createVertexBuffer(a,k,f,b,c)}}if(h)for(a in h)if(b=h[a]){b.constructor==t.Buffer&&(b=b.data);if("number"!=typeof b[0]){d=
[];a=0;for(k=1E4;a<b.length;a+=k)d=Array.prototype.concat.apply(d,b.slice(a,a+k));b=d}b.constructor===Array&&(f=Uint16Array,65536<e&&(f=Uint32Array),b=new f(b));this.createIndexBuffer(a,b)}};Mesh.prototype.createVertexBuffer=function(g,h,c,e,a){var b=t.Mesh.common_buffers[g];!h&&b&&(h=b.attribute);if(!h)throw"Buffer added to mesh without attribute name";!c&&b&&(c=b&&b.spacing?b.spacing:3);if(!e){e=this.getNumVertices();if(!e)throw"Cannot create an empty buffer in a mesh without vertices (vertices are needed to know the size)";
e=new t.Mesh.default_datatype(e*c)}if(!e.buffer)throw"Buffer data MUST be typed array";c=this.vertexBuffers[g]=new t.Buffer(gl.ARRAY_BUFFER,e,c,a,this.gl);c.name=g;c.attribute=h;return c};Mesh.prototype.removeVertexBuffer=function(g){this.vertexBuffers[g]&&delete this.vertexBuffers[g]};Mesh.prototype.getVertexBuffer=function(g){return this.vertexBuffers[g]};Mesh.prototype.createIndexBuffer=function(g,h,c){if(h.constructor===Array){var e=Uint16Array,a=this.vertexBuffers.vertices;a&&(65536<a.data.length/
3&&(e=Uint32Array),h=new e(h))}return this.indexBuffers[g]=new t.Buffer(gl.ELEMENT_ARRAY_BUFFER,h,0,c,this.gl)};Mesh.prototype.getBuffer=function(g){return this.vertexBuffers[g]};Mesh.prototype.getIndexBuffer=function(g){return this.indexBuffers[g]};Mesh.prototype.upload=function(g){for(var h in this.vertexBuffers){var c=this.vertexBuffers[h];c.upload(g)}for(var e in this.indexBuffers)c=this.indexBuffers[e],c.upload()};Mesh.prototype.compile=Mesh.prototype.upload;Mesh.prototype.deleteBuffers=function(){for(var g in this.vertexBuffers){var h=
this.vertexBuffers[g];this.gl.deleteBuffer(h.buffer)}this.vertexBuffers={};for(g in this.indexBuffers)h=this.indexBuffers[g],this.gl.deleteBuffer(h.buffer);this.indexBuffers[g]={}};Mesh.prototype.bindBuffers=function(g){for(var h in this.vertexBuffers){var c=this.vertexBuffers[h],e=g.attributes[c.attribute||h];null!=e&&c.buffer&&(gl.bindBuffer(gl.ARRAY_BUFFER,c.buffer),gl.enableVertexAttribArray(e),gl.vertexAttribPointer(e,c.buffer.spacing,c.buffer.gl_type,!1,0,0))}};Mesh.prototype.unbindBuffers=
function(g){for(var h in this.vertexBuffers){var c=this.vertexBuffers[h],e=c.attribute||h;null!=g.attributes[e]&&c.buffer&&gl.disableVertexAttribArray(g.attributes[e])}};Mesh.prototype.clone=function(g){g=g||K.gl;var h={},c={},e;for(e in this.vertexBuffers){var a=this.vertexBuffers[e];h[e]=new a.data.constructor(a.data)}for(e in this.indexBuffers)a=this.indexBuffers[e],c[e]=new a.data.constructor(a.data);return new t.Mesh(h,c,void 0,g)};Mesh.prototype.cloneShared=function(g){g=g||K.gl;return new t.Mesh(this.vertexBuffers,
this.indexBuffers,void 0,g)};Mesh.prototype.toObject=function(){var g={},h={},c;for(c in this.vertexBuffers){var e=this.vertexBuffers[c];g[c]={spacing:e.spacing,data:new e.data.constructor(e.data)}}for(c in this.indexBuffers)e=this.indexBuffers[c],h[c]={data:new e.data.constructor(e.data)};return{vertexBuffers:g,indexBuffers:h}};Mesh.prototype.generateMetadata=function(){var g={},h=this.vertexBuffers.vertices.data,c=this.indexBuffers.triangles.data;g.vertices=h.length/3;g.faces=c?c.length/3:h.length/
9;g.indexed=!!this.metadata.faces;this.metadata=g};Mesh.prototype.toJSON=function(){return""};Mesh.prototype.computeWireframe=function(){var g=this.indexBuffers.triangles,h=this.vertexBuffers.vertices.data.length/3;if(g){var c=g.data,e=new t.Indexer;for(g=0;g<c.length;g+=3)for(var a=c.subarray(g,g+3),b=0;b<a.length;b++){var d=a[b],f=a[(b+1)%a.length];e.add([Math.min(d,f),Math.max(d,f)])}c=e.unique;e=65536<h?new Uint32Array(2*c.length):new Uint16Array(2*c.length);g=0;for(h=c.length;g<h;++g)e.set(c[g],
2*g)}else for(g=h/3,e=65536<h?new Uint32Array(6*g):new Uint16Array(6*g),g=0;g<h;g+=3)e[2*g]=g,e[2*g+1]=g+1,e[2*g+2]=g+1,e[2*g+3]=g+2,e[2*g+4]=g+2,e[2*g+5]=g;this.createIndexBuffer("wireframe",e);return this};Mesh.prototype.flipNormals=function(g){var h=this.vertexBuffers.normals;if(h){for(var c=h.data,e=c.length,a=0;a<e;++a)c[a]*=-1;h.upload(g);this.indexBuffers.triangles&&this.computeIndices();h=this.indexBuffers.triangles;c=h.data;e=c.length;for(a=0;a<e;a+=3){var b=c[a];c[a]=c[a+1];c[a+1]=b}h.upload(g)}};
Mesh.prototype.computeIndices=function(){var g=[],h=[],c=[],e=[],a=this.vertexBuffers.normals,b=this.vertexBuffers.coords,d=this.vertexBuffers.vertices.data,f=null;a&&(f=a.data);a=null;b&&(a=b.data);b={};for(var k=d.length/3,l=0;l<k;++l){var m=d.subarray(3*l,3*(l+1)),q=1E3*m[0]|0,n=0,p=b[q];if(p)for(var x=p.length;n<x;n++)if(.01>vec3.sqrDist(m,g[p[n]])){e.push(n);break}p&&n!=x||(g.push(m),b[q]?b[q].push(n):b[q]=[n],f&&h.push(f.subarray(3*l,3*(l+1))),a&&c.push(a.subarray(2*l,2*(l+1))),e.push(n))}this.vertexBuffers=
{};this.createVertexBuffer("vertices",t.Mesh.common_buffers.vertices.attribute,3,linearizeArray(g));f&&this.createVertexBuffer("normals",t.Mesh.common_buffers.normals.attribute,3,linearizeArray(h));a&&this.createVertexBuffer("coords",t.Mesh.common_buffers.coords.attribute,2,linearizeArray(c));this.createIndexBuffer("triangles",e)};Mesh.prototype.computeNormals=function(g){var h=this.vertexBuffers.vertices.data,c=new Float32Array(h.length),e=null;this.indexBuffers.triangles&&(e=this.indexBuffers.triangles.data);
for(var a=t.temp_vec3,b=t.temp2_vec3,d,f,k,l,m,q,n=e?e.length:h.length,p=0;p<n;p+=3)e?(d=e[p],f=e[p+1],k=e[p+2],l=h.subarray(3*d,3*d+3),m=h.subarray(3*f,3*f+3),q=h.subarray(3*k,3*k+3),d=c.subarray(3*d,3*d+3),f=c.subarray(3*f,3*f+3),k=c.subarray(3*k,3*k+3)):(l=h.subarray(3*p,3*p+3),m=h.subarray(3*p+3,3*p+6),q=h.subarray(3*p+6,3*p+9),d=c.subarray(3*p,3*p+3),f=c.subarray(3*p+3,3*p+6),k=c.subarray(3*p+6,3*p+9)),vec3.sub(a,m,l),vec3.sub(b,q,l),vec3.cross(a,a,b),vec3.normalize(a,a),vec3.add(d,d,a),vec3.add(f,
f,a),vec3.add(k,k,a);if(e)for(p=0,n=c.length;p<n;p+=3)h=c.subarray(p,p+3),vec3.normalize(h,h);if(n=this.vertexBuffers.normals)n.data=c,n.upload(g);else return this.createVertexBuffer("normals",t.Mesh.common_buffers.normals.attribute,3,c);return n};Mesh.prototype.computeTangents=function(){var g=this.vertexBuffers.vertices.data,h=this.vertexBuffers.normals.data,c=this.vertexBuffers.coords.data,e=this.indexBuffers.triangles.data;if(g&&h&&c){var a=g.length/3,b=new Float32Array(4*a),d=new Float32Array(6*
a);a=d.subarray(3*a);var f,k=vec3.create(),l=vec3.create(),m=vec3.create(),q=vec3.create();var n=0;for(f=e.length;n<f;n+=3){var p=e[n],x=e[n+1],w=e[n+2],r=g.subarray(3*p,3*p+3),u=g.subarray(3*x,3*x+3),y=g.subarray(3*w,3*w+3),A=c.subarray(2*p,2*p+2),G=c.subarray(2*x,2*x+2),O=c.subarray(2*w,2*w+2),S=u[0]-r[0],B=y[0]-r[0],I=u[1]-r[1],J=y[1]-r[1];u=u[2]-r[2];r=y[2]-r[2];y=G[0]-A[0];var M=O[0]-A[0];G=G[1]-A[1];A=O[1]-A[1];O=y*A-M*G;O=1E-9>Math.abs(O)?0:1/O;vec3.copy(k,[(A*S-G*B)*O,(A*I-G*J)*O,(A*u-G*r)*
O]);vec3.copy(l,[(y*B-M*S)*O,(y*J-M*I)*O,(y*r-M*u)*O]);vec3.add(d.subarray(3*p,3*p+3),d.subarray(3*p,3*p+3),k);vec3.add(d.subarray(3*x,3*x+3),d.subarray(3*x,3*x+3),k);vec3.add(d.subarray(3*w,3*w+3),d.subarray(3*w,3*w+3),k);vec3.add(a.subarray(3*p,3*p+3),a.subarray(3*p,3*p+3),l);vec3.add(a.subarray(3*x,3*x+3),a.subarray(3*x,3*x+3),l);vec3.add(a.subarray(3*w,3*w+3),a.subarray(3*w,3*w+3),l)}n=0;for(f=g.length;n<f;n+=3)g=h.subarray(n,n+3),c=d.subarray(n,n+3),vec3.subtract(m,c,vec3.scale(m,g,vec3.dot(g,
c))),vec3.normalize(m,m),g=0>vec3.dot(vec3.cross(q,g,c),a.subarray(n,n+3))?-1:1,b.set([m[0],m[1],m[2],g],n/3*4);this.createVertexBuffer("tangents",Mesh.common_buffers.tangents.attribute,4,b)}};Mesh.prototype.getNumVertices=function(){var g=this.vertexBuffers.vertices;return g?g.data.length/g.spacing:0};Mesh.computeBounding=function(g,h){if(g){for(var c=vec3.clone(g.subarray(0,3)),e=vec3.clone(g.subarray(0,3)),a,b=3;b<g.length;b+=3)a=g.subarray(b,b+3),vec3.min(c,a,c),vec3.max(e,a,e);if(isNaN(c[0])||
isNaN(c[1])||isNaN(c[2])||isNaN(e[0])||isNaN(e[1])||isNaN(e[2]))c[0]=c[1]=c[2]=0,e[0]=e[1]=e[2]=0,console.warn("Warning: GL.Mesh has NaN values in vertices");c=vec3.add(vec3.create(),c,e);vec3.scale(c,c,.5);e=vec3.subtract(vec3.create(),e,c);return BBox.setCenterHalfsize(h||BBox.create(),c,e)}};Mesh.prototype.getBoundingBox=function(){this.bounding||this.updateBounding();return this.bounding};Mesh.prototype.updateBounding=function(){var g=this.vertexBuffers.vertices.data;g&&(this.bounding=t.Mesh.computeBounding(g,
this.bounding))};Mesh.prototype.setBounding=function(g,h){this.bounding=BBox.setCenterHalfsize(this.bounding||BBox.create(),g,h)};Mesh.prototype.freeData=function(){for(var g in this.vertexBuffers)this.vertexBuffers[g].data=null,delete this[this.vertexBuffers[g].name];for(var h in this.indexBuffers)this.indexBuffers[h].data=null,delete this[this.indexBuffers[h].name]};Mesh.prototype.configure=function(g,h){var c={},e={};h=h||{};for(var a in g)g[a]&&("indices"==a||"lines"==a||"wireframe"==a||"triangles"==
a?e[a]=g[a]:t.Mesh.common_buffers[a]?c[a]=g[a]:h[a]=g[a]);this.addBuffers(c,e,h.stream_type);for(e in h)this[e]=h[e]};Mesh.prototype.totalMemory=function(){var g=0,h;for(h in this.vertexBuffers)g+=this.vertexBuffers[h].data.buffer.byteLength;for(h in this.indexBuffers)g+=this.indexBuffers[h].data.buffer.byteLength;return g};Mesh.prototype.simplify=function(){var g=this.getBoundingBox(),h=BBox.getMin(g);g=BBox.getHalfsize(g);g=vec3.scale(vec3.create(),g,2);var c=new t.Mesh,e=vec3.create(),a;for(a in this.vertexBuffers){var b=
this.vertexBuffers[a].data,d=new Float32Array(b.length);if("vertices"==a)for(var f=0,k=b.length;f<k;f+=3){var l=b.subarray(f,f+3);vec3.sub(e,l,h);vec3.div(e,e,g);e[0]=Math.round(256*e[0])/256;e[1]=Math.round(256*e[1])/256;e[2]=Math.round(256*e[2])/256;vec3.mul(e,e,g);vec3.add(e,e,h);d.set(e,f)}c.addBuffer()}};Mesh.load=function(g,h,c,e){h=h||{};h.no_gl&&(e=null);c=c||new t.Mesh(null,null,null,e);c.configure(g,h);return c};Mesh.mergeMeshes=function(g,h){function c(u,y,A,G){for(A=y+A;y<A;y+=3){var O=
u.subarray(y,y+3);vec3.transformMat4(O,O,G)}}function e(u,y,A,G){for(A=y+A;y<A;y+=2){var O=u.subarray(y,y+2);vec2.transformMat3(O,O,G)}}function a(u,y,A,G){for(A=y+A;y<A;++y)u[y]+=G}h=h||{};for(var b={},d={},f={},k=[],l=0,m=[],q=0;q<g.length;++q){var n=g[q],p=n.mesh,x=l;k.push(x);var w=p.vertexBuffers.vertices.data.length/3;l+=w;for(var r in p.vertexBuffers)b[r]=b[r]?b[r]+p.vertexBuffers[r].data.length:p.vertexBuffers[r].data.length;for(r in p.indexBuffers)d[r]=d[r]?d[r]+p.indexBuffers[r].data.length:
p.indexBuffers[r].data.length;m.push({name:"mesh_"+q,start:x,length:w,material:""})}for(r in b)q=h[r],null===q?delete b[r]:(q||=Float32Array,b[r]=new q(b[r]),f[r]=0);for(r in d)d[r]=new Uint32Array(d[r]),f[r]=0;for(q=0;q<g.length;++q){n=g[q];p=n.mesh;w=x=0;for(r in p.vertexBuffers)b[r]&&("vertices"==r&&(w=p.vertexBuffers[r].data.length/3),b[r].set(p.vertexBuffers[r].data,f[r]),n[r+"_matrix"]&&(l=n[r+"_matrix"],16==l.length?c(b[r],f[r],p.vertexBuffers[r].data.length,l):9==l.length&&e(b[r],f[r],p.vertexBuffers[r].data.length,
l)),f[r]+=p.vertexBuffers[r].data.length);for(r in p.indexBuffers)d[r].set(p.indexBuffers[r].data,f[r]),a(d[r],f[r],p.indexBuffers[r].data.length,k[q]),f[r]+=p.indexBuffers[r].data.length}f={info:{groups:m}};return"undefined"!=typeof gl?new t.Mesh(b,d,f):{vertexBuffers:b,indexBuffers:d,info:{groups:m}}};Mesh.parsers={};Mesh.encoders={};Mesh.fromURL=function(g,h,c,e){e=e||{};c=c||K.gl;var a=new t.Mesh(void 0,void 0,void 0,c);a.ready=!1;HttpRequest(g,null,function(b){var d=g.lastIndexOf(".");d=g.substr(d+
1);a.parse(b,d);delete a.ready;h&&h.call(a,a,g)},function(b){h&&h(null)},e);return a};Mesh.prototype.parse=function(g,h){h=h.toLowerCase();var c=t.Mesh.parsers[h];if(c)return c.call(null,g,{mesh:this});throw"GL.Mesh.parse: no parser found for format "+h;};Mesh.prototype.encode=function(g,h){g=g.toLowerCase();var c=t.Mesh.encoders[g];if(c)return c.call(null,this,h);throw"GL.Mesh.encode: no encoder found for format "+g;};Mesh.getScreenQuad=function(g){g=g||K.gl;var h=g.meshes[":screen_quad"];if(h)return h;
h=new Float32Array([0,0,0,1,1,0,0,1,0,0,0,0,1,0,0,1,1,0]);var c=new Float32Array([0,0,1,1,0,1,0,0,1,0,1,1]);h=new t.Mesh({vertices:h,coords:c},void 0,void 0,g);return g.meshes[":screen_quad"]=h};Mesh.plane=function(g,h){g=g||{};g.triangles=[];var c=g.detailX||g.detail||1,e=g.detailY||g.detail||1,a=g.width||g.size||1,b=g.height||g.size||1;g=g.xz;a*=.5;b*=.5;var d=[],f=[],k=[],l=[],m=vec3.fromValues(0,0,1);g&&m.set([0,1,0]);for(var q=0;q<=e;q++)for(var n=q/e,p=0;p<=c;p++){var x=p/c;g?f.push((2*x-1)*
a,0,-(2*n-1)*b):f.push((2*x-1)*a,(2*n-1)*b,0);k&&k.push(x,n);l&&l.push(m[0],m[1],m[2]);p<c&&q<e&&(x=p+q*(c+1),g?(d.push(x+1,x+c+1,x),d.push(x+1,x+c+2,x+c+1)):(d.push(x,x+1,x+c+1),d.push(x+c+1,x+1,x+c+2)))}c=BBox.fromCenterHalfsize([0,0,0],g?[a,0,b]:[a,b,0]);return t.Mesh.load({vertices:f,normals:l,coords:k,triangles:d},{bounding:c},h)};Mesh.plane2D=function(g,h){var c=new Float32Array([-1,1,1,-1,1,1,-1,1,-1,-1,1,-1]),e=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0]);if(g&&g.size){g=.5*g.size;for(var a=
0;a<c.length;++a)c[a]*=g}return new t.Mesh({vertices2D:c,coords:e},null,h)};Mesh.point=function(g){return new t.Mesh({vertices:[0,0,0]})};Mesh.cube=function(g,h){g=g||{};var c=.5*(g.size||1),e={};e.vertices=new Float32Array([-1,1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,1,1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,1]);for(var a=
0,b=e.vertices.length;a<b;++a)e.vertices[a]*=c;e.normals=new Float32Array([-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0]);e.coords=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]);g.wireframe&&(e.wireframe=
new Uint16Array([0,2,2,5,5,4,4,0,6,7,7,10,10,11,11,6,0,6,2,7,5,10,4,11]));g.bounding=BBox.fromCenterHalfsize([0,0,0],[c,c,c]);return t.Mesh.load(e,g,h)};Mesh.box=function(g,h){g=g||{};var c=g.sizex||1,e=g.sizey||1,a=g.sizez||1;c*=.5;e*=.5;a*=.5;var b={};b.vertices=new Float32Array([-1,1,-1,-1,-1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,-1,1,-1,1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,1,
1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,-1,1,-1,1,-1,-1,1]);for(var d=0,f=b.vertices.length;d<f;d+=3)b.vertices[d]*=c,b.vertices[d+1]*=e,b.vertices[d+2]*=a;b.normals=new Float32Array([-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0]);b.coords=new Float32Array([0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,
0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,0,1,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0]);g.wireframe&&(b.wireframe=new Uint16Array([0,2,2,5,5,4,4,0,6,7,7,10,10,11,11,6,0,6,2,7,5,10,4,11]));g.bounding=BBox.fromCenterHalfsize([0,0,0],[c,e,a]);return t.Mesh.load(b,g,h)};Mesh.circle=function(g,h){g=g||{};var c=g.size||g.radius||1,e=Math.ceil(g.slices||24),a=g.xz||!1,b=g.empty||!1;3>e&&(e=3);var d=2*Math.PI/e,f=vec3.create(),k=vec3.create(),l=vec3.fromValues(0,0,1),m=vec2.fromValues(.5,.5),q=vec2.create();
a&&l.set([0,1,0]);var n=a?2:1,p=new Float32Array(3*(e+1)),x=new Float32Array(3*(e+1)),w=new Float32Array(2*(e+1));p.set(f,0);x.set(l,0);w.set(m,0);for(f=0;f<e;++f){var r=Math.sin(d*f);m=Math.cos(d*f);k[0]=r*c;k[n]=m*c;q[0]=.5*r+.5;q[1]=.5*m+.5;p.set(k,3*f+3);x.set(l,3*f+3);w.set(q,2*f+2)}if(b)p=p.subarray(3),x=p.subarray(3),w=p.subarray(2),r=null;else{r=new Uint16Array(3*e);b=2;d=1;a&&(b=1,d=2);for(f=0;f<e-1;++f)r[3*f]=0,r[3*f+1]=f+b,r[3*f+2]=f+d;r[3*f]=0;a?(r[3*f+1]=f+1,r[3*f+2]=1):(r[3*f+1]=1,r[3*
f+2]=f+1)}g.bounding=BBox.fromCenterHalfsize([0,0,0],a?[c,0,c]:[c,c,0]);c={vertices:p,normals:x,coords:w,triangles:r};if(g.wireframe){a=new Uint16Array(2*e);for(f=0;f<e;f++)a[2*f]=f,a[2*f+1]=f+1;a[0]=e;c.wireframe=a}return t.Mesh.load(c,g,h)};Mesh.cylinder=function(g,h){g=g||{};for(var c=g.radius||g.size||1,e=g.height||g.size||2,a=g.subdivisions||64,b=new Float32Array(36*a),d=new Float32Array(36*a),f=new Float32Array(24*a),k=2*Math.PI/a,l,m=0;m<a;++m){var q=m*k;l=[Math.sin(q),0,Math.cos(q)];b.set([l[0]*
c,.5*e,l[2]*c],18*m);d.set(l,18*m);f.set([m/a,1],12*m);l=[Math.sin(q),0,Math.cos(q)];b.set([l[0]*c,-.5*e,l[2]*c],18*m+3);d.set(l,18*m+3);f.set([m/a,0],12*m+2);l=[Math.sin(q+k),0,Math.cos(q+k)];b.set([l[0]*c,-.5*e,l[2]*c],18*m+6);d.set(l,18*m+6);f.set([(m+1)/a,0],12*m+4);l=[Math.sin(q+k),0,Math.cos(q+k)];b.set([l[0]*c,.5*e,l[2]*c],18*m+9);d.set(l,18*m+9);f.set([(m+1)/a,1],12*m+6);l=[Math.sin(q),0,Math.cos(q)];b.set([l[0]*c,.5*e,l[2]*c],18*m+12);d.set(l,18*m+12);f.set([m/a,1],12*m+8);l=[Math.sin(q+
k),0,Math.cos(q+k)];b.set([l[0]*c,-.5*e,l[2]*c],18*m+15);d.set(l,18*m+15);f.set([(m+1)/a,0],12*m+10)}l=18*m;var n=12*m;if(!1===g.caps)b=b.subarray(0,l),d=d.subarray(0,l),f=f.subarray(0,n);else{var p=vec3.fromValues(0,.5*e,0),x=vec3.fromValues(0,-.5*e,0),w=vec3.fromValues(0,1,0),r=vec3.fromValues(0,-1,0);for(m=0;m<a;++m){q=m*k;var u=vec3.fromValues(Math.sin(q),0,Math.cos(q));q=vec3.fromValues(Math.sin(q+k),0,Math.cos(q+k));b.set([u[0]*c,.5*e,u[2]*c],l+18*m);d.set(w,l+18*m);f.set([.5*-u[0]+.5,.5*u[2]+
.5],n+12*m);b.set([q[0]*c,.5*e,q[2]*c],l+18*m+3);d.set(w,l+18*m+3);f.set([.5*-q[0]+.5,.5*q[2]+.5],n+12*m+2);b.set(p,l+18*m+6);d.set(w,l+18*m+6);f.set([.5,.5],n+12*m+4);b.set([q[0]*c,-.5*e,q[2]*c],l+18*m+9);d.set(r,l+18*m+9);f.set([.5*q[0]+.5,.5*q[2]+.5],n+12*m+6);b.set([u[0]*c,-.5*e,u[2]*c],l+18*m+12);d.set(r,l+18*m+12);f.set([.5*u[0]+.5,.5*u[2]+.5],n+12*m+8);b.set(x,l+18*m+15);d.set(r,l+18*m+15);f.set([.5,.5],n+12*m+10)}}a={vertices:b,normals:d,coords:f};g.bounding=BBox.fromCenterHalfsize([0,0,0],
[c,.5*e,c]);return Mesh.load(a,g,h)};Mesh.sphere=function(g,h){g=g||{};for(var c=g.radius||g.size||1,e=g.lat||g.subdivisions||16,a=g["long"]||g.subdivisions||16,b=new Float32Array((e+1)*(a+1)*3),d=new Float32Array((e+1)*(a+1)*3),f=new Float32Array((e+1)*(a+1)*2),k=new Uint16Array(e*a*6),l=g.hemi?.5*Math.PI:Math.PI,m=0,q=0,n=0;n<=e;n++){var p=n*l/e,x=Math.sin(p),w=Math.cos(p);for(p=0;p<=a;p++){var r=2*p*Math.PI/a,u=Math.sin(r);r=Math.cos(r)*x;var y=w;u*=x;var A=1-p/a,G=1-n/e;b.set([c*r,c*y,c*u],m);
d.set([r,y,u],m);f.set([A,G],q);m+=3;q+=2}}for(n=m=0;n<e;n++)for(p=0;p<a;p++)l=n*(a+1)+p,q=l+a+1,k.set([q,l,l+1],m),k.set([q+1,q,l+1],m+3),m+=6;b={vertices:b,normals:d,coords:f,triangles:k};if(g.wireframe){d=new Uint16Array(a*e*4);for(m=f=0;m<e;m++){for(k=0;k<a;k++)d[f]=m*(a+1)+k,d[f+1]=m*(a+1)+k+1,f+=2;d[f-2*a]=m*(a+1)+k}for(m=0;m<a;m++)for(k=0;k<e;k++)d[f]=k*(a+1)+m,d[f+1]=(k+1)*(a+1)+m,f+=2;b.wireframe=d}g.bounding=g.hemi?BBox.fromCenterHalfsize([0,.5*c,0],[c,.5*c,c],c):BBox.fromCenterHalfsize([0,
0,0],[c,c,c],c);return t.Mesh.load(b,g,h)};Mesh.grid=function(g,h){g=g||{};var c=g.lines||11;0>c&&(c=1);var e=g.size||10,a=new Float32Array(12*c),b=.5*e,d=0,f=-b;e/=c-1;for(var k=0;k<c;k++)a[d]=f,a[d+2]=-b,a[d+3]=f,a[d+5]=b,a[d+6]=b,a[d+8]=f,a[d+9]=-b,a[d+11]=f,f+=e,d+=12;return new t.Mesh({vertices:a},g,h)};Mesh.icosahedron=function(g,h){function c(u,y){var A=l[u]<l[y]?l[u]+":"+l[y]:l[y]+":"+l[u],G=w[A];if(G)return G;G=d.length/3;d.push(.5*(d[3*l[u]]+d[3*l[y]]),.5*(d[3*l[u]+1]+d[3*l[y]+1]),.5*(d[3*
l[u]+2]+d[3*l[y]+2]));u=Math.sqrt(d[3*G]*d[3*G]+d[3*G+1]*d[3*G+1]+d[3*G+2]*d[3*G+2]);y=d[3*G]/u;var O=d[3*G+1]/u,S=d[3*G+2]/u;f.push(y,O,S);k.push(Math.atan2(y,S)/Math.PI*.5,Math.acos(O)/Math.PI);d[3*G]*=e/u;d[3*G+1]*=e/u;d[3*G+2]*=e/u;return w[A]=G}g=g||{};var e=g.radius||g.size||1,a=void 0===g.subdivisions?0:g.subdivisions;6<a&&(a=6);var b=(1+Math.sqrt(5))/2,d=[-1,b,0,1,b,0,-1,-b,0,1,-b,0,0,-1,b,0,1,b,0,-1,-b,0,1,-b,b,0,-1,b,0,1,-b,0,-1,-b,0,1],f=[],k=[],l=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,
9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1];b=d.length;for(var m=0;m<b;m+=3){var q=Math.sqrt(d[m]*d[m]+d[m+1]*d[m+1]+d[m+2]*d[m+2]),n=d[m]/q,p=d[m+1]/q,x=d[m+2]/q;f.push(n,p,x);k.push(Math.atan2(n,x),Math.acos(p));d[m]*=e/q;d[m+1]*=e/q;d[m+2]*=e/q}var w={};for(q=0;q<a;++q){n=[];b=l.length;for(m=0;m<b;m+=3){p=c(m,m+1);x=c(m+1,m+2);var r=c(m+2,m);n.push(l[m],p,r);n.push(l[m+1],x,p);n.push(l[m+2],r,x);n.push(p,x,r)}l=n}g.bounding=BBox.fromCenterHalfsize([0,
0,0],[e,e,e],e);return new t.Mesh.load({vertices:d,coords:k,normals:f,triangles:l},g,h)};K.Texture=t.Texture=function b(h,c,e,a){e=e||{};this.gl=a=a||K.gl;this._context_id=a.context_id;h=parseInt(h);c=parseInt(c);t.debug&&console.log("GL.Texture created: ",h,c);this.handler=a.createTexture();this.width=h;this.height=c;this.texture_type=e.texture_type||a.TEXTURE_2D;this.format=e.format||b.DEFAULT_FORMAT;this.type=e.type||b.DEFAULT_TYPE;this.magFilter=e.magFilter||e.filter||b.DEFAULT_MAG_FILTER;this.minFilter=
e.minFilter||e.filter||b.DEFAULT_MIN_FILTER;this.wrapS=e.wrap||e.wrapS||b.DEFAULT_WRAP_S;this.wrapT=e.wrap||e.wrapT||b.DEFAULT_WRAP_T;this.data=null;b.MAX_TEXTURE_IMAGE_UNITS||(b.MAX_TEXTURE_IMAGE_UNITS=a.getParameter(a.MAX_TEXTURE_IMAGE_UNITS));this.has_mipmaps=!1;if(this.format==a.DEPTH_COMPONENT&&!a.extensions.WEBGL_depth_texture)throw"Depth Texture not supported";if(this.type==a.FLOAT&&!a.extensions.OES_texture_float)throw"Float Texture not supported";if(this.type==a.HALF_FLOAT_OES&&!a.extensions.OES_texture_half_float)throw"Half Float Texture not supported";
if(!(isPowerOfTwo(this.width)&&isPowerOfTwo(this.height)||(this.minFilter==a.NEAREST||this.minFilter==a.LINEAR)&&this.wrapS==a.CLAMP_TO_EDGE&&this.wrapT==a.CLAMP_TO_EDGE))if(e.ignore_pot)this.minFilter=this.magFilter=a.LINEAR,this.wrapS=this.wrapT=a.CLAMP_TO_EDGE;else throw"Cannot use texture-wrap or mipmaps in Non-Power-of-Two textures";if(h&&c){a.activeTexture(a.TEXTURE0+b.MAX_TEXTURE_IMAGE_UNITS-1);a.bindTexture(this.texture_type,this.handler);a.texParameteri(this.texture_type,a.TEXTURE_MAG_FILTER,
this.magFilter);a.texParameteri(this.texture_type,a.TEXTURE_MIN_FILTER,this.minFilter);a.texParameteri(this.texture_type,a.TEXTURE_WRAP_S,this.wrapS);a.texParameteri(this.texture_type,a.TEXTURE_WRAP_T,this.wrapT);e.anisotropic&&a.extensions.EXT_texture_filter_anisotropic&&a.texParameterf(a.TEXTURE_2D,a.extensions.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,e.anisotropic);var d=e.pixel_data;d&&!d.buffer&&(this.data=d=new (this.type==a.FLOAT?Float32Array:Uint8Array)(d));this.texture_type==
a.TEXTURE_2D?(a.texImage2D(a.TEXTURE_2D,0,this.format,h,c,0,this.format,this.type,d||null),t.isPowerOfTwo(h)&&t.isPowerOfTwo(c)&&e.minFilter&&e.minFilter!=a.NEAREST&&e.minFilter!=a.LINEAR&&(a.generateMipmap(this.texture_type),this.has_mipmaps=!0)):this.texture_type==a.TEXTURE_CUBE_MAP&&(a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X,0,this.format,this.width,this.height,0,this.format,this.type,d||null),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_Y,0,this.format,this.width,this.height,0,this.format,this.type,
d||null),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_Z,0,this.format,this.width,this.height,0,this.format,this.type,d||null),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_X,0,this.format,this.width,this.height,0,this.format,this.type,d||null),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,this.format,this.width,this.height,0,this.format,this.type,d||null),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,this.format,this.width,this.height,0,this.format,this.type,d||null));a.bindTexture(this.texture_type,null);a.activeTexture(a.TEXTURE0)}};
Texture.DEFAULT_TYPE=t.UNSIGNED_BYTE;Texture.DEFAULT_FORMAT=t.RGBA;Texture.DEFAULT_MAG_FILTER=t.LINEAR;Texture.DEFAULT_MIN_FILTER=t.LINEAR;Texture.DEFAULT_WRAP_S=t.CLAMP_TO_EDGE;Texture.DEFAULT_WRAP_T=t.CLAMP_TO_EDGE;Texture.framebuffer=null;Texture.renderbuffer=null;Texture.loading_color=new Uint8Array([0,0,0,0]);Texture.use_renderbuffer_pool=!0;Texture.prototype.delete=function(){gl.deleteBuffer(this.handler);this.handler=null};Texture.prototype.getProperties=function(){return{width:this.width,
height:this.height,type:this.type,format:this.format,texture_type:this.texture_type,magFilter:this.magFilter,minFilter:this.minFilter,wrapS:this.wrapS,wrapT:this.wrapT}};Texture.prototype.toJSON=function(){return""};Texture.isDepthSupported=function(){return null!=gl.extensions.WEBGL_depth_texture};Texture.prototype.bind=function(h){void 0==h&&(h=0);var c=this.gl;c.activeTexture(c.TEXTURE0+h);c.bindTexture(this.texture_type,this.handler);return h};Texture.prototype.unbind=function(h){void 0===h&&
(h=0);var c=this.gl;c.activeTexture(c.TEXTURE0+h);c.bindTexture(this.texture_type,null)};Texture.prototype.setParameter=function(h,c){this.bind(0);this.gl.texParameteri(this.texture_type,h,c);switch(h){case this.gl.TEXTURE_MAG_FILTER:this.magFilter=c;break;case this.gl.TEXTURE_MIN_FILTER:this.minFilter=c;break;case this.gl.TEXTURE_WRAP_S:this.wrapS=c;break;case this.gl.TEXTURE_WRAP_T:this.wrapT=c}};Texture.setUploadOptions=function(h,c){c=c||K.gl;h?(c.pixelStorei(c.UNPACK_PREMULTIPLY_ALPHA_WEBGL,
!!h.premultiply_alpha),c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,!h.no_flip)):(c.pixelStorei(c.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,!0));c.pixelStorei(c.UNPACK_ALIGNMENT,1)};Texture.prototype.uploadImage=function(h,c){this.bind();var e=this.gl;Texture.setUploadOptions(c,e);try{e.texImage2D(e.TEXTURE_2D,0,this.format,this.format,this.type,h),this.width=h.videoWidth||h.width,this.height=h.videoHeight||h.height,this.data=h}catch(a){if("file:"==location.protocol)throw'image not loaded for security reasons (serve this page over "http://" instead)';
throw"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)";}this.minFilter&&this.minFilter!=e.NEAREST&&this.minFilter!=e.LINEAR&&(e.generateMipmap(this.texture_type),this.has_mipmaps=!0);e.bindTexture(this.texture_type,null)};Texture.prototype.uploadData=function(h,c){var e=this.gl;this.bind();Texture.setUploadOptions(c,e);e.texImage2D(this.texture_type,0,this.format,this.width,this.height,0,this.format,this.type,h);this.data=
h;this.minFilter&&this.minFilter!=e.NEAREST&&this.minFilter!=e.LINEAR&&(e.generateMipmap(texture.texture_type),this.has_mipmaps=!0);e.bindTexture(this.texture_type,null)};Texture.cubemap_camera_parameters=[{type:"posX",dir:vec3.fromValues(1,0,0),up:vec3.fromValues(0,1,0),right:vec3.fromValues(0,0,-1)},{type:"negX",dir:vec3.fromValues(-1,0,0),up:vec3.fromValues(0,1,0),right:vec3.fromValues(0,0,1)},{type:"posY",dir:vec3.fromValues(0,1,0),up:vec3.fromValues(0,0,-1),right:vec3.fromValues(1,0,0)},{type:"negY",
dir:vec3.fromValues(0,-1,0),up:vec3.fromValues(0,0,1),right:vec3.fromValues(1,0,0)},{type:"posZ",dir:vec3.fromValues(0,0,1),up:vec3.fromValues(0,1,0),right:vec3.fromValues(1,0,0)},{type:"negZ",dir:vec3.fromValues(0,0,-1),up:vec3.fromValues(0,1,0),right:vec3.fromValues(-1,0,0)}];Texture.prototype.drawTo=function(h,c){function e(){6E4<=t.getTime()-this.time?(console.log("Buffer cleared"),a.deleteRenderbuffer(a._renderbuffers_pool[m]),delete a._renderbuffers_pool[m]):setTimeout(e.bind(this),6E4)}var a=
this.gl,b=a.getViewport(),d=t.getTime(),f=a.getParameter(a.FRAMEBUFFER_BINDING),k=a._framebuffer=a._framebuffer||a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,k);var l=null;if(Texture.use_renderbuffer_pool){a._renderbuffers_pool||(a._renderbuffers_pool={});var m=this.width+":"+this.height;a._renderbuffers_pool[m]?(l=a._renderbuffers_pool[m],l.time=d,a.bindRenderbuffer(a.RENDERBUFFER,l)):(a._renderbuffers_pool[m]=l=a.createRenderbuffer(),l.time=d,l.width=this.width,l.height=this.height,a.bindRenderbuffer(a.RENDERBUFFER,
l),setTimeout(e.bind(l),6E4))}else l=a._renderbuffer=a._renderbuffer||a.createRenderbuffer(),l.width=this.width,l.height=this.height,a.bindRenderbuffer(a.RENDERBUFFER,l);this.format===a.DEPTH_COMPONENT?a.renderbufferStorage(a.RENDERBUFFER,a.RGBA4,this.width,this.height):a.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_COMPONENT16,this.width,this.height);a.viewport(0,0,this.width,this.height);a._current_texture_drawto=this;a._current_fbo_color=k;a._current_fbo_depth=l;if(this.texture_type==a.TEXTURE_2D)this.format!==
a.DEPTH_COMPONENT?(a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,this.handler,0),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.RENDERBUFFER,l)):(a.framebufferRenderbuffer(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.RENDERBUFFER,l),a.framebufferTexture2D(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.TEXTURE_2D,this.handler,0)),h(this,c);else if(this.texture_type==a.TEXTURE_CUBE_MAP)for(this.format!==a.DEPTH_COMPONENT?a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.RENDERBUFFER,
l):a.framebufferRenderbuffer(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.RENDERBUFFER,l),d=0;6>d;d++)this.format!==a.DEPTH_COMPONENT?a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_CUBE_MAP_POSITIVE_X+d,this.handler,0):a.framebufferTexture2D(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.TEXTURE_CUBE_MAP_POSITIVE_X+d,this.handler,0),h(this,d,c);this.data=null;a._current_texture_drawto=null;a._current_fbo_color=null;a._current_fbo_depth=null;a.bindFramebuffer(a.FRAMEBUFFER,f);a.bindRenderbuffer(a.RENDERBUFFER,
null);a.viewport(b[0],b[1],b[2],b[3]);return this};Texture.drawTo=function(h,c,e){var a=-1,b=-1,d=null;if(!h&&!e)throw"Textures missing in drawTo";if(h&&h.length)for(var f=0;f<h.length;f++){var k=h[f];if(-1==a)a=k.width;else if(a!=k.width)throw"Cannot use Texture.drawTo if textures have different dimensions";if(-1==b)b=k.height;else if(b!=k.height)throw"Cannot use Texture.drawTo if textures have different dimensions";if(null==d)d=k.type;else if(d!=k.type)throw"Cannot use Texture.drawTo if textures have different data type, all must have the same type";
}else a=e.width,b=e.height;var l=gl.extensions.WEBGL_draw_buffers;if(!l&&h&&1<h.length)throw"Rendering to several textures not supported";d=gl.getViewport();gl._framebuffer=gl._framebuffer||gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,gl._framebuffer);gl.viewport(0,0,a,b);f=null;if(e&&e.format!==gl.DEPTH_COMPONENT||e.type!=gl.UNSIGNED_INT)throw"Depth texture must be of format: gl.DEPTH_COMPONENT and type: gl.UNSIGNED_INT";e?gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.TEXTURE_2D,
e.handler,0):(f=gl._renderbuffer=gl._renderbuffer||gl.createRenderbuffer(),f.width=a,f.height=b,gl.bindRenderbuffer(gl.RENDERBUFFER,f),gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,a,b),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,f));if(h){a=[];for(f=0;f<h.length;f++)k=h[f],gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0+f,gl.TEXTURE_2D,k.handler,0),a.push(gl.COLOR_ATTACHMENT0+f);1<h.length&&l.drawBuffersWEBGL(a)}else e=this._color_renderbuffer=
this._color_renderbuffer||gl.createRenderbuffer(),e.width=a,e.height=b,gl.bindRenderbuffer(gl.RENDERBUFFER,e),gl.renderbufferStorage(gl.RENDERBUFFER,gl.RGBA4,a,b),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.RENDERBUFFER,e);a=gl.checkFramebufferStatus(gl.FRAMEBUFFER);if(a!==gl.FRAMEBUFFER_COMPLETE)throw"FBO not complete: "+a;c();if(h.length)for(f=0;f<h.length;++f)h[f].data=null;gl.bindFramebuffer(gl.FRAMEBUFFER,null);gl.viewport(d[0],d[1],d[2],d[3])};Texture.drawToColorAndDepth=
function(h,c,e){var a=h.gl;if(c.width!=h.width||c.height!=h.height)throw"Different size between color texture and depth texture";var b=a.getViewport();a._framebuffer=a._framebuffer||a.createFramebuffer();a.bindFramebuffer(a.FRAMEBUFFER,a._framebuffer);a.viewport(0,0,h.width,h.height);a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,h.handler,0);a.framebufferTexture2D(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.TEXTURE_2D,c.handler,0);e();h.data=null;c.data=null;a.bindFramebuffer(a.FRAMEBUFFER,
null);a.viewport(b[0],b[1],b[2],b[3])};Texture.prototype.copyTo=function(h,c,e){var a=this.gl,b=a.getParameter(a.FRAMEBUFFER_BINDING),d=a.getViewport();c||=this.texture_type==a.TEXTURE_2D?t.Shader.getScreenShader():t.Shader.getCubemapCopyShader();a.disable(a.BLEND);a.disable(a.DEPTH_TEST);c&&e&&c.uniforms(e);(e=a.__copy_fbo)||(e=a.__copy_fbo=a.createFramebuffer());a.bindFramebuffer(a.FRAMEBUFFER,e);a.viewport(0,0,h.width,h.height);if(this.texture_type==a.TEXTURE_2D)a.framebufferTexture2D(a.FRAMEBUFFER,
a.COLOR_ATTACHMENT0,a.TEXTURE_2D,h.handler,0),this.toViewport(c);else if(this.texture_type==a.TEXTURE_CUBE_MAP){c.uniforms({u_texture:0});e=t.temp_mat3;for(var f=0;6>f;f++){a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_CUBE_MAP_POSITIVE_X+f,h.handler,0);var k=t.Texture.cubemap_camera_parameters[f];mat3.identity(e);e.set(k.right,0);e.set(k.up,3);e.set(k.dir,6);this.toViewport(c,{u_rotation:e})}}a.setViewport(d);a.bindFramebuffer(a.FRAMEBUFFER,b);h.minFilter&&h.minFilter!=a.NEAREST&&
h.minFilter!=a.LINEAR&&(h.bind(),a.generateMipmap(h.texture_type),h.has_mipmaps=!0);h.data=null;a.bindTexture(h.texture_type,null);return this};Texture.prototype.toViewport=function(h,c){h=h||Shader.getScreenShader();var e=Mesh.getScreenQuad();this.bind(0);c&&h.uniforms(c);h.draw(e,gl.TRIANGLES)};Texture.prototype.fill=function(h){var c=gl.getParameter(gl.COLOR_CLEAR_VALUE);gl.clearColor(h[0],h[1],h[2],h[3]);this.drawTo(function(){gl.clear(gl.COLOR_BUFFER_BIT)});gl.clearColor(c[0],c[1],c[2],c[3])};
Texture.prototype.renderQuad=function(){var h=mat3.create(),c=vec2.create(),e=vec2.create(),a=vec4.fromValues(1,1,1,1);return function(b,d,f,k,l,m){c[0]=b;c[1]=d;e[0]=f;e[1]=k;l=l||Shader.getQuadShader(this.gl);b=Mesh.getScreenQuad(this.gl);this.bind(0);l.uniforms({u_texture:0,u_position:c,u_color:a,u_size:e,u_viewport:gl.viewport_data.subarray(2,4),u_transform:h});m&&l.uniforms(m);l.draw(b,gl.TRIANGLES)}}();Texture.prototype.applyBlur=function(h,c,e,a,b){var d=this.gl;void 0===h&&(h=1);void 0===
c&&(c=1);h/=this.width;c/=this.height;d.disable(d.DEPTH_TEST);d.disable(d.BLEND);if(this===b&&this.texture_type===d.TEXTURE_CUBE_MAP)throw"cannot use applyBlur in a texture with itself when blurring a CUBE_MAP";if(b&&this.texture_type!==b.texture_type)throw"cannot use applyBlur with textures of different texture_type";var f=null,k=d.getParameter(d.FRAMEBUFFER_BINDING),l=d.getViewport(),m=d.__copy_fbo;m||=d.__copy_fbo=d.createFramebuffer();d.bindFramebuffer(d.FRAMEBUFFER,m);d.viewport(0,0,this.width,
this.height);if(this.texture_type===d.TEXTURE_2D)f=t.Shader.getBlurShader(),a||=new t.Texture(this.width,this.height,this.getProperties()),d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_2D,a.handler,0),this.toViewport(f,{u_texture:0,u_intensity:e,u_offset:[0,c]}),b=b||this,d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_2D,b.handler,0),a.toViewport(f,{u_intensity:e,u_offset:[h,0]}),f=a;else if(this.texture_type===d.TEXTURE_CUBE_MAP){f=t.Shader.getCubemapBlurShader();
f.uniforms({u_texture:0,u_intensity:e,u_offset:[h,c]});this.bind(0);h=Mesh.getScreenQuad();h.bindBuffers(f);f.bind();b||=new t.Texture(this.width,this.height,this.getProperties());c=t.temp_mat3;for(e=0;6>e;++e)d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_CUBE_MAP_POSITIVE_X+e,b.handler,0),a=t.Texture.cubemap_camera_parameters[e],mat3.identity(c),c.set(a.right,0),c.set(a.up,3),c.set(a.dir,6),f._setUniform("u_rotation",c),d.drawArrays(d.TRIANGLES,0,6);h.unbindBuffers(f);f=b}d.setViewport(l);
d.bindFramebuffer(d.FRAMEBUFFER,k);b.data=null;b.minFilter&&b.minFilter!=d.NEAREST&&b.minFilter!=d.LINEAR&&(b.bind(),d.generateMipmap(b.texture_type),b.has_mipmaps=!0);d.bindTexture(b.texture_type,null);return f};Texture.fromURL=function(h,c,e,a){a=a||K.gl;c=c||{};c=Object.create(c);var b=c.texture||new t.Texture(1,1,c,a);64>h.length&&(b.url=h);b.bind();var d=c.temp_color||Texture.loading_color;a.pixelStorei(a.UNPACK_ALIGNMENT,4);d=c.type==a.FLOAT?new Float32Array(d):new Uint8Array(d);a.texImage2D(a.TEXTURE_2D,
0,b.format,b.width,b.height,0,b.format,b.type,d);a.bindTexture(b.texture_type,null);b.ready=!1;if(-1!=h.toLowerCase().indexOf(".dds")){d=a.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc")||a.getExtension("WEBGL_compressed_texture_s3tc");var f=new t.Texture(0,0,c,a);la.loadDDSTextureEx(a,d,h,f.handler,!0,function(k){b.texture_type=k.texture_type;b.handler=k;delete b.ready;e&&e(b,h)})}else a=new Image,a.src=h,a.onload=function(){c.texture=b;t.Texture.fromImage(this,c);delete b.ready;e&&e(b,h)},
a.onerror=function(){e&&e(null)};return b};Texture.fromImage=function(h,c){c=c||{};var e=c.texture||new t.Texture(h.width,h.height,c);e.uploadImage(h,c);e.bind();gl.texParameteri(e.texture_type,gl.TEXTURE_MAG_FILTER,e.magFilter);gl.texParameteri(e.texture_type,gl.TEXTURE_MIN_FILTER,e.minFilter);gl.texParameteri(e.texture_type,gl.TEXTURE_WRAP_S,e.wrapS);gl.texParameteri(e.texture_type,gl.TEXTURE_WRAP_T,e.wrapT);t.isPowerOfTwo(e.width)&&t.isPowerOfTwo(e.height)&&c.minFilter&&c.minFilter!=gl.NEAREST&&
c.minFilter!=gl.LINEAR&&(e.bind(),gl.generateMipmap(e.texture_type),e.has_mipmaps=!0);gl.bindTexture(e.texture_type,null);e.data=h;c.keep_image&&(e.img=h);return e};Texture.fromVideo=function(h,c){c=c||{};var e=c.texture||new t.Texture(h.videoWidth,h.videoHeight,c);e.bind();e.uploadImage(h,c);c.minFilter&&c.minFilter!=gl.NEAREST&&c.minFilter!=gl.LINEAR&&(e.bind(),gl.generateMipmap(e.texture_type),e.has_mipmaps=!0,e.data=h);gl.bindTexture(e.texture_type,null);return e};Texture.fromTexture=function(h,
c){c=c||{};c=new t.Texture(h.width,h.height,c);h.copyTo(c);return c};Texture.prototype.clone=function(h){var c=this.getProperties();if(h)for(var e in h)c[e]=h[e];return Texture.fromTexture(this,c)};Texture.fromMemory=function(h,c,e,a){a=a||{};var b=a.texture||new t.Texture(h,c,a);Texture.setUploadOptions(a);b.bind();try{gl.texImage2D(gl.TEXTURE_2D,0,b.format,h,c,0,b.format,b.type,e),b.data=e}catch(d){if("file:"==location.protocol)throw'image not loaded for security reasons (serve this page over "http://" instead)';
throw"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)";}a.minFilter&&a.minFilter!=gl.NEAREST&&a.minFilter!=gl.LINEAR&&(gl.generateMipmap(gl.TEXTURE_2D),b.has_mipmaps=!0);gl.bindTexture(b.texture_type,null);return b};Texture.fromDDSInMemory=function(h,c){c=c||{};var e=c.texture||new t.Texture(0,0,c);t.Texture.setUploadOptions(c);e.bind();c=gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc")||gl.getExtension("WEBGL_compressed_texture_s3tc");
la.loadDDSTextureFromMemoryEx(gl,c,h,e,!0);gl.bindTexture(e.texture_type,null);return e};Texture.fromShader=function(h,c,e,a){a=a||{};h=new t.Texture(h,c,a);h.drawTo(function(){gl.disable(gl.BLEND);gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);var b=Mesh.getScreenQuad();e.draw(b)});return h};Texture.cubemapFromImages=function(h,c){c=c||{};if(6!=h.length)throw"missing images to create cubemap";var e=h[0].width,a=h[0].height;c.texture_type=gl.TEXTURE_CUBE_MAP;var b=null;c.texture?(b=c.texture,
b.width=e,b.height=a):b=new t.Texture(e,a,c);Texture.setUploadOptions(c);b.bind();try{for(e=0;6>e;e++)gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,b.format,b.format,b.type,h[e]);b.data=h}catch(d){if("file:"==location.protocol)throw'image not loaded for security reasons (serve this page over "http://" instead)';throw"image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)";}c.minFilter&&c.minFilter!=gl.NEAREST&&c.minFilter!=
gl.LINEAR&&(gl.generateMipmap(gl.TEXTURE_CUBE_MAP),b.has_mipmaps=!0);b.unbind();return b};Texture.cubemapFromImage=function(h,c){c=c||{};if(h.width!=h.height/6&&0!=h.height%6&&!c.faces)return console.error("Cubemap image not valid, only 1x6 (vertical) or 6x3 (cross) formats. Check size:",h.width,h.height),null;var e=h.width,a=h.height;void 0!==c.is_cross?(c.faces=Texture.generateCubemapCrossFacesInfo(h.width,c.is_cross),e=a=h.width/4):c.faces?(e=c.width||c.faces[0].width,a=c.height||c.faces[0].height):
a/=6;if(e!=a)return console.log("Texture not valid, width and height for every face must be square"),null;var b=e;c.no_flip=!0;for(var d=[],f=0;6>f;f++){var k=createCanvas(b,b),l=k.getContext("2d");c.faces?l.drawImage(h,c.faces[f].x,c.faces[f].y,c.faces[f].width||b,c.faces[f].height||b,0,0,b,b):l.drawImage(h,0,a*f,e,a,0,0,b,b);d.push(k)}e=Texture.cubemapFromImages(d,c);c.keep_image&&(e.img=h);return e};Texture.generateCubemapCrossFacesInfo=function(h,c){void 0===c&&(c=1);h/=4;return[{x:2*h,y:h,width:h,
height:h},{x:0,y:h,width:h,height:h},{x:c*h,y:0,width:h,height:h},{x:c*h,y:2*h,width:h,height:h},{x:h,y:h,width:h,height:h},{x:3*h,y:h,width:h,height:h}]};Texture.cubemapFromURL=function(h,c,e){c=c||{};c.texture_type=gl.TEXTURE_CUBE_MAP;var a=c.texture||new t.Texture(1,1,c);c=Object.create(c);a.bind();Texture.setUploadOptions(c);var b=c.temp_color||[0,0,0,255];b=c.type==gl.FLOAT?new Float32Array(b):new Uint8Array(b);for(var d=0;6>d;d++)gl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X+d,0,a.format,1,1,
0,a.format,a.type,b);gl.bindTexture(a.texture_type,null);a.ready=!1;b=new Image;b.src=h;b.onload=function(){c.texture=a;(a=t.Texture.cubemapFromImage(this,c))&&delete a.ready;e&&e(a)};return a};Texture.prototype.getPixels=function(h,c,e){c=this.gl;var a=c.getViewport(),b=c.getParameter(c.FRAMEBUFFER_BINDING);h=h||this.type;if(this.format==c.DEPTH_COMPONENT)throw"cannot use getPixels in depth textures";c.disable(c.DEPTH_TEST);var d=c.__copy_fbo;d||=c.__copy_fbo=c.createFramebuffer();c.bindFramebuffer(c.FRAMEBUFFER,
d);c.viewport(0,0,this.width,this.height);this.texture_type==c.TEXTURE_2D?c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_2D,this.handler,0):this.texture_type==c.TEXTURE_CUBE_MAP&&c.framebufferTexture2D(c.FRAMEBUFFER,c.COLOR_ATTACHMENT0,c.TEXTURE_CUBE_MAP_POSITIVE_X+(e||0),this.handler,0);e=4;d=h==c.UNSIGNED_BYTE?new Uint8Array(this.width*this.height*e):new Float32Array(this.width*this.height*e);c.readPixels(0,0,this.width,this.height,3==e?c.RGB:c.RGBA,h,d);c.bindFramebuffer(c.FRAMEBUFFER,
b);c.viewport(a[0],a[1],a[2],a[3]);return d};Texture.prototype.toCanvas=function(h,c,e){e=e||8192;var a=this.gl,b=Math.min(this.width,e),d=Math.min(this.height,e);this.texture_type==a.TEXTURE_CUBE_MAP&&(b*=4,d*=3);h=h||createCanvas(b,d);h.width!=b&&(h.width=b);h.height!=d&&(h.height=d);var f=null;if(this.texture_type==a.TEXTURE_2D){this.width!=b||this.height!=d?(f=new t.Texture(b,d,{format:a.RGBA,filter:a.NEAREST}),this.copyTo(f),f=f.getPixels(a.UNSIGNED_BYTE,!0)):f=this.getPixels(a.UNSIGNED_BYTE,
!0);e=h.getContext("2d");var k=e.getImageData(0,0,b,d);k.data.set(f);e.putImageData(k,0,0);c&&(f=createCanvas(b,d),c=f.getContext("2d"),c.translate(0,f.height),c.scale(1,-1),c.drawImage(h,0,0,f.width,f.height),e.drawImage(f,0,0))}else if(this.texture_type==a.TEXTURE_CUBE_MAP){b=createCanvas(this.width,this.height);c=b.getContext("2d");d=t.Texture.generateCubemapCrossFacesInfo(h.width,1);e=h.getContext("2d");e.fillStyle="black";e.fillRect(0,0,h.width,h.height);for(var l=0;6>l;l++)f=this.getPixels(a.UNSIGNED_BYTE,
!0,l),k=c.getImageData(0,0,b.width,b.height),k.data.set(f),c.putImageData(k,0,0),e.drawImage(b,d[l].x,d[l].y,b.width,b.height)}return h};Texture.prototype.toBlob=function(h,c){h=this.toCanvas(null,h).toDataURL(c);var e=h.indexOf(",");h=h.substr(e+1);h=atob(h);e=h.length;for(var a=new Uint8Array(e),b=0;b<e;++b)a[b]=h.charCodeAt(b);return new Blob([a],{type:c||"image/png"})};Texture.prototype.toBlobAsync=function(h,c,e){var a=this.toCanvas(null,h);a.toBlob?a.toBlob(e,c):(h=this.toBlob(h,c),e&&e(h))};
Texture.prototype.toBase64=function(h){var c=this.width,e=this.height,a=this.getPixels(),b=createCanvas(c,e),d=b.getContext("2d"),f=d.getImageData(0,0,c,e);f.data.set(a);d.putImageData(f,0,0);h&&(h=createCanvas(c,e),c=h.getContext("2d"),c.translate(0,e),c.scale(1,-1),c.drawImage(b,0,0),b=h);return b.toDataURL("image/png")};Texture.prototype.generateMetadata=function(){var h={};h.width=this.width;h.height=this.height;this.metadata=h};Texture.compareFormats=function(h,c){return h&&c?h==c?!0:h.width!=
c.width||h.height!=c.height||h.type!=c.type||h.format!=c.format||h.texture_type!=c.texture_type?!1:!0:!1};Texture.blend=function(h,c,e,a){if(!h||!c)return!1;if(h==c)return a?h.copyTo(a):h.toViewport(),!0;gl.disable(gl.BLEND);gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);var b=t.Shader.getBlendShader(),d=t.Mesh.getScreenQuad();c.bind(1);b.uniforms({u_texture:0,u_texture2:1,u_factor:e});if(a)return a.drawTo(function(){if(h==a||c==a)throw"Blend output cannot be the same as the input";h.bind(0);
b.draw(d,gl.TRIANGLES)}),!0;h.bind(0);b.draw(d,gl.TRIANGLES);return!0};Texture.getWhiteTexture=function(h){h=h||K.gl;var c=h.textures[":white"];if(c)return c;c=new Uint8Array([255,255,255,255]);return h.textures[":white"]=new t.Texture(1,1,{pixel_data:c})};Texture.getBlackTexture=function(h){h=h||K.gl;var c=h.textures[":black"];if(c)return c;c=new Uint8Array([0,0,0,255]);return h.textures[":black"]=new t.Texture(1,1,{pixel_data:c})};Texture.getTemporary=function(h,c,e){Texture.temporary_pool||(Texture.temporary_pool=
[]);var a=Texture.temporary_pool,b=t.TEXTURE_2D,d=Texture.DEFAULT_TYPE,f=Texture.DEFAULT_FORMAT;e&&(e.texture_type&&(b=e.texture_type),e.type&&(d=e.type),e.format&&(f=e.format));for(e=0;e<a.length;++e){var k=a[e];if(k.width==h&&k.height==c&&k.type==d&&k.texture_type==b&&k.format==f)return a.splice(e,1),k}return new t.Texture(h,c,{type:d,texture_type:b,format:f})};Texture.releaseTemporary=function(h){Texture.temporary_pool||(Texture.temporary_pool=[]);Texture.temporary_pool.push(h)};Texture.nextPOT=
function(h){return Math.pow(2,Math.ceil(Math.log(h)/Math.log(2)))};t.FBO=fa;fa.prototype.setTextures=function(h,c,e){if(c&&(c.format!==gl.DEPTH_COMPONENT||c.type!=gl.UNSIGNED_INT))throw"FBO Depth texture must be of format: gl.DEPTH_COMPONENT and type: gl.UNSIGNED_INT";var a=this.depth_texture==c;if(a&&h)if(h.length==this.color_textures.length)for(var b=0;b<h.length;++b){if(h[b]!=this.color_textures[b]){a=!1;break}}else a=!1;this._stencil_enabled!==this.stencil&&(a=!1);if(!a){this.color_textures.length=
h?h.length:0;if(h)for(b=0;b<h.length;++b)this.color_textures[b]=h[b];this.depth_texture=c;this.update(e)}};fa.prototype.update=function(h){this._old_fbo=gl.getParameter(gl.FRAMEBUFFER_BINDING);this.handler||(this.handler=gl.createFramebuffer());var c=-1,e=-1,a=null,b=this.color_textures,d=this.depth_texture;if(b&&b.length)for(var f=0;f<b.length;f++){var k=b[f];if(-1==c)c=k.width;else if(c!=k.width)throw"Cannot bind textures with different dimensions";if(-1==e)e=k.height;else if(e!=k.height)throw"Cannot bind textures with different dimensions";
if(null==a)a=k.type;else if(a!=k.type)throw"Cannot bind textures to a FBO with different pixel formats";if(k.texture_type!=gl.TEXTURE_2D)throw"Cannot bind a Cubemap to a FBO";}else c=d.width,e=d.height;this.width=c;this.height=e;gl.bindFramebuffer(gl.FRAMEBUFFER,this.handler);if(d&&!gl.extensions.WEBGL_depth_texture)throw"Rendering to depth texture not supported by your browser";a=gl.extensions.WEBGL_draw_buffers;if(!a&&b&&1<b.length)throw"Rendering to several textures not supported by your browser";
d?gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.TEXTURE_2D,d.handler,0):(f=this._renderbuffer=this._renderbuffer||gl.createRenderbuffer(),f.width=c,f.height=e,gl.bindRenderbuffer(gl.RENDERBUFFER,f),gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_COMPONENT16,c,e),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,f));if(b&&b.length)for(this.order=[],f=0;f<b.length;f++)k=b[f],gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0+f,gl.TEXTURE_2D,k.handler,
0),this.order.push(gl.COLOR_ATTACHMENT0+f);else f=this._renderbuffer=this._renderbuffer||gl.createRenderbuffer(),f.width=c,f.height=e,gl.bindRenderbuffer(gl.RENDERBUFFER,f),gl.renderbufferStorage(gl.RENDERBUFFER,gl.RGBA4,c,e),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.RENDERBUFFER,f);for(f=d=b?b.length:0;f<this._num_binded_textures;++f)gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0+f,gl.TEXTURE_2D,null,0);this._num_binded_textures=d;this.stencil?(f=this._stencil_buffer=
this._stencil_buffer||gl.createRenderbuffer(),gl.bindRenderbuffer(gl.RENDERBUFFER,f),gl.renderbufferStorage(gl.RENDERBUFFER,gl.STENCIL_INDEX8,c,e),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.STENCIL_ATTACHMENT,gl.RENDERBUFFER,f),this._stencil_enabled=!0):this._stencil_enabled=!1;b&&1<b.length&&a.drawBuffersWEBGL(this.order);c=gl.checkFramebufferStatus(gl.FRAMEBUFFER);if(c!==gl.FRAMEBUFFER_COMPLETE)throw"FBO not complete: "+c;gl.bindTexture(gl.TEXTURE_2D,null);gl.bindRenderbuffer(gl.RENDERBUFFER,
null);h||gl.bindFramebuffer(gl.FRAMEBUFFER,this._old_fbo)};fa.prototype.bind=function(h){if(!this.color_textures.length&&!this.depth_texture)throw"FBO: no textures attached to FBO";this._old_viewport.set(gl.viewport_data);this._old_fbo=h?gl.getParameter(gl.FRAMEBUFFER_BINDING):null;this._old_fbo!=this.handler&&gl.bindFramebuffer(gl.FRAMEBUFFER,this.handler);gl.viewport(0,0,this.width,this.height)};fa.prototype.unbind=function(){gl.bindFramebuffer(gl.FRAMEBUFFER,this._old_fbo);this._old_fbo=null;gl.setViewport(this._old_viewport)};
K.Shader=t.Shader=function b(c,e,a){t.debug&&console.log("GL.Shader created");this._context_id=K.gl.context_id;var d=this.gl=K.gl;a=b.expandMacros(a);this.program=d.createProgram();c=c.constructor===String?t.Shader.compileSource(d.VERTEX_SHADER,a+c):c;e=e.constructor===String?t.Shader.compileSource(d.FRAGMENT_SHADER,a+e):e;d.attachShader(this.program,c,d);d.attachShader(this.program,e,d);d.linkProgram(this.program);if(!d.getProgramParameter(this.program,d.LINK_STATUS))throw"link error: "+d.getProgramInfoLog(this.program);
this.vs_shader=c;this.fs_shader=e;this.attributes={};this.uniformInfo={};this.samplers={};this.extractShaderInfo()};Shader.expandMacros=function(c){var e="";if(c)for(var a in c)e+="#define "+a+" "+(c[a]?c[a]:"")+"\n";return e};Shader.compileSource=function(c,e,a,b){a=a||K.gl;b=b||a.createShader(c);a.shaderSource(b,e);a.compileShader(b);if(!a.getShaderParameter(b,a.COMPILE_STATUS))throw(c==a.VERTEX_SHADER?"Vertex":"Fragment")+" shader compile error: "+a.getShaderInfoLog(b);return b};Shader.prototype.updateShader=
function(c,e,a){var b=this.gl||K.gl;a=Shader.expandMacros(a);this.program&&(this.program=b.createProgram());c=c.constructor===String?t.Shader.compileSource(b.VERTEX_SHADER,a+c,b,this.vs_shader):c;e=e.constructor===String?t.Shader.compileSource(b.FRAGMENT_SHADER,a+e,b,this.fs_shader):e;b.attachShader(this.program,c,b);b.attachShader(this.program,e,b);b.linkProgram(this.program);if(!b.getProgramParameter(this.program,b.LINK_STATUS))throw"link error: "+b.getProgramInfoLog(this.program);this.vs_shader=
c;this.fs_shader=e;this.attributes={};this.uniformInfo={};this.samplers={};this.extractShaderInfo()};Shader.prototype.extractShaderInfo=function(){for(var c=this.gl,e=c.getProgramParameter(this.program,c.ACTIVE_UNIFORMS),a=0;a<e;++a){var b=c.getActiveUniform(this.program,a);if(!b)break;var d=b.name,f=d.indexOf("[");-1!=f&&-1==d.indexOf("].")&&(d=d.substr(0,f));if(b.type==c.SAMPLER_2D||b.type==c.SAMPLER_CUBE)this.samplers[d]=b.type;f=Shader.getUniformFunc(b);var k=!1;if(b.type==c.FLOAT_MAT2||b.type==
c.FLOAT_MAT3||b.type==c.FLOAT_MAT4)k=!0;this.uniformInfo[d]={type:b.type,func:f,size:b.size,is_matrix:k,loc:c.getUniformLocation(this.program,d)}}a=0;for(e=c.getProgramParameter(this.program,c.ACTIVE_ATTRIBUTES);a<e;++a){b=c.getActiveAttrib(this.program,a);if(!b)break;f=Shader.getUniformFunc(b);this.uniformInfo[b.name]={type:b.type,func:f,size:b.size,loc:null};this.attributes[b.name]=c.getAttribLocation(this.program,b.name)}};Shader.prototype.hasUniform=function(c){return this.uniformInfo[c]};Shader.prototype.hasAttribute=
function(c){return this.attributes[c]};Shader.getUniformFunc=function(c){switch(c.type){case gl.FLOAT:c=1==c.size?gl.uniform1f:gl.uniform1fv;break;case gl.FLOAT_MAT2:c=gl.uniformMatrix2fv;break;case gl.FLOAT_MAT3:c=gl.uniformMatrix3fv;break;case gl.FLOAT_MAT4:c=gl.uniformMatrix4fv;break;case gl.FLOAT_VEC2:c=gl.uniform2fv;break;case gl.FLOAT_VEC3:c=gl.uniform3fv;break;case gl.FLOAT_VEC4:c=gl.uniform4fv;break;case gl.UNSIGNED_INT:case gl.INT:c=1==c.size?gl.uniform1i:gl.uniform1iv;break;case gl.INT_VEC2:c=
gl.uniform2iv;break;case gl.INT_VEC3:c=gl.uniform3iv;break;case gl.INT_VEC4:c=gl.uniform4iv;break;case gl.SAMPLER_2D:case gl.SAMPLER_CUBE:c=gl.uniform1i;break;default:c=gl.uniform1f}return c};Shader.fromURL=function(c,e,a){function b(){var l=new t.Shader(f,k),m;for(m in l)d[m]=l[m];d.ready=!0}var d=new t.Shader("\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute mat4 u_mvp;\n\t\t\tvoid main() { \n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0); \n\t\t\t}\n\t\t","\n\t\t\tprecision highp float;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n\t\t\t}\n\t\t\t");
d.ready=!1;var f=null,k=null;HttpRequest(c,null,function(l){f=l;k&&b()});HttpRequest(e,null,function(l){k=l;f&&b()});return d};Shader.prototype.bind=function(){var c=this.gl;c.useProgram(this.program);c._current_shader=this};Shader.prototype.getLocation=function(c){return this.uniformInfo[c]?this.uniformInfo[c].loc:null};Shader._temp_uniform=new Float32Array(16);Shader.prototype.uniforms=function(c){var e=this.gl;e.useProgram(this.program);e._current_shader=this;for(var a in c)this.uniformInfo[a]&&
this._setUniform(a,c[a]);return this};Shader.prototype.uniformsArray=function(c){var e=this.gl;e.useProgram(this.program);e._current_shader=this;e=0;for(var a=c.length;e<a;++e){var b=c[e],d;for(d in b)this._setUniform(d,b[d])}return this};Shader.prototype.setUniform=function(c,e){this.gl._current_shader!=this&&this.bind();(c=this.uniformInfo[c])&&null!==c.loc&&null!=e&&(e.constructor===Array&&(e=new Float32Array(e)),c.is_matrix?c.func.call(this.gl,c.loc,!1,e):c.func.call(this.gl,c.loc,e))};Shader.prototype._setUniform=
function(c,e){(c=this.uniformInfo[c])&&null!==c.loc&&null!=e&&(e.constructor===Array&&(e=new Float32Array(e)),c.is_matrix?c.func.call(this.gl,c.loc,!1,e):c.func.call(this.gl,c.loc,e))};Shader.prototype.draw=function(c,e,a){a=void 0===a?e==gl.LINES?"lines":"triangles":a;this.drawBuffers(c.vertexBuffers,a?c.indexBuffers[a]:null,2>arguments.length?gl.TRIANGLES:e)};Shader.prototype.drawRange=function(c,e,a,b,d){d=void 0===d?e==gl.LINES?"lines":"triangles":d;this.drawBuffers(c.vertexBuffers,d?c.indexBuffers[d]:
null,e,a,b)};var z=new Uint8Array(16),pa=new Uint8Array(16);Shader.prototype.drawBuffers=function(c,e,a,b,d){if(0!=d){var f=this.gl;f.useProgram(this.program);var k=0;z.set(pa);for(var l in c){var m=c[l],q=m.attribute||l,n=this.attributes[q];null!=n&&m.buffer&&(z[n]=1,f.bindBuffer(f.ARRAY_BUFFER,m.buffer),f.enableVertexAttribArray(n),f.vertexAttribPointer(n,m.buffer.spacing,m.buffer.gl_type,!1,0,0),k=m.buffer.length/m.buffer.spacing)}c=0;0<b&&(c=b*(e&&e.data?e.data.constructor.BYTES_PER_ELEMENT:1));
0<d?k=d:e&&(k=e.buffer.length-c);for(q in this.attributes)n=this.attributes[q],z[n]||f.disableVertexAttribArray(this.attributes[q]);!k||e&&!e.buffer||(e?(f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,e.buffer),f.drawElements(a,k,e.buffer.gl_type,c),f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,null)):f.drawArrays(a,c,k));return this}};Shader.expandImports=function(c,e){e=e||Shader.files;var a={};if(!e)throw"Shader.files not initialized, assign files there";return c.replace(/#import\s+"([a-zA-Z0-9_\.]+)"\s*\n/g,function(b){b=
b.split('"')[1];if(a[b])return"//already imported: "+b+"\n";var d=e[b];a[b]=!0;return d?d+"\n":"//import code not found: "+b+"\n"})};Shader.dumpErrorToConsole=function(c,e,a){console.error(c);c=(-1!=c.indexOf("Fragment")?a:e).split("\n");for(var b in c)c[b]=b+"| "+c[b];console.groupCollapsed("Shader code");console.log(c.join("\n"));console.groupEnd()};Shader.validateValue=function(c,e){if(null===c||void 0===c)return!1;switch(e.type){case t.INT:case t.FLOAT:case t.SAMPLER_2D:case t.SAMPLER_CUBE:return isNumber(c);
case t.INT_VEC2:case t.FLOAT_VEC2:return 2===c.length;case t.INT_VEC3:case t.FLOAT_VEC3:return 3===c.length;case t.INT_VEC4:case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 4===c.length;case t.FLOAT_MAT3:return 8===c.length;case t.FLOAT_MAT4:return 16===c.length}return!0};Shader.SCREEN_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() { \n\t\t\t\tv_coord = a_coord; \n\t\t\t\tgl_Position = vec4(a_coord * 2.0 - 1.0, 0.0, 1.0); \n\t\t\t}\n\t\t\t";
Shader.SCREEN_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = texture2D(u_texture, v_coord);\n\t\t\t}\n\t\t\t";Shader.SCREEN_FRAGMENT_FX="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tvarying vec2 v_coord;\n\t\t\t#ifdef FX_UNIFORMS\n\t\t\t\tFX_UNIFORMS\n\t\t\t#endif\n\t\t\tvoid main() {\n\t\t\t\tvec2 uv = v_coord;\n\t\t\t\tvec4 color = texture2D(u_texture, uv);\n\t\t\t\t#ifdef FX_CODE\n\t\t\t\t\tFX_CODE ;\n\t\t\t\t#endif\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\n\t\t\t";
Shader.SCREEN_COLORED_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec4 u_color;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color * texture2D(u_texture, v_coord);\n\t\t\t}\n\t\t\t";Shader.BLEND_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform sampler2D u_texture2;\n\t\t\tuniform float u_factor;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = mix( texture2D(u_texture, v_coord), texture2D(u_texture2, v_coord), u_factor);\n\t\t\t}\n\t\t\t";
Shader.SCREEN_FLAT_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform vec4 u_color;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color;\n\t\t\t}\n\t\t\t";Shader.QUAD_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform vec2 u_position;\n\t\t\tuniform vec2 u_size;\n\t\t\tuniform vec2 u_viewport;\n\t\t\tuniform mat3 u_transform;\n\t\t\tvoid main() { \n\t\t\t\tvec3 pos = vec3(u_position + vec2(a_coord.x,1.0 - a_coord.y)  * u_size, 1.0);\n\t\t\t\tv_coord = a_coord; \n\t\t\t\tpos = u_transform * pos;\n\t\t\t\tpos.z = 0.0;\n\t\t\t\t//normalize\n\t\t\t\tpos.x = (2.0 * pos.x / u_viewport.x) - 1.0;\n\t\t\t\tpos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);\n\t\t\t\tgl_Position = vec4(pos, 1.0); \n\t\t\t}\n\t\t\t";
Shader.QUAD_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec4 u_color;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color * texture2D(u_texture, v_coord);\n\t\t\t}\n\t\t\t";Shader.QUAD2_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec4 u_color;\n\t\t\tuniform vec4 u_texture_area;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t    vec2 uv = vec2( mix(u_texture_area.x, u_texture_area.z, v_coord.x), 1.0 - mix(u_texture_area.w, u_texture_area.y, v_coord.y) );\n\t\t\t\tgl_FragColor = u_color * texture2D(u_texture, uv);\n\t\t\t}\n\t\t\t";
Shader.PRIMITIVE2D_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tuniform vec2 u_viewport;\n\t\t\tuniform mat3 u_transform;\n\t\t\tvoid main() { \n\t\t\t\tvec3 pos = a_vertex;\n\t\t\t\tpos = u_transform * pos;\n\t\t\t\tpos.z = 0.0;\n\t\t\t\t//normalize\n\t\t\t\tpos.x = (2.0 * pos.x / u_viewport.x) - 1.0;\n\t\t\t\tpos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);\n\t\t\t\tgl_Position = vec4(pos, 1.0); \n\t\t\t}\n\t\t\t";Shader.FLAT_VERTEX_SHADER="\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tuniform mat4 u_mvp;\n\t\t\tvoid main() { \n\t\t\t\tgl_Position = u_mvp * vec4(a_vertex,1.0); \n\t\t\t}\n\t\t\t";
Shader.FLAT_FRAGMENT_SHADER="\n\t\t\tprecision highp float;\n\t\t\tuniform vec4 u_color;\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = u_color;\n\t\t\t}\n\t\t\t";Shader.createFX=function(c,e,a){c={FX_CODE:c,FX_UNIFORMS:e||""};if(!a)return new t.Shader(t.Shader.SCREEN_VERTEX_SHADER,t.Shader.SCREEN_FRAGMENT_FX,c);a.updateShader(t.Shader.SCREEN_VERTEX_SHADER,t.Shader.SCREEN_FRAGMENT_FX,c);return a};Shader.prototype.toViewport=function(c){var e=t.Mesh.getScreenQuad();c&&this.uniforms(c);this.draw(e)};
Shader.getScreenShader=function(c){c=c||K.gl;var e=c.shaders[":screen"];if(e)return e;e=c.shaders[":screen"]=new t.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.SCREEN_FRAGMENT_SHADER);return e.uniforms({u_texture:0})};Shader.getColoredScreenShader=function(c){c=c||K.gl;var e=c.shaders[":colored_screen"];if(e)return e;e=c.shaders[":colored_screen"]=new t.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.SCREEN_COLORED_FRAGMENT_SHADER);return e.uniforms({u_texture:0,u_color:vec4.fromValues(1,1,1,1)})};Shader.getQuadShader=
function(c){c=c||K.gl;var e=c.shaders[":quad"];return e?e:c.shaders[":quad"]=new t.Shader(Shader.QUAD_VERTEX_SHADER,Shader.QUAD_FRAGMENT_SHADER)};Shader.getPartialQuadShader=function(c){c=c||K.gl;var e=c.shaders[":quad2"];return e?e:c.shaders[":quad2"]=new t.Shader(Shader.QUAD_VERTEX_SHADER,Shader.QUAD2_FRAGMENT_SHADER)};Shader.getBlendShader=function(c){c=c||K.gl;var e=c.shaders[":blend"];return e?e:c.shaders[":blend"]=new t.Shader(Shader.SCREEN_VERTEX_SHADER,Shader.BLEND_FRAGMENT_SHADER)};Shader.getBlurShader=
function(c){c=c||K.gl;var e=c.shaders[":blur"];if(e)return e;e=new t.Shader(Shader.SCREEN_VERTEX_SHADER,"\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec2 u_offset;\n\t\t\tuniform float u_intensity;\n\t\t\tvoid main() {\n\t\t\t   vec4 sum = vec4(0.0);\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -4.0) * 0.05/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -3.0) * 0.09/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -2.0) * 0.12/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * -1.0) * 0.15/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord) * 0.16/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 4.0) * 0.05/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 3.0) * 0.09/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 2.0) * 0.12/0.98;\n\t\t\t   sum += texture2D(u_texture, v_coord + u_offset * 1.0) * 0.15/0.98;\n\t\t\t   gl_FragColor = u_intensity * sum;\n\t\t\t}\n\t\t\t");
return c.shaders[":blur"]=e};Shader.getCubemapCopyShader=function(c){c=c||K.gl;var e=c.shaders[":copy_cubemap"];if(e)return e;e=new t.Shader(Shader.SCREEN_VERTEX_SHADER,"\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform samplerCube u_texture;\n\t\t\tuniform mat3 u_rotation;\n\t\t\tvoid main() {\n\t\t\t\tvec2 uv = vec2( v_coord.x, 1.0 - v_coord.y );\n\t\t\t\tvec3 dir = vec3( uv - vec2(0.5), 0.5 );\n\t\t\t\tdir = u_rotation * dir;\n\t\t\t   gl_FragColor = textureCube( u_texture, dir );\n\t\t\t}\n\t\t\t");
return c.shaders[":copy_cubemap"]=e};Shader.getCubemapBlurShader=function(c){c=c||K.gl;var e=c.shaders[":blur_cubemap"];if(e)return e;e=new t.Shader(Shader.SCREEN_VERTEX_SHADER,"\n\t\t\t#ifndef NUM_SAMPLES\n\t\t\t\t#define NUM_SAMPLES 4\n\t\t\t#endif\n\t\t\t\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform samplerCube u_texture;\n\t\t\tuniform mat3 u_rotation;\n\t\t\tuniform vec2 u_offset;\n\t\t\tuniform float u_intensity;\n\t\t\tvoid main() {\n\t\t\t\tvec4 sum = vec4(0.0);\n\t\t\t\tvec2 uv = vec2( v_coord.x, 1.0 - v_coord.y ) - vec2(0.5);\n\t\t\t\tvec3 dir = vec3(0.0);\n\t\t\t\tvec4 color = vec4(0.0);\n\t\t\t\tfor( int x = -2; x <= 2; x++ )\n\t\t\t\t{\n\t\t\t\t\tfor( int y = -2; y <= 2; y++ )\n\t\t\t\t\t{\n\t\t\t\t\t\tdir.xy = uv + vec2( u_offset.x * float(x), u_offset.y * float(y)) * 0.5;\n\t\t\t\t\t\tdir.z = 0.5;\n\t\t\t\t\t\tdir = u_rotation * dir;\n\t\t\t\t\t\tcolor = textureCube( u_texture, dir );\n\t\t\t\t\t\tcolor.xyz = color.xyz * color.xyz;/*linearize*/\n\t\t\t\t\t\tsum += color;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tsum /= 25.0;\n\t\t\t   gl_FragColor = vec4( sqrt( sum.xyz ), sum.w ) ;\n\t\t\t}\n\t\t\t");
return c.shaders[":blur_cubemap"]=e};Shader.FXAA_FUNC="\n\tuniform vec2 u_viewportSize;\n\tuniform vec2 u_iViewportSize;\n\t#define FXAA_REDUCE_MIN   (1.0/ 128.0)\n\t#define FXAA_REDUCE_MUL   (1.0 / 8.0)\n\t#define FXAA_SPAN_MAX     8.0\n\t\n\t/* from mitsuhiko/webgl-meincraft based on the code on geeks3d.com */\n\tvec4 applyFXAA(sampler2D tex, vec2 fragCoord)\n\t{\n\t\tvec4 color = vec4(0.0);\n\t\t/*vec2 u_iViewportSize = vec2(1.0 / u_viewportSize.x, 1.0 / u_viewportSize.y);*/\n\t\tvec3 rgbNW = texture2D(tex, (fragCoord + vec2(-1.0, -1.0)) * u_iViewportSize).xyz;\n\t\tvec3 rgbNE = texture2D(tex, (fragCoord + vec2(1.0, -1.0)) * u_iViewportSize).xyz;\n\t\tvec3 rgbSW = texture2D(tex, (fragCoord + vec2(-1.0, 1.0)) * u_iViewportSize).xyz;\n\t\tvec3 rgbSE = texture2D(tex, (fragCoord + vec2(1.0, 1.0)) * u_iViewportSize).xyz;\n\t\tvec3 rgbM  = texture2D(tex, fragCoord  * u_iViewportSize).xyz;\n\t\tvec3 luma = vec3(0.299, 0.587, 0.114);\n\t\tfloat lumaNW = dot(rgbNW, luma);\n\t\tfloat lumaNE = dot(rgbNE, luma);\n\t\tfloat lumaSW = dot(rgbSW, luma);\n\t\tfloat lumaSE = dot(rgbSE, luma);\n\t\tfloat lumaM  = dot(rgbM,  luma);\n\t\tfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\n\t\tfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\n\t\t\n\t\tvec2 dir;\n\t\tdir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\n\t\tdir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\n\t\t\n\t\tfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);\n\t\t\n\t\tfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\n\t\tdir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX), max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), dir * rcpDirMin)) * u_iViewportSize;\n\t\t\n\t\tvec3 rgbA = 0.5 * (texture2D(tex, fragCoord * u_iViewportSize + dir * (1.0 / 3.0 - 0.5)).xyz + \n\t\t\ttexture2D(tex, fragCoord * u_iViewportSize + dir * (2.0 / 3.0 - 0.5)).xyz);\n\t\tvec3 rgbB = rgbA * 0.5 + 0.25 * (texture2D(tex, fragCoord * u_iViewportSize + dir * -0.5).xyz + \n\t\t\ttexture2D(tex, fragCoord * u_iViewportSize + dir * 0.5).xyz);\n\t\t\n\t\treturn vec4(rgbA,1.0);\n\t\tfloat lumaB = dot(rgbB, luma);\n\t\tif ((lumaB < lumaMin) || (lumaB > lumaMax))\n\t\t\tcolor = vec4(rgbA, 1.0);\n\t\telse\n\t\t\tcolor = vec4(rgbB, 1.0);\n\t\treturn color;\n\t}\n";
Shader.getFXAAShader=function(c){c=c||K.gl;var e=c.shaders[":fxaa"];if(e)return e;e=new t.Shader(Shader.SCREEN_VERTEX_SHADER,"\n\t\t\tprecision highp float;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform sampler2D u_texture;\n\t\t\t"+Shader.FXAA_FUNC+"\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t   gl_FragColor = applyFXAA( u_texture, v_coord * u_viewportSize) ;\n\t\t\t}\n\t\t\t");var a=vec2.fromValues(c.viewport_data[2],c.viewport_data[3]),b=vec2.fromValues(1/c.viewport_data[2],1/c.viewport_data[3]);e.setup=
function(){a[0]=c.viewport_data[2];a[1]=c.viewport_data[3];b[0]=1/c.viewport_data[2];b[1]=1/c.viewport_data[3];this.uniforms({u_viewportSize:a,u_iViewportSize:b})};return c.shaders[":fxaa"]=e};Shader.getFlatShader=function(c){c=c||K.gl;var e=c.shaders[":flat"];if(e)return e;e=new t.Shader(Shader.FLAT_VERTEX_SHADER,Shader.FLAT_FRAGMENT_SHADER);e.uniforms({u_color:[1,1,1,1]});return c.shaders[":flat"]=e};t.create=function(c){function e(n){var p=f.mouse.buttons;t.augmentEvent(n,d);n.eventType=n.eventType||
n.type;var x=getTime();l.dragging=n.dragging;l.position[0]=n.canvasx;l.position[1]=n.canvasy;l.x=n.canvasx;l.y=n.canvasy;l.clientx=n.mousex;l.clienty=n.mousey;l.left_button=l.buttons&1<<t.LEFT_MOUSE_BUTTON;l.middle_button=l.buttons&1<<t.MIDDLE_MOUSE_BUTTON;l.right_button=l.buttons&1<<t.RIGHT_MOUSE_BUTTON;if("mousedown"==n.eventType){0==p&&(d.removeEventListener("mousemove",e),p=d.ownerDocument,p.addEventListener("mousemove",e),p.addEventListener("mouseup",e));k=x;if(f.onmousedown)f.onmousedown(n);
E.trigger(f,"mousedown")}else if("mousemove"==n.eventType){if(f.onmousemove)f.onmousemove(n);E.trigger(f,"mousemove",n)}else if("mouseup"==n.eventType){0==f.mouse.buttons&&(d.addEventListener("mousemove",e),p=d.ownerDocument,p.removeEventListener("mousemove",e),p.removeEventListener("mouseup",e));n.click_time=x-k;if(f.onmouseup)f.onmouseup(n);E.trigger(f,"mouseup",n)}else if("mousewheel"==n.eventType||"wheel"==n.eventType||"DOMMouseScroll"==n.eventType){n.eventType="mousewheel";n.wheel="wheel"==n.type?
-n.deltaY:null!=n.wheelDeltaY?n.wheelDeltaY:-60*n.detail;n.delta=void 0!==n.wheelDelta?n.wheelDelta/40:n.deltaY?-n.deltaY/3:0;if(f.onmousewheel)f.onmousewheel(n);E.trigger(f,"mousewheel",n)}if(f.onmouse)f.onmouse(n);"mousemove"!=n.eventType&&n.stopPropagation();n.preventDefault();return!1}function a(n){var p=n.changedTouches,x=p[0];if(!(n.touches.length&&n.changedTouches[0].identifier!==n.touches[0].identifier||1<p)){switch(n.type){case "touchstart":var w="mousedown";break;case "touchmove":w="mousemove";
break;case "touchend":w="mouseup";break;default:return}p=document.createEvent("MouseEvent");p.initMouseEvent(w,!0,!0,window,1,x.screenX,x.screenY,x.clientX,x.clientY,!1,!1,!1,!1,0,null);x.target.dispatchEvent(p);n.preventDefault()}}function b(n){f.ongesture&&(n.eventType=n.type,f.ongesture(n));event.preventDefault()}c=c||{};var d=null;if(c.canvas)if("string"==typeof c.canvas){if(d=document.getElementById(c.canvas),!d)throw"Canvas element not found: "+c.canvas;}else d=c.canvas;else d=createCanvas(c.width||
800,c.height||600);"alpha"in c||(c.alpha=!1);try{K.gl=d.getContext("webgl",c)}catch(n){}try{K.gl=K.gl||d.getContext("experimental-webgl",c)}catch(n){}if(!K.gl)throw"WebGL not supported";var f=K.gl;d.is_webgl=!0;d.gl=f;f.context_id=this.last_context_id++;f.extensions={};f.extensions.OES_standard_derivatives=f.derivatives_supported=f.getExtension("OES_standard_derivatives")||!1;f.extensions.WEBGL_depth_texture=f.getExtension("WEBGL_depth_texture")||f.getExtension("WEBKIT_WEBGL_depth_texture")||f.getExtension("MOZ_WEBGL_depth_texture");
f.extensions.OES_element_index_uint=f.getExtension("OES_element_index_uint");f.extensions.WEBGL_draw_buffers=f.getExtension("WEBGL_draw_buffers");f.extensions.EXT_shader_texture_lod=f.getExtension("EXT_shader_texture_lod");f.extensions.EXT_sRGB=f.getExtension("EXT_sRGB");f.extensions.EXT_texture_filter_anisotropic=f.getExtension("EXT_texture_filter_anisotropic")||f.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||f.getExtension("MOZ_EXT_texture_filter_anisotropic");f.extensions.EXT_frag_depth=
f.getExtension("EXT_frag_depth")||f.getExtension("WEBKIT_EXT_frag_depth")||f.getExtension("MOZ_EXT_frag_depth");f.extensions.WEBGL_lose_context=f.getExtension("WEBGL_lose_context")||f.getExtension("WEBKIT_WEBGL_lose_context")||f.getExtension("MOZ_WEBGL_lose_context");f.extensions.OES_texture_float_linear=f.getExtension("OES_texture_float_linear");f.extensions.OES_texture_float_linear&&(f.extensions.OES_texture_float=f.getExtension("OES_texture_float"));f.extensions.OES_texture_half_float_linear=f.getExtension("OES_texture_half_float_linear");
f.extensions.OES_texture_half_float_linear&&(f.extensions.OES_texture_half_float=f.getExtension("OES_texture_half_float"));f.HALF_FLOAT_OES=36193;f.extensions.OES_texture_half_float&&(f.HALF_FLOAT_OES=f.extensions.OES_texture_half_float.HALF_FLOAT_OES);f.HIGH_PRECISION_FORMAT=f.extensions.OES_texture_half_float?f.HALF_FLOAT_OES:f.extensions.OES_texture_float?f.FLOAT:f.UNSIGNED_BYTE;f.max_texture_units=f.getParameter(f.MAX_TEXTURE_IMAGE_UNITS);f._viewport_func=f.viewport;f.viewport_data=new Float32Array([0,
0,f.canvas.width,f.canvas.height]);f.viewport=function(n,p,x,w){var r=this.viewport_data;r[0]=n|0;r[1]=p|0;r[2]=x|0;r[3]=w|0;this._viewport_func(n,p,x,w)};f.getViewport=function(n){return n?(n[0]=f.viewport_data[0],n[1]=f.viewport_data[1],n[2]=f.viewport_data[2],n[3]=f.viewport_data[3],n):new Float32Array(f.viewport_data)};f.setViewport=function(n,p){f.viewport_data.set(n);p&&(f.viewport_data[1]=this.drawingBufferHeight-n[1]-n[3]);this._viewport_func(n[0],f.viewport_data[1],n[2],n[3])};if("undefined"==
typeof glMatrix)throw"glMatrix not found, LiteGL requires glMatrix to be included";var k=0;f.shaders={};f.textures={};f.meshes={};f.makeCurrent=function(){K.gl=this};f.execute=function(n){var p=K.gl;K.gl=this;n();K.gl=p};f.animate=function(n){function p(){if(!f.destroyed){r._requestFrame_id=x(p);var u=getTime(),y=.001*(u-w);if(r.onupdate)r.onupdate(y);E.trigger(f,"update",y);r.ondraw&&(y=K.gl,K.gl=r,r.ondraw(),E.trigger(f,"draw"),K.gl=y);w=u}}if(!1===n)K.cancelAnimationFrame(this._requestFrame_id),
this._requestFrame_id=null;else{var x=K.requestAnimationFrame,w=getTime(),r=this;this._requestFrame_id=x(p)}};f.destroy=function(){m&&(document.removeEventListener("keydown",m),document.removeEventListener("keyup",m));this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas);this.destroyed=!0;K.gl==this&&(K.gl=null)};var l=f.mouse={buttons:0,left_button:!1,middle_button:!1,right_button:!1,position:new Float32Array(2),x:0,y:0,deltax:0,deltay:0,clientx:0,clienty:0,isInsideRect:function(n,
p,x,w,r){var u=this.y;r&&(u=f.canvas.height-u);return this.x>n&&this.x<n+x&&u>p&&u<p+w?!0:!1},isButtonPressed:function(n){return this.buttons&1<<t.RIGHT_MOUSE_BUTTON}};f.captureMouse=function(n){d.addEventListener("mousedown",e);d.addEventListener("mousemove",e);n&&(d.addEventListener("mousewheel",e,!1),d.addEventListener("wheel",e,!1));d.addEventListener("contextmenu",function(p){p.preventDefault();return!1});d.addEventListener("touchstart",a,!0);d.addEventListener("touchmove",a,!0);d.addEventListener("touchend",
a,!0);d.addEventListener("touchcancel",a,!0);d.addEventListener("gesturestart",b);d.addEventListener("gesturechange",b);d.addEventListener("gestureend",b)};f.keys={};var m=null;f.captureKeys=function(n,p){function x(w){w.eventType=w.type;var r=w.target.nodeName.toLowerCase();if("input"!==r&&"textarea"!==r&&"select"!==r){w.character=String.fromCharCode(w.keyCode).toLowerCase();r=!1;var u=t.mapKeyCode(w.keyCode);u||=w.character;w.altKey||w.ctrlKey||w.metaKey||(u&&(f.keys[u]="keydown"==w.type),r=f.keys[w.keyCode],
f.keys[w.keyCode]="keydown"==w.type);if(r!=f.keys[w.keyCode]){if("keydown"==w.type&&f.onkeydown)f.onkeydown(w);else if("keyup"==w.type&&f.onkeyup)f.onkeyup(w);E.trigger(f,w.type,w)}if(f.onkey)f.onkey(w);n&&(w.isChar||t.blockable_keys[w.keyIdentifier||w.key])&&w.preventDefault()}}m||(f.keys={},document.addEventListener("keydown",x),document.addEventListener("keyup",x),m=x)};f.gamepads=null;f.captureGamepads=function(){var n=navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;
n&&(this.gamepads=n.call(navigator))};f.getGamepads=function(n){var p=navigator.getGamepads||navigator.webkitGetGamepads||navigator.mozGetGamepads;if(p){p=p.call(navigator);this.gamepads||(this.gamepads=[]);for(var x=0;4>x;x++){var w=p[x];if(w&&!n){var r=w,u={axes:[],buttons:{},hat:""};u.axes.lx=r.axes[0];u.axes.ly=r.axes[1];u.axes.rx=r.axes[2];u.axes.ry=r.axes[3];u.axes.triggers=r.axes[4];for(var y=0;y<r.buttons.length;y++)switch(y){case 0:u.buttons.a=r.buttons[y].pressed;break;case 1:u.buttons.b=
r.buttons[y].pressed;break;case 2:u.buttons.x=r.buttons[y].pressed;break;case 3:u.buttons.y=r.buttons[y].pressed;break;case 4:u.buttons.lb=r.buttons[y].pressed;break;case 5:u.buttons.rb=r.buttons[y].pressed;break;case 6:u.buttons.lt=r.buttons[y].pressed;break;case 7:u.buttons.rt=r.buttons[y].pressed;break;case 8:u.buttons.back=r.buttons[y].pressed;break;case 9:u.buttons.start=r.buttons[y].pressed;break;case 10:u.buttons.ls=r.buttons[y].pressed;break;case 11:u.buttons.rs=r.buttons[y].pressed;break;
case 12:r.buttons[y].pressed&&(u.hat+="up");break;case 13:r.buttons[y].pressed&&(u.hat+="down");break;case 14:r.buttons[y].pressed&&(u.hat+="left");break;case 15:r.buttons[y].pressed&&(u.hat+="right");break;case 16:u.buttons.home=r.buttons[y].pressed}r.xbox=u}r=this.gamepads[x];if(!r&&w){u=new CustomEvent("gamepadconnected");u.eventType=u.type;u.gamepad=w;if(this.ongamepadconnected)this.ongamepadconnected(u);E.trigger(f,"gamepadconnected",u)}else if(r&&!w){u=new CustomEvent("gamepaddisconnected");
u.eventType=u.type;u.gamepad=r;if(this.ongamepaddisconnected)this.ongamepaddisconnected(u);E.trigger(f,"gamepaddisconnected",u)}if(w)for(y=0;y<w.buttons.length;++y){var A=w.buttons[y];if(A.pressed&&(!r||!r.buttons[y].pressed)){u=new CustomEvent("gamepadButtonDown");u.eventType=u.type;u.button=A;u.which=y;u.gamepad=w;if(f.onbuttondown)f.onbuttondown(u);E.trigger(f,"buttondown",u)}else if(!A.pressed&&r&&r.buttons[y].pressed){u=new CustomEvent("gamepadButtonUp");u.eventType=u.type;u.button=A;u.which=
y;u.gamepad=w;if(f.onbuttondown)f.onbuttondown(u);E.trigger(f,"buttonup",u)}}}return this.gamepads=p}};f.fullscreen=function(){var n=this.canvas;n.requestFullScreen?n.requestFullScreen():n.webkitRequestFullScreen?n.webkitRequestFullScreen():n.mozRequestFullScreen?n.mozRequestFullScreen():console.error("Fullscreen not supported")};f.snapshot=function(n,p,x,w,r){var u=createCanvas(x,w),y=u.getContext("2d"),A=y.getImageData(0,0,u.width,u.height),G=new Uint8Array(x*w*4);f.readPixels(n,p,u.width,u.height,
f.RGBA,f.UNSIGNED_BYTE,G);A.data.set(G);y.putImageData(A,0,0);if(r)return u;n=createCanvas(x,w);y=n.getContext("2d");y.translate(0,w);y.scale(1,-1);y.drawImage(u,0,0);return n};var q={};f.loadTexture=function(n,p,x){if(this.textures[n])return this.textures[n];if(q[n])return null;var w=new Image;w.url=n;w.onload=function(){var r=t.Texture.fromImage(this,p);r.img=this;f.textures[this.url]=r;delete q[this.url];x&&x(r)};w.src=n;q[n]=!0;return null};f.drawTexture=function(){var n=mat3.create(),p=vec2.create(),
x=vec2.create(),w=vec4.create(),r=vec4.fromValues(1,1,1,1),u=vec2.create(),y={u_texture:0,u_position:p,u_color:r,u_size:x,u_texture_area:w,u_viewport:u,u_transform:n};return function(A,G,O,S,B,I,J,M,L,P,Y){p[0]=G;p[1]=O;void 0===S&&(S=A.width);void 0===B&&(B=A.height);x[0]=S;x[1]=B;void 0===I&&(I=0);void 0===J&&(J=0);void 0===M&&(M=A.width);void 0===L&&(L=A.height);w[0]=I/A.width;w[1]=J/A.height;w[2]=(I+M)/A.width;w[3]=(J+L)/A.height;u[0]=this.viewport_data[2];u[1]=this.viewport_data[3];P=P||Shader.getPartialQuadShader(this);
G=Mesh.getScreenQuad(this);A.bind(0);P.uniforms(y);Y&&P.uniforms(Y);P.draw(G,f.TRIANGLES)}}();f.canvas.addEventListener("webglcontextlost",function(n){n.preventDefault();if(f.onlosecontext)f.onlosecontext(n)},!1);f.reset=function(){f.viewport(0,0,this.canvas.width,this.canvas.height);f.disable(f.BLEND);f.disable(f.CULL_FACE);f.disable(f.DEPTH_TEST);f.frontFace(f.CCW);f._current_texture_drawto=null;f._current_fbo_color=null;f._current_fbo_depth=null};f.reset();return f};t.mapKeyCode=function(c){return{8:"BACKSPACE",
9:"TAB",13:"ENTER",16:"SHIFT",17:"CTRL",27:"ESCAPE",32:"SPACE",37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN"}[c]||(65<=c&&90>=c?String.fromCharCode(c):null)};t.dragging=!1;t.last_pos=[0,0];t.augmentEvent=function(c,e){var a=null;e=e||c.target||gl.canvas;a=e.getBoundingClientRect();c.mousex=c.clientX-a.left;c.mousey=c.clientY-a.top;c.canvasx=c.mousex;c.canvasy=a.height-c.mousey;c.deltax=0;c.deltay=0;"mousedown"==c.type?(this.dragging=!0,gl.mouse.buttons|=1<<c.which):"mousemove"!=c.type&&"mouseup"==c.type&&
(gl.mouse.buttons&=~(1<<c.which),0==gl.mouse.buttons&&(this.dragging=!1));c.deltax=c.mousex-this.last_pos[0];c.deltay=c.mousey-this.last_pos[1];this.last_pos[0]=c.mousex;this.last_pos[1]=c.mousey;c.dragging=this.dragging;c.buttons_mask=gl.mouse.buttons;c.leftButton=gl.mouse.buttons&1<<t.LEFT_MOUSE_BUTTON;c.middleButton=gl.mouse.buttons&1<<t.MIDDLE_MOUSE_BUTTON;c.rightButton=gl.mouse.buttons&1<<t.RIGHT_MOUSE_BUTTON;c.isButtonPressed=function(b){return this.buttons_mask&1<<b}};var E=K.LEvent=t.LEvent=
{bind:function(c,e,a,b){if(!c)throw"cannot bind event to null";if(!a)throw"cannot bind to null callback";if(c.constructor===String)throw"cannot bind event to a string";var d=c.__levents;d||(Object.defineProperty(c,"__levents",{value:{},enumerable:!1}),d=c.__levents);d.hasOwnProperty(e)?d[e].push([a,b]):d[e]=[[a,b]]},unbind:function(c,e,a,b){if(!c)throw"cannot unbind event to null";if(!a)throw"cannot unbind from null callback";if(c.constructor===String)throw"cannot bind event to a string";if((c=c.__levents)&&
c.hasOwnProperty(e)){for(var d=0,f=c[e].length;d<f;++d){var k=c[e][d];if(k[0]===a&&k[1]===b){c[e].splice(d,1);break}}0==c[e].length&&delete c[e]}},unbindAll:function(c,e,a){if(!c)throw"cannot unbind events in null";var b=c.__levents;if(b)if(e)for(var d in b){c=b[d];for(var f=c.length-1;0<=f;--f)c[f][1]!=e||a&&a!==c[f][0]||c.splice(f,1)}else delete c.__levents},unbindAllEvent:function(c,e){if(!c)throw"cannot unbind events in null";(c=c.__levents)&&delete c[e]},isBind:function(c,e,a,b){if(!c)throw"LEvent cannot have null as instance";
if(c=c.__levents){if(!c.hasOwnProperty(e))return!1;for(var d=0,f=c[e].length;d<f;++d){var k=c[e][d];if(k[0]===a&&k[1]===b)return!0}return!1}},hasBind:function(c,e){if(!c)throw"LEvent cannot have null as instance";return(c=c.__levents)&&c.hasOwnProperty(e)&&c[e].length?!0:!1},hasBindTo:function(c,e){if(!c)throw"LEvent cannot have null as instance";c=c.__levents;if(!c)return!1;for(var a in c)for(var b=c[a],d=0;d<b.length;++d)if(b[d][1]===e)return!0;return!1},trigger:function(c,e,a){if(!c)throw"cannot trigger event from null";
if(c.constructor===String)throw"cannot bind event to a string";c=c.__levents;if(!c||!c.hasOwnProperty(e))return!0;c=c[e];for(var b=0,d=c.length;b<d;++b){var f=c[b];if(f&&0==f[0].call(f[1],e,a))return!1}return!0},triggerArray:function(c,e,a){for(var b=0,d=c.length;b<d;++b){var f=c[b];if(!f)throw"cannot trigger event from null";if(f.constructor===String)throw"cannot bind event to a string";if((f=f.__levents)&&f.hasOwnProperty(e))for(var k=0,l=f[e].length;k<l;++k){var m=f[e][k];if(0==m[0].call(m[1],
e,a))break}}return!0},extendObject:function(c){c.on=function(e,a,b){if(!a)throw"cannot bind to null callback";var d=this.__levents;this||(Object.defineProperty(this,"__levents",{value:{},enumerable:!1}),d=this.__levents);d.hasOwnProperty(e)?d[e].push([a,b]):d[e]=[[a,b]]};c.trigger=function(e,a){var b=this.__levents;if(!b||!b.hasOwnProperty(e))return!0;b=b[e];for(var d=0,f=b.length;d<f;++d){var k=b[d];if(k&&0==k[0].call(k[1],e,a))return!1}return!0};c.unbind=function(e,a,b){if(!a)throw"cannot unbind from null callback";
var d=this.__levents;if(d&&d.hasOwnProperty(e)){for(var f=0,k=d[e].length;f<k;++f){var l=d[e][f];if(l[0]===a&&l[1]===b){d[e].splice(f,1);break}}0==d[e].length&&delete d[e]}}},extendClass:function(c){this.extendObject(c.prototype)}};K.CLIP_INSIDE=t.CLIP_INSIDE=0;K.CLIP_OUTSIDE=t.CLIP_OUTSIDE=1;K.CLIP_OVERLAP=t.CLIP_OVERLAP=2;K.geo={createPlane:function(c,e){return new Float32Array([e[0],e[1],e[2],-vec3.dot(c,e)])},distancePointToPlane:function(c,e){return(vec3.dot(c,e)+e[3])/Math.sqrt(e[0]*e[0]+e[1]*
e[1]+e[2]*e[2])},distance2PointToPlane:function(c,e){return(vec3.dot(c,e)+e[3])/(e[0]*e[0]+e[1]*e[1]+e[2]*e[2])},projectPointOnPlane:function(c,e,a,b){b=b||vec3.create();e=vec3.subtract(vec3.create(),c,e);e=vec3.dot(e,a);return vec3.subtract(b,c,vec3.scale(vec3.create(),a,e))},reflectPointInPlane:function(c,e,a){e=-(-1*(e[0]*a[0]+e[1]*a[1]+e[2]*a[2])+a[0]*c[0]+a[1]*c[1]+a[2]*c[2])/(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);return vec3.fromValues(c[0]+e*a[0]*2,c[1]+e*a[1]*2,c[2]+e*a[2]*2)},testRayPlane:function(c,
e,a,b,d){a=vec3.dot(a,b)-vec3.dot(b,c);b=vec3.dot(b,e);if(Math.abs(b)<EPSILON)return!1;b=a/b;if(0>b)return!1;d&&vec3.add(d,c,vec3.scale(d,e,b));return!0},testSegmentPlane:function(){var c=vec3.create();return function(e,a,b,d,f){b=vec3.dot(b,d)-vec3.dot(d,e);a=vec3.sub(c,a,e);d=vec3.dot(d,a);if(Math.abs(d)<EPSILON)return!1;d=b/d;if(0>d||1<d)return!1;f&&vec3.add(f,e,vec3.scale(f,a,d));return!0}}(),testRaySphere:function(){var c=vec3.create();return function(e,a,b,d,f,k){var l=vec3.subtract(c,e,b),
m=a[0]*a[0]+a[1]*a[1]+a[2]*a[2];b=2*l[0]*a[0]+2*l[1]*a[1]+2*l[2]*a[2];d=b*b-4*m*(l[0]*l[0]+l[1]*l[1]+l[2]*l[2]-d*d);if(0>d)return!1;if(f){d=Math.sqrt(d);l=1/(2*m);m=(-b+d)*l;b=(-b-d)*l;b=m<b?m:b;if(b>k)return!1;vec3.add(f,e,vec3.scale(f,a,b))}return!0}}(),testRayCylinder:function(c,e,a,b,d,f){var k=vec3.clone(c);c=vec3.add(vec3.create(),c,vec3.scale(vec3.create(),e,1E5));e=vec3.subtract(vec3.create(),b,a);var l=vec3.subtract(vec3.create(),k,a);a=vec3.subtract(vec3.create(),c,k);b=vec3.dot(l,e);c=
vec3.dot(a,e);e=vec3.dot(e,e);if(0>b&&0>b+c||b>e&&b+c>e)return!1;var m=vec3.dot(a,a),q=vec3.dot(l,a);var n=e*m-c*c;d=vec3.dot(l,l)-d*d;var p=e*d-b*b;if(Math.abs(n)<EPSILON){if(0<p)return!1;n=0>b?-q/m:b>e?(c-q)/m:0;f&&vec3.add(f,k,vec3.scale(vec3.create(),a,n));return!0}l=e*q-c*b;p=l*l-n*p;if(0>p)return!1;n=(-l-Math.sqrt(p))/n;if(0>n||1<n)return!1;if(0>b+n*c){if(0>=c)return!1;n=-b/c;f&&vec3.add(f,k,vec3.scale(vec3.create(),a,n));return 0>=d+2*n*(q+n*m)}if(b+n*c>e){if(0<=c)return!1;n=(e-b)/c;f&&vec3.add(f,
k,vec3.scale(vec3.create(),a,n));return 0>=d+e-2*b+n*(2*(q-c)+n*m)}f&&vec3.add(f,k,vec3.scale(vec3.create(),a,n));return!0},testRayBox:function(c,e,a,b,d,f){d=d||vec3.create();f=f||Number.MAX_VALUE;var k=!0,l=new Float32Array(3),m,q=new Float32Array(3),n=new Float32Array(3);for(m=0;3>m;++m)c[m]<a[m]?(l[m]=1,n[m]=a[m],k=!1):c[m]>b[m]?(l[m]=0,n[m]=b[m],k=!1):l[m]=2;if(k)return vec3.copy(d,c),!0;for(m=0;3>m;++m)q[m]=2!=l[m]&&0!=e[m]?(n[m]-c[m])/e[m]:-1;k=0;for(m=1;3>m;m++)q[k]<q[m]&&(k=m);if(0>q[k]||
q[k]>f)return!1;for(m=0;3>m;++m)if(k!=m){if(d[m]=c[m]+q[k]*e[m],d[m]<a[m]||d[m]>b[m])return!1}else d[m]=n[m];return!0},testRayBBox:function(c,e,a,b,d,f){if(b){var k=mat4.invert(mat4.create(),b);e=vec3.add(vec3.create(),c,e);c=vec3.transformMat4(vec3.create(),c,k);vec3.transformMat4(e,e,k);vec3.sub(e,e,c);e=vec3.normalize(e,e)}c=this.testRayBox(c,e,a.subarray(6,9),a.subarray(9,12),d,f);b&&vec3.transformMat4(d,d,b);return c},testPointBBox:function(c,e){return c[0]<e[6]||c[0]>e[9]||c[1]<e[7]||c[0]>e[10]||
c[2]<e[8]||c[0]>e[11]?!1:!0},testBBoxBBox:function(c,e){if(Math.abs(e[0]-c[0])>c[3]+e[3]||Math.abs(e[1]-c[1])>c[4]+e[4]||Math.abs(e[2]-c[2])>c[5]+e[5])return!1;var a=BBox.getMin(e);geo.testPointBBox(a,c)&&(a=BBox.getMax(e),geo.testPointBBox(a,c));return!0},testSphereBBox:function(c,e,a){for(var b=0,d=BBox.getMin(a),f=BBox.getMax(a),k=0;3>k;++k)c[k]<d[k]?(a=c[k]-d[k],b+=a*a):c[k]>f[k]&&(a=c[k]-f[k],b+=a*a);return b<=e*e?!0:!1},closestPointBetweenLines:function(c,e,a,b,d,f){e=vec3.subtract(vec3.create(),
e,c);b=vec3.subtract(vec3.create(),b,a);var k=vec3.subtract(vec3.create(),c,a),l=vec3.dot(e,e),m=vec3.dot(e,b),q=vec3.dot(b,b),n=vec3.dot(e,k),p=vec3.dot(b,k),x=l*q-m*m,w;x<EPSILON?(w=0,l=m>q?n/m:p/q):(w=(m*p-q*n)/x,l=(l*p-m*n)/x);d&&vec3.add(d,c,vec3.scale(vec3.create(),e,w));f&&vec3.add(f,a,vec3.scale(vec3.create(),b,l));c=vec3.add(vec3.create(),k,vec3.subtract(vec3.create(),vec3.scale(vec3.create(),e,w),vec3.scale(vec3.create(),b,l)));return vec3.length(c)},extractPlanes:function(c,e){function a(b){var d=
e.subarray(b,b+3);d=vec3.length(d);0!==d&&(d=1/d,e[b]*=d,e[b+1]*=d,e[b+2]*=d,e[b+3]*=d)}e=e||new Float32Array(24);e.set([c[3]-c[0],c[7]-c[4],c[11]-c[8],c[15]-c[12]],0);a(0);e.set([c[3]+c[0],c[7]+c[4],c[11]+c[8],c[15]+c[12]],4);a(4);e.set([c[3]+c[1],c[7]+c[5],c[11]+c[9],c[15]+c[13]],8);a(8);e.set([c[3]-c[1],c[7]-c[5],c[11]-c[9],c[15]-c[13]],12);a(12);e.set([c[3]-c[2],c[7]-c[6],c[11]-c[10],c[15]-c[14]],16);a(16);e.set([c[3]+c[2],c[7]+c[6],c[11]+c[10],c[15]+c[14]],20);a(20);return e},frustumTestBox:function(c,
e){var a=0;var b=planeBoxOverlap(c.subarray(0,4),e);if(b==CLIP_OUTSIDE)return CLIP_OUTSIDE;a+=b;b=planeBoxOverlap(c.subarray(4,8),e);if(b==CLIP_OUTSIDE)return CLIP_OUTSIDE;a+=b;b=planeBoxOverlap(c.subarray(8,12),e);if(b==CLIP_OUTSIDE)return CLIP_OUTSIDE;a+=b;b=planeBoxOverlap(c.subarray(12,16),e);if(b==CLIP_OUTSIDE)return CLIP_OUTSIDE;a+=b;b=planeBoxOverlap(c.subarray(16,20),e);if(b==CLIP_OUTSIDE)return CLIP_OUTSIDE;a+=b;b=planeBoxOverlap(c.subarray(20,24),e);return b==CLIP_OUTSIDE?CLIP_OUTSIDE:0==
a+b?CLIP_INSIDE:CLIP_OVERLAP},frustumTestSphere:function(c,e,a){var b=!1;var d=distanceToPlane(c.subarray(0,4),e);if(d<-a)return CLIP_OUTSIDE;d>=-a&&d<=a&&(b=!0);d=distanceToPlane(c.subarray(4,8),e);if(d<-a)return CLIP_OUTSIDE;d>=-a&&d<=a&&(b=!0);d=distanceToPlane(c.subarray(8,12),e);if(d<-a)return CLIP_OUTSIDE;d>=-a&&d<=a&&(b=!0);d=distanceToPlane(c.subarray(12,16),e);if(d<-a)return CLIP_OUTSIDE;d>=-a&&d<=a&&(b=!0);d=distanceToPlane(c.subarray(16,20),e);if(d<-a)return CLIP_OUTSIDE;d>=-a&&d<=a&&(b=
!0);d=distanceToPlane(c.subarray(20,24),e);if(d<-a)return CLIP_OUTSIDE;d>=-a&&d<=a&&(b=!0);return b?CLIP_OVERLAP:CLIP_INSIDE},testPoint2DInPolygon:function(c,e){for(var a=!1,b=-1,d=c.length,f=d-1;++b<d;f=b)(c[b][1]<=e[1]&&e[1]<c[f][1]||c[f][1]<=e[1]&&e[1]<c[b][1])&&e[0]<(c[f][0]-c[b][0])*(e[1]-c[b][1])/(c[f][1]-c[b][1])+c[b][0]&&(a=!a);return a}};K.BBox=t.BBox={center:0,halfsize:3,min:6,max:9,radius:12,data_length:13,corners:new Float32Array([1,1,1,1,1,-1,1,-1,1,1,-1,-1,-1,1,1,-1,1,-1,-1,-1,1,-1,
-1,-1]),tmp_corners:new Float32Array(24),create:function(){return new Float32Array(13)},clone:function(c){return new Float32Array(c)},copy:function(c,e){c.set(e);return c},fromPoint:function(c){var e=this.create();e.set(c,0);e.set(c,6);e.set(c,9);return e},fromMinMax:function(c,e){var a=this.create();this.setMinMax(a,c,e);return a},fromCenterHalfsize:function(c,e){var a=this.create();this.setCenterHalfsize(a,c,e);return a},fromPoints:function(c){var e=this.create();this.setFromPoints(e,c);return e},
setFromPoints:function(c,e){var a=c.subarray(6,9),b=c.subarray(9,12);a.set(e.subarray(0,3));b.set(a);for(var d,f=3,k=e.length;f<k;f+=3)d=e.subarray(f,f+3),vec3.min(a,d,a),vec3.max(b,d,b);a=vec3.add(c.subarray(0,3),a,b);vec3.scale(a,a,.5);vec3.subtract(c.subarray(3,6),b,a);c[12]=vec3.length(c.subarray(3,6));return c},setMinMax:function(c,e,a){c[6]=e[0];c[7]=e[1];c[8]=e[2];c[9]=a[0];c[10]=a[1];c[11]=a[2];var b=c.subarray(3,6);vec3.sub(b,a,e);vec3.scale(b,b,.5);c[0]=a[0]-b[0];c[1]=a[1]-b[1];c[2]=a[2]-
b[2];c[12]=vec3.length(c.subarray(3,6));return c},setCenterHalfsize:function(c,e,a,b){c[0]=e[0];c[1]=e[1];c[2]=e[2];c[3]=a[0];c[4]=a[1];c[5]=a[2];vec3.sub(c.subarray(6,9),c.subarray(0,3),c.subarray(3,6));vec3.add(c.subarray(9,12),c.subarray(0,3),c.subarray(3,6));c[12]=b?b:vec3.length(a);return c},transformMat4:function(c,e,a){var b=e.subarray(3,6),d=this.tmp_corners;d.set(this.corners);for(var f=0;8>f;++f){var k=d.subarray(3*f,3*f+3);vec3.multiply(k,b,k);vec3.add(k,k,e);mat4.multiplyVec3(k,a,k)}return this.setFromPoints(c,
d)},getCorners:function(c,e){var a=c.subarray(3,6),b=null;e?(e.set(this.corners),b=e):b=new Float32Array(this.corners);for(e=0;8>e;++e){var d=b.subarray(3*e,3*e+3);vec3.multiply(d,a,d);vec3.add(d,d,c)}return b},merge:function(c,e,a){var b=c.subarray(6,9),d=c.subarray(9,12);vec3.min(b,e.subarray(6,9),a.subarray(6,9));vec3.max(d,e.subarray(9,12),a.subarray(9,12));return BBox.setMinMax(c,b,d)},extendToPoint:function(c,e){e[0]<c[6]?c[6]=e[0]:e[0]>c[9]&&(c[9]=e[0]);e[1]<c[7]?c[7]=e[1]:e[1]>c[10]&&(c[10]=
e[1]);e[2]<c[8]?c[8]=e[2]:e[2]>c[11]&&(c[11]=e[2]);e=c.subarray(6,9);var a=c.subarray(9,12);e=vec3.add(c.subarray(0,3),e,a);vec3.scale(e,e,.5);vec3.subtract(c.subarray(3,6),a,e);c[12]=vec3.length(c.subarray(3,6));return c},getCenter:function(c){return c.subarray(0,3)},getHalfsize:function(c){return c.subarray(3,6)},getMin:function(c){return c.subarray(6,9)},getMax:function(c){return c.subarray(9,12)},getRadius:function(c){return c[12]}};K.distanceToPlane=t.distanceToPlane=function(c,e){return vec3.dot(c,
e)+c[3]};K.planeBoxOverlap=t.planeBoxOverlap=function(c,e){var a=c[3],b=vec3.fromValues(Math.abs(e[3]*c[0]),Math.abs(e[4]*c[1]),Math.abs(e[5]*c[2]));b=b[0]+b[1]+b[2];a=vec3.dot(c,e)+a;return a<=-b?CLIP_OUTSIDE:a<=b?CLIP_OVERLAP:CLIP_INSIDE};K.Octree=t.Octree=function(c){this.root=null;this.total_nodes=this.total_depth=0;c&&(this.buildFromMesh(c),this.total_nodes=this.trim())};Octree.MAX_NODE_TRIANGLES_RATIO=.1;Octree.MAX_OCTREE_DEPTH=8;Octree.OCTREE_MARGIN_RATIO=.01;Octree.OCTREE_MIN_MARGIN=.1;Octree.prototype.buildFromMesh=
function(c){this.total_nodes=this.total_depth=0;var e=c.getBuffer("vertices").data;if(c=c.getIndexBuffer("triangles"))c=c.data;var a=this.computeAABB(e);this.root=a;this.total_nodes=1;this.total_triangles=c?c.length/3:e.length/9;this.max_node_triangles=this.total_triangles*Octree.MAX_NODE_TRIANGLES_RATIO;var b=vec3.create();vec3.scale(b,a.size,Octree.OCTREE_MARGIN_RATIO);b[0]<Octree.OCTREE_MIN_MARGIN&&(b[0]=Octree.OCTREE_MIN_MARGIN);b[1]<Octree.OCTREE_MIN_MARGIN&&(b[1]=Octree.OCTREE_MIN_MARGIN);b[2]<
Octree.OCTREE_MIN_MARGIN&&(b[2]=Octree.OCTREE_MIN_MARGIN);vec3.sub(a.min,a.min,b);vec3.add(a.max,a.max,b);a.faces=[];a.inside=0;if(c)for(b=0;b<c.length;b+=3){var d=new Float32Array([e[3*c[b]],e[3*c[b]+1],e[3*c[b]+2],e[3*c[b+1]],e[3*c[b+1]+1],e[3*c[b+1]+2],e[3*c[b+2]],e[3*c[b+2]+1],e[3*c[b+2]+2]]);this.addToNode(d,a,0)}else for(b=0;b<e.length;b+=9)d=new Float32Array(e.subarray(b,b+9)),this.addToNode(d,a,0);return a};Octree.prototype.addToNode=function(c,e,a){e.inside+=1;if(e.c){var b=this.computeAABB(c),
d=!1,f;for(f in e.c){var k=e.c[f];if(Octree.isInsideAABB(b,k)){this.addToNode(c,k,a+1);d=!0;break}}d||(null==e.faces&&(e.faces=[]),e.faces.push(c))}else if(null==e.faces&&(e.faces=[]),e.faces.push(c),e.faces.length>this.max_node_triangles&&a<Octree.MAX_OCTREE_DEPTH){this.splitNode(e);this.total_depth<a+1&&(this.total_depth=a+1);var l=e.faces.concat();e.faces=null;for(f in l){c=l[f];b=this.computeAABB(c);d=!1;for(var m in e.c)if(k=e.c[m],Octree.isInsideAABB(b,k)){this.addToNode(c,k,a+1);d=!0;break}d||
(null==e.faces&&(e.faces=[]),e.faces.push(c))}}};Octree.prototype.octree_pos_ref=[[0,0,0],[0,0,1],[0,1,0],[0,1,1],[1,0,0],[1,0,1],[1,1,0],[1,1,1]];Octree.prototype.splitNode=function(c){c.c=[];var e=[.5*(c.max[0]-c.min[0]),.5*(c.max[1]-c.min[1]),.5*(c.max[2]-c.min[2])],a;for(a in this.octree_pos_ref){var b=this.octree_pos_ref[a],d={};this.total_nodes+=1;d.min=[c.min[0]+e[0]*b[0],c.min[1]+e[1]*b[1],c.min[2]+e[2]*b[2]];d.max=[d.min[0]+e[0],d.min[1]+e[1],d.min[2]+e[2]];d.faces=null;d.inside=0;c.c.push(d)}};
Octree.prototype.computeAABB=function(c){for(var e=new Float32Array([c[0],c[1],c[2]]),a=new Float32Array([c[0],c[1],c[2]]),b=0;b<c.length;b+=3)for(var d=0;3>d;d++)e[d]>c[b+d]&&(e[d]=c[b+d]),a[d]<c[b+d]&&(a[d]=c[b+d]);return{min:e,max:a,size:vec3.sub(vec3.create(),a,e)}};Octree.prototype.trim=function(c){c=c||this.root;if(!c.c)return 1;for(var e=1,a=[],b=c.c,d=0;d<b.length;++d)b[d].inside&&(a.push(b[d]),e+=this.trim(b[d]));c.c=a;return e};Octree.prototype.testRay=function(){var c=vec3.create(),e=vec3.create(),
a=vec3.create(),b=vec3.create();return function(d,f,k,l){if(!this.root)throw"Error: octree not build";c.set(d);e.set(f);a.set(this.root.min);b.set(this.root.max);k=Octree.hitTestBox(c,e,a,b);if(!k)return null;k=Octree.testRayInNode(this.root,c,e);return null!=k?(f=vec3.scale(vec3.create(),f,k.t),vec3.add(f,f,d),k.pos=f,k):null}}();Octree.prototype.testSphere=function(c,e){c=vec3.clone(c);if(!this.root)throw"Error: octree not build";e*=e;return Octree.testSphereBox(c,e,vec3.clone(this.root.min),vec3.clone(this.root.max))?
Octree.testSphereInNode(this.root,c,e):!1};Octree.testRayInNode=function(c,e,a){var b=null;if(c.faces)for(var d=0,f=c.faces.length;d<f;++d){var k=c.faces[d];var l=Octree.hitTestTriangle(e,a,k.subarray(0,3),k.subarray(3,6),k.subarray(6,9));null!=l&&(l.face=k,b?b.mergeWith(l):b=l)}f=vec3.create();k=vec3.create();if(c.c)for(d=0;d<c.c.length;++d){var m=c.c[d];f.set(m.min);k.set(m.max);l=Octree.hitTestBox(e,a,f,k);null==l||b&&l.t>b.t||(l=Octree.testRayInNode(m,e,a),null!=l&&(b?b.mergeWith(l):b=l))}return b};
Octree.testSphereInNode=function(c,e,a){if(c.faces)for(var b=0,d=c.faces.length;b<d;++b){var f=c.faces[b];if(Octree.testSphereTriangle(e,a,f.subarray(0,3),f.subarray(3,6),f.subarray(6,9)))return!0}d=vec3.create();f=vec3.create();var k;if(c.c)for(b=0;b<c.c.length;++b)if(k=c.c[b],d.set(k.min),f.set(k.max),Octree.testSphereBox(e,a,d,f)&&Octree.testSphereInNode(k,e,a))return!0;return!1};Octree.isInsideAABB=function(c,e){return c.min[0]<e.min[0]||c.min[1]<e.min[1]||c.min[2]<e.min[2]||c.max[0]>e.max[0]||
c.max[1]>e.max[1]||c.max[2]>e.max[2]?!1:!0};Octree.hitTestBox=function(){var c=vec3.create(),e=vec3.create(),a=vec3.create(),b=vec3.create(),d=vec3.create(),f=vec3.create(),k=vec3.fromValues(1E-6,1E-6,1E-6);return function(l,m,q,n){vec3.subtract(c,q,l);vec3.subtract(e,n,l);if(0>vec3.maxValue(c)&&0<vec3.minValue(e))return new HitTest(0,l,m);a[0]=1/m[0];a[1]=1/m[1];a[2]=1/m[2];vec3.multiply(c,c,a);vec3.multiply(e,e,a);vec3.min(b,c,e);vec3.max(d,c,e);var p=vec3.maxValue(b),x=vec3.minValue(d);return 0<
p&&p<x?(l=vec3.add(vec3.create(),vec3.scale(f,m,p),l),vec3.add(q,q,k),vec3.subtract(q,q,k),new HitTest(p,l,vec3.fromValues((l[0]>n[0])-(l[0]<q[0]),(l[1]>n[1])-(l[1]<q[1]),(l[2]>n[2])-(l[2]<q[2])))):null}}();Octree.hitTestTriangle=function(){var c=vec3.create(),e=vec3.create(),a=vec3.create(),b=vec3.create();return function(d,f,k,l,m){vec3.subtract(c,l,k);vec3.subtract(e,m,k);l=vec3.cross(vec3.create(),c,e);vec3.normalize(l,l);if(0<vec3.dot(l,f))return null;m=vec3.dot(l,vec3.subtract(b,k,d))/vec3.dot(l,
f);if(0<m){f=vec3.scale(vec3.create(),f,m);vec3.add(f,f,d);vec3.subtract(a,f,k);d=vec3.dot(e,e);k=vec3.dot(e,c);var q=vec3.dot(e,a),n=vec3.dot(c,c),p=vec3.dot(c,a),x=d*n-k*k;n=(n*q-k*p)/x;d=(d*p-k*q)/x;if(0<=n&&0<=d&&1>=n+d)return new HitTest(m,f,l)}return null}}();Octree.testSphereTriangle=function(){var c=vec3.create(),e=vec3.create(),a=vec3.create(),b=vec3.create(),d=vec3.create(),f=vec3.create(),k=vec3.create(),l=vec3.create();return function(m,q,n,p,x){vec3.sub(c,n,m);vec3.sub(e,p,m);vec3.sub(a,
x,m);vec3.sub(b,e,c);vec3.sub(d,a,c);vec3.cross(l,b,d);m=vec3.dot(c,l);n=vec3.dot(l,l);m=m*m>q*n;var w=vec3.dot(c,c),r=vec3.dot(c,e),u=vec3.dot(c,a),y=vec3.dot(e,e),A=vec3.dot(e,a),G=vec3.dot(a,a);n=w>q&r>w&u>w;p=y>q&r>y&A>y;x=G>q&u>G&A>G;w=r-w;r=A-y;var O=u-G;vec3.sub(f,a,e);vec3.sub(k,c,a);y=vec3.dot(b,b);G=vec3.dot(f,f);u=vec3.dot(k,k);A=vec3.scale(vec3.create(),c,y);vec3.sub(A,A,vec3.scale(vec3.create(),b,w));w=vec3.scale(vec3.create(),e,G);vec3.sub(w,w,vec3.scale(vec3.create(),f,r));r=vec3.scale(vec3.create(),
a,u);vec3.sub(r,r,vec3.scale(vec3.create(),k,O));var S=vec3.scale(vec3.create(),a,y);S=vec3.sub(S,S,A);var B=vec3.scale(vec3.create(),c,G);B=vec3.sub(B,B,w);O=vec3.scale(vec3.create(),e,u);O=vec3.sub(O,O,r);y=vec3.dot(A,A)>q*y*y&0<vec3.dot(A,S);G=vec3.dot(w,w)>q*G*G&0<vec3.dot(w,B);q=vec3.dot(r,r)>q*u*u&0<vec3.dot(r,O);return!(m|n|p|x|y|G|q)}}();Octree.testSphereBox=function(c,e,a,b){for(var d,f=0,k=0;3>k;++k)c[k]<a[k]?(d=c[k]-a[k],f+=d*d):c[k]>b[k]&&(d=c[k]-b[k],f+=d*d);return f<=e?!0:!1};K.HitTest=
t.HitTest=function(c,e,a){this.t=arguments.length?c:Number.MAX_VALUE;this.hit=e;this.normal=a;this.face=null};HitTest.prototype={mergeWith:function(c){0<c.t&&c.t<this.t&&(this.t=c.t,this.hit=c.hit,this.normal=c.normal,this.face=c.face)}};K.Raytracer=t.Raytracer=function(c,e){this.viewport=vec4.create();this.ray00=vec3.create();this.ray10=vec3.create();this.ray01=vec3.create();this.ray11=vec3.create();this.eye=vec3.create();this.setup(c,e)};Raytracer.prototype.setup=function(c,e){e=e||gl.viewport_data;
this.viewport.set(e);var a=e[0],b=a+e[2],d=e[1],f=d+e[3];vec3.set(this.ray00,a,d,1);vec3.set(this.ray10,b,d,1);vec3.set(this.ray01,a,f,1);vec3.set(this.ray11,b,f,1);vec3.unproject(this.ray00,this.ray00,c,e);vec3.unproject(this.ray10,this.ray10,c,e);vec3.unproject(this.ray01,this.ray01,c,e);vec3.unproject(this.ray11,this.ray11,c,e);a=this.eye;vec3.unproject(a,a,c,e);vec3.subtract(this.ray00,this.ray00,a);vec3.subtract(this.ray10,this.ray10,a);vec3.subtract(this.ray01,this.ray01,a);vec3.subtract(this.ray11,
this.ray11,a)};Raytracer.prototype.getRayForPixel=function(){var c=vec3.create(),e=vec3.create();return function(a,b,d){d=d||vec3.create();a=(a-this.viewport[0])/this.viewport[2];b=1-(b-this.viewport[1])/this.viewport[3];vec3.lerp(c,this.ray00,this.ray10,a);vec3.lerp(e,this.ray01,this.ray11,a);vec3.lerp(d,c,e,b);return vec3.normalize(d,d)}}();var F=mat4.create();Raytracer.hitTestBox=function(c,e,a,b,d){var f=new Float32Array(30);d&&(d=mat4.invert(F,d),c=mat4.multiplyVec3(f.subarray(3,6),d,c),e=mat4.rotateVec3(f.subarray(6,
9),d,e));var k=vec3.subtract(f.subarray(9,12),a,c);vec3.divide(k,k,e);var l=vec3.subtract(f.subarray(12,15),b,c);vec3.divide(l,l,e);d=vec3.min(f.subarray(15,18),k,l);k=vec3.max(f.subarray(18,21),k,l);d=vec3.maxValue(d);k=vec3.minValue(k);return 0<d&&d<=k?(e=vec3.scale(f.subarray(21,24),e,d),vec3.add(e,c,e),vec3.addValue(f.subarray(24,27),a,1E-6),vec3.subValue(f.subarray(27,30),b,1E-6),new HitTest(d,e,vec3.fromValues((e[0]>b[0])-(e[0]<a[0]),(e[1]>b[1])-(e[1]<a[1]),(e[2]>b[2])-(e[2]<a[2])))):null};
Raytracer.hitTestSphere=function(c,e,a,b){var d=vec3.subtract(vec3.create(),c,a),f=vec3.dot(e,e),k=2*vec3.dot(e,d);d=vec3.dot(d,d)-b*b;d=k*k-4*f*d;return 0<d?(f=(-k-Math.sqrt(d))/(2*f),c=vec3.add(vec3.create(),c,vec3.scale(vec3.create(),e,f)),new HitTest(f,c,vec3.scale(vec3.create(),vec3.subtract(vec3.create(),c,a),1/b))):null};Raytracer.hitTestTriangle=function(c,e,a,b,d){var f=vec3.subtract(vec3.create(),b,a),k=vec3.subtract(vec3.create(),d,a);d=vec3.cross(vec3.create(),f,k);vec3.normalize(d,d);
b=vec3.dot(d,vec3.subtract(vec3.create(),a,c))/vec3.dot(d,e);if(0<b){c=vec3.add(vec3.create(),c,vec3.scale(vec3.create(),e,b));var l=vec3.subtract(vec3.create(),c,a);a=vec3.dot(k,k);e=vec3.dot(k,f);k=vec3.dot(k,l);var m=vec3.dot(f,f);f=vec3.dot(f,l);l=a*m-e*e;m=(m*k-e*f)/l;f=(a*f-e*k)/l;if(0<=m&&0<=f&&1>=m+f)return new HitTest(b,c,d)}return null};Mesh.parseOBJ=function(c,e){e=e||{};for(var a=[],b=[],d=[],f=[],k=[],l=[],m=[],q={},n=0,p=null,x=0,w,r=0,u,y,A=null,G=!1,O=!1,S=!1,B=!1,I=0,J=e.noindex?
e.noindex:1E7<c.length?!0:!1,M=e.flipAxis,L=M||e.flipNormals,P=null,Y=[],W=c.split("\n"),aa=W.length,ca=0;ca<aa;++ca)if(p=W[ca].replace(/[ \t]+/g," ").replace(/\s\s*$/,""),"#"!=p[0]&&""!=p)if(A=p.split(" "),B&&"v"==A[0]&&(B=!1),"v"==A[0])M?k.push(-1*parseFloat(A[1]),parseFloat(A[3]),parseFloat(A[2])):k.push(parseFloat(A[1]),parseFloat(A[2]),parseFloat(A[3]));else if("vt"==A[0])l.push(parseFloat(A[1]),parseFloat(A[2]));else if("vn"==A[0])L?m.push(-parseFloat(A[2]),-parseFloat(A[3]),parseFloat(A[1])):
m.push(parseFloat(A[1]),parseFloat(A[2]),parseFloat(A[3]));else if("f"==A[0]){if(B=!0,!(4>A.length)){var T=[];for(p=1;p<A.length;++p){if(!(A[p]in q)||J){c=A[p].split("/");if(1==c.length)c=w=x=parseInt(c[0])-1;else if(2==c.length)x=parseInt(c[0])-1,w=parseInt(c[1])-1,c=-1;else if(3==c.length)x=parseInt(c[0])-1,w=parseInt(c[1])-1,c=parseInt(c[2])-1;else return console.err("Problem parsing: unknown number of values per face"),!1;3<p&&J&&(r=a.length,a.push(a[r-9*(p-3)],a[r-9*(p-3)+1],a[r-9*(p-3)+2]),
a.push(a[r-3],a[r-2],a[r-1]),r=b.length,b.push(b[r-6*(p-3)],b[r-6*(p-3)+1]),b.push(b[r-2],b[r-1]),r=d.length,d.push(d[r-9*(p-3)],d[r-9*(p-3)+1],d[r-9*(p-3)+2]),d.push(d[r-3],d[r-2],d[r-1]));y=u=r=0;3*x+2<k.length&&(G=!0,r=k[3*x],u=k[3*x+1],y=k[3*x+2]);a.push(r,u,y);u=r=0;2*w+1<l.length&&(O=!0,r=l[2*w],u=l[2*w+1]);b.push(r,u);u=r=0;y=1;-1!=c&&(3*c+2<m.length&&(S=!0,r=m[3*c],u=m[3*c+1],y=m[3*c+2]),d.push(r,u,y));J||(q[A[p]]=n++)}J||(x=q[A[p]],T.push(x),I<x&&(I=x))}if(!J)for(p=2;p<T.length;p++)f.push(T[0],
T[p-1],T[p])}}else"g"==A[0]||"usemtl"==A[0]?1<A.length&&(null!=P&&(P.length=f.length-P.start,0<P.length&&Y.push(P)),P={name:A[1],start:f.length,length:-1,material:""}):"usemtl"==A[0]&&P&&(P.material=A[1]);if(!k.length)return console.error("OBJ doesnt have vertices, maybe the file is not a OBJ"),null;P&&1<f.length-P.start&&(P.length=f.length-P.start,Y.push(P));if((65536<I||J)&&0<f.length){console.log("Deindexing mesh...");k=new Float32Array(3*f.length);l=d&&d.length?new Float32Array(3*f.length):null;
m=b&&b.length?new Float32Array(2*f.length):null;for(p=0;p<f.length;p+=1)k.set(a.slice(3*f[p],3*f[p]+3),3*p),l&&l.set(d.slice(3*f[p],3*f[p]+3),3*p),m&&m.set(b.slice(2*f[p],2*f[p]+2),2*p);a=k;l&&(d=l);m&&(b=m);f=null}p={};G&&(p.vertices=new Float32Array(a));S&&0<d.length&&(p.normals=new Float32Array(d));O&&0<b.length&&(p.coords=new Float32Array(b));f&&0<f.length&&(p.triangles=new Uint16Array(f));a={};1<Y.length&&(a.groups=Y);p.info=a;Y=Mesh.load(p,null,e.mesh);Y.updateBounding();return Y};Mesh.parsers.obj=
Mesh.parseOBJ.bind(Mesh);Mesh.encoders.obj=function(c,e){e=c.getBuffer("vertices");if(!e)return null;var a="# Generated with liteGL.js by Javi Agenjo\n\n";e=e.data;for(var b=0;b<e.length;b+=3)a+="v "+e[b].toFixed(4)+" "+e[b+1].toFixed(4)+" "+e[b+2].toFixed(4)+"\n";if(b=c.getBuffer("normals")){a+="\n";var d=b.data;for(b=0;b<d.length;b+=3)a+="vn "+d[b].toFixed(4)+" "+d[b+1].toFixed(4)+" "+d[b+2].toFixed(4)+"\n"}if(b=c.getBuffer("coords"))for(a+="\n",d=b.data,b=0;b<d.length;b+=2)a+="vt "+d[b].toFixed(4)+
" "+d[b+1].toFixed(4)+"  0.0000\n";a+="\ng mesh\n";if(b=c.getIndexBuffer("triangles"))for(e=b.data,b=0;b<e.length;b+=3)a+="f "+(e[b]+1)+"/"+(e[b]+1)+"/"+(e[b]+1)+" "+(e[b+1]+1)+"/"+(e[b+1]+1)+"/"+(e[b+1]+1)+" "+(e[b+2]+1)+"/"+(e[b+2]+1)+"/"+(e[b+2]+1)+"\n";else for(b=0;b<e.length/3;b+=3)a+="f "+(b+1)+"/"+(b+1)+"/"+(b+1)+" "+(b+2)+"/"+(b+2)+"/"+(b+2)+" "+(b+3)+"/"+(b+3)+"/"+(b+3)+"\n";return a}})("undefined"!=typeof window?window:"undefined"!=typeof self?self:global);"use strict";
if("undefined"==typeof GL)throw"litegl.js must be included to use enableWebGLCanvas";
function enableWebGLCanvas(K,fa){function t(){m="\n\t\t\t\tprecision highp float;\n\t\t\t\tattribute vec3 a_vertex;\n\t\t\t\tuniform vec2 u_viewport;\n\t\t\t\tuniform mat3 u_transform;\n\t\t\t\t#ifdef EXTRA_PROJECTION\n\t\t\t\t\tuniform bool u_projection_enabled;\n\t\t\t\t\tuniform mat4 u_projection;\n\t\t\t\t#endif\n\t\t\t\tvarying float v_visible;\n\t\t\t\tvoid main() { \n\t\t\t\t\tvec3 pos = a_vertex;\n\t\t\t\t\tv_visible = pos.z;\n\t\t\t\t\tpos = u_transform * vec3(pos.xy,1.0);\n\t\t\t\t\tpos.z = 0.0;\n\t\t\t\t\t#ifdef EXTRA_PROJECTION\n\t\t\t\t\t\tif(u_projection_enabled)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tgl_Position = u_projection * vec4(pos.xy,0.0,1.0);\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t#endif\n\t\t\t\t\t//normalize\n\t\t\t\t\tpos.x = (2.0 * pos.x / u_viewport.x) - 1.0;\n\t\t\t\t\tpos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);\n\t\t\t\t\tgl_Position = vec4(pos, 1.0); \n\t\t\t\t}\n\t\t\t\t";q=
"\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform vec2 u_position;\n\t\t\tuniform vec2 u_size;\n\t\t\tuniform vec2 u_viewport;\n\t\t\tuniform mat3 u_transform;\n\t\t\t#ifdef EXTRA_PROJECTION\n\t\t\t\tuniform bool u_projection_enabled;\n\t\t\t\tuniform mat4 u_projection;\n\t\t\t#endif\n\t\t\tvoid main() { \n\t\t\t\tvec3 pos = vec3(u_position + vec2(a_coord.x,1.0 - a_coord.y)  * u_size, 1.0);\n\t\t\t\tv_coord = a_coord; \n\t\t\t\tpos = u_transform * pos;\n\t\t\t\tpos.z = 0.0;\n\t\t\t\t#ifdef EXTRA_PROJECTION\n\t\t\t\t\tif(u_projection_enabled)\n\t\t\t\t\t{\n\t\t\t\t\t\tgl_Position = u_projection * vec4(pos.xy,0.0,1.0);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t#endif\n\t\t\t\t//normalize\n\t\t\t\tpos.x = (2.0 * pos.x / u_viewport.x) - 1.0;\n\t\t\t\tpos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);\n\t\t\t\tgl_Position = vec4(pos, 1.0); \n\t\t\t}\n\t\t";
n=new GL.Shader(q,"\n\t\t\t\tprecision highp float;\n\t\t\t\tuniform vec4 u_color;\n\t\t\t\tvoid main() {\n\t\t\t\t\tgl_FragColor = u_color;\n\t\t\t\t}\n\t\t\t",k);p=new GL.Shader(q,"\n\t\t\t\tprecision highp float;\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t\tuniform vec4 u_color;\n\t\t\t\tuniform sampler2D u_texture;\n\t\t\t\tvoid main() {\n\t\t\t\t\tgl_FragColor = u_color * texture2D( u_texture, v_coord );\n\t\t\t\t}\n\t\t\t",k);x=new GL.Shader(q,"\n\t\t\t\tprecision highp float;\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t\tuniform vec4 u_color;\n\t\t\t\tuniform sampler2D u_texture;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvec4 color = u_color * texture2D( u_texture, v_coord );\n\t\t\t\t\tif(color.a <= 0.0)\n\t\t\t\t\t\tdiscard;\n\t\t\t\t\tgl_FragColor = color;\n\t\t\t\t}\n\t\t\t",
k);w=new GL.Shader(m,"\n\t\t\t\tprecision highp float;\n\t\t\t\tvarying float v_visible;\n\t\t\t\tuniform vec4 u_color;\n\t\t\t\tvoid main() {\n\t\t\t\t\tif (v_visible == 0.0)\n\t\t\t\t\t\tdiscard;\n\t\t\t\t\tgl_FragColor = u_color;\n\t\t\t\t}\n\t\t\t",k);r=new GL.Shader(GL.Shader.QUAD_VERTEX_SHADER,"\n\t\t\t\tprecision highp float;\n\t\t\t\tuniform sampler2D u_texture;\n\t\t\t\tuniform vec4 u_color;\n\t\t\t\tuniform vec4 u_texture_transform;\n\t\t\t\tvarying vec2 v_coord;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvec2 uv = v_coord * u_texture_transform.zw + vec2(u_texture_transform.x,0.0);\n\t\t\t\t\tuv.y = uv.y - u_texture_transform.y + (1.0 - u_texture_transform.w);\n\t\t\t\t\tuv = clamp(uv,vec2(0.0),vec2(1.0));\n\t\t\t\t\tgl_FragColor = u_color * texture2D(u_texture, uv);\n\t\t\t\t}\n\t\t\t",
k);u=new GL.Shader(m,"\n\t\t\t\tprecision highp float;\n\t\t\t\tvarying float v_visible;\n\t\t\t\tuniform vec4 u_color;\n\t\t\t\tuniform sampler2D u_texture;\n\t\t\t\tuniform vec4 u_texture_transform;\n\t\t\t\tuniform vec2 u_viewport;\n\t\t\t\tuniform mat3 u_itransform;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvec2 pos = (u_itransform * vec3( gl_FragCoord.s, u_viewport.y - gl_FragCoord.t,1.0)).xy;\n\t\t\t\t\tpos *= vec2( (u_viewport.x * u_texture_transform.z), (u_viewport.y * u_texture_transform.w) );\n\t\t\t\t\tvec2 uv = fract(pos / u_viewport) + u_texture_transform.xy;\n\t\t\t\t\tuv.y = 1.0 - uv.y;\n\t\t\t\t\tgl_FragColor = u_color * texture2D( u_texture, uv);\n\t\t\t\t}\n\t\t\t",
k);y=new GL.Shader(m,"\n\t\t\t\tprecision highp float;\n\t\t\t\tvarying float v_visible;\n\t\t\t\tuniform vec4 u_color;\n\t\t\t\tuniform sampler2D u_texture;\n\t\t\t\tuniform vec4 u_gradient;\n\t\t\t\tuniform vec2 u_viewport;\n\t\t\t\tuniform mat3 u_itransform;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvec2 pos = (u_itransform * vec3( gl_FragCoord.s, u_viewport.y - gl_FragCoord.t,1.0)).xy;\n\t\t\t\t\t//vec2 pos = vec2( gl_FragCoord.s, u_viewport.y - gl_FragCoord.t);\n\t\t\t\t\tvec2 AP = pos - u_gradient.xy;\n\t\t\t\t\tvec2 AB = u_gradient.zw - u_gradient.xy;\n\t\t\t\t\tfloat dotAPAB = dot(AP,AB);\n\t\t\t\t\tfloat dotABAB = dot(AB,AB);\n\t\t\t\t\tfloat x = dotAPAB / dotABAB;\n\t\t\t\t\tvec2 uv = vec2( x, 0.0 );\n\t\t\t\t\tgl_FragColor = u_color * texture2D( u_texture, uv );\n\t\t\t\t}\n\t\t\t",
k);A=new GL.Shader("\n\t\t\tprecision highp float;\n\t\t\tattribute vec3 a_vertex;\n\t\t\tattribute vec2 a_coord;\n\t\t\tvarying vec2 v_coord;\n\t\t\tuniform vec2 u_viewport;\n\t\t\tuniform mat3 u_transform;\n\t\t\t#ifdef EXTRA_PROJECTION\n\t\t\t\tuniform bool u_projection_enabled;\n\t\t\t\tuniform mat4 u_projection;\n\t\t\t#endif\n\t\t\tuniform float u_pointSize;\n\t\t\tvoid main() { \n\t\t\t\tvec3 pos = a_vertex;\n\t\t\t\tpos = u_transform * pos;\n\t\t\t\tpos.z = 0.0;\n\t\t\t\t#ifdef EXTRA_PROJECTION\n\t\t\t\t\tif(u_projection_enabled)\n\t\t\t\t\t{\n\t\t\t\t\t\tgl_Position = u_projection * vec4(pos.xy,0.0,1.0);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t#endif\n\t\t\t\t//normalize\n\t\t\t\tpos.x = (2.0 * pos.x / u_viewport.x) - 1.0;\n\t\t\t\tpos.y = -((2.0 * pos.y / u_viewport.y) - 1.0);\n\t\t\t\tgl_Position = vec4(pos, 1.0); \n\t\t\t\tgl_PointSize = ceil(u_pointSize);\n\t\t\t\tv_coord = a_coord;\n\t\t\t}\n\t\t\t",
"\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform float u_iCharSize;\n\t\t\tuniform vec4 u_color;\n\t\t\tuniform float u_pointSize;\n\t\t\tuniform vec2 u_viewport;\n\t\t\tuniform vec2 u_angle_sincos;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tvec2 uv = vec2(1.0 - gl_PointCoord.s, gl_PointCoord.t);\n\t\t\t\tuv = vec2( ((uv.y - 0.5) * u_angle_sincos.y - (uv.x - 0.5) * u_angle_sincos.x) + 0.5, ((uv.x - 0.5) * u_angle_sincos.y + (uv.y - 0.5) * u_angle_sincos.x) + 0.5);\n\t\t\t\tuv = v_coord - uv * u_iCharSize + vec2(u_iCharSize*0.5);\n\t\t\t\tuv.y = 1.0 - uv.y;\n\t\t\t\tgl_FragColor = vec4(u_color.xyz, u_color.a * texture2D(u_texture, uv, -1.0  ).a);\n\t\t\t}\n\t\t\t",
k)}function la(v){var D;if(v.constructor===GL.Texture){if(v._context_id==z.context_id)return v}else{v.gl||(v.gl={});if(v.src){var H=z.REPEAT;return(D=v.gl[z.context_id])?(v.mustUpdate&&(D.uploadData(v),v.mustUpdate=!1),D):v.gl[z.context_id]=GL.Texture.fromImage(v,{magFilter:z.LINEAR,minFilter:z.LINEAR_MIPMAP_LINEAR,wrap:H,ignore_pot:!0,premultipliedAlpha:!0,anisotropic:d})}return(D=v.gl[z.context_id])?(1===v.mustUpdate&&(D.uploadImage(v),v.mustUpdate=0),D):v.gl[z.context_id]=GL.Texture.fromImage(v,
{minFilter:z.LINEAR,magFilter:z.LINEAR,anisotropic:d})}return null}function da(v,D,H,N){this.id=E._last_gradient_id++%E._max_gradients;this.points=new Float32Array([v,D,H,N]);this.stops=[];this._must_update=!0}function ha(v,D,H){v=v||"monospace";D=D||"normal";getTime();var N=this.imageSmoothingEnabled,C=enableWebGLCanvas.useInternationalFont,Q=":font_"+v+":"+D+":"+C,R=l[Q];if(R&&!H)return R;var ba=200;R=10;C&&(ba=400,R=20);var U=1024/R|0;C=.95*U|0;R=createCanvas(1024,1024);H=R.getContext("2d");H.fillStyle=
"white";H.imageSmoothingEnabled=this.imageSmoothingEnabled;H.clearRect(0,0,R.width,R.height);H.font=D+" "+C+"px "+v;H.textAlign="center";var X=0,Z=0,ma=-.3*C;v={font_size:C,char_size:U,spacing:.6*U,space:H.measureText(" ").width/C};ma+=enableWebGLCanvas.fontOffsetY*U;D=v.kernings={};for(var ka=33;ka<ba;ka++){var ia=String.fromCharCode(ka),na=H.measureText(ia).width;D[ia]={width:na,nwidth:na/C}}for(ka=33;ka<ba;++ka){ia=String.fromCharCode(ka);var oa=D[ia];oa&&oa.width&&(v[ka]=[ia,(X+.5*U)/R.width,
(Z+.5*U)/R.height],H.save(),H.beginPath(),H.rect(Math.floor(X)+.5,Math.floor(Z)+.5,U-2,U-2),H.clip(),H.fillText(ia,Math.floor(X+.5*U),Math.floor(Z+U+ma),U),H.restore(),X+=U,X+U>R.width&&(X=0,Z+=U));if(Z+U>R.height)break}ba=ka;for(ka=33;ka<ba;++ka)for(ia=String.fromCharCode(ka),oa=D[ia],na=oa.width,U=33;U<ba;++U)if(X=String.fromCharCode(U),Z=D[X].width)ma=H.measureText(ia+X).width,oa[X]=(1.45*ma-na-Z)/C;R=GL.Texture.fromImage(R,{format:z.ALPHA,magFilter:N?z.LINEAR:z.NEAREST,minFilter:N?z.NEAREST_MIPMAP_LINEAR:
z.NEAREST,premultiply_alpha:!1,anisotropic:8});R.info=v;return l[Q]=R}fa=fa||{};if(K.is_webgl)var z=K.gl;else{fa.canvas=K;fa.alpha=!0;fa.stencil=!0;try{z=GL.create(fa)}catch(v){return console.log("This canvas cannot be used as WebGL, maybe WebGL is not supported or this canvas has already a 2D context associated"),z=K.getContext("2d",fa)}}if(K.canvas2DtoWebGL_enabled)return z;K.canvas2DtoWebGL_enabled=!0;var pa=null,E=K.ctx=z;E.WebGLCanvas={};vec4.fromValues(1,1,1,1);var F=0,g=new Float32Array(3E4),
h=new GL.Mesh,c=h.createVertexBuffer("vertices",null,null,g,z.STREAM_DRAW),e=GL.Mesh.getScreenQuad(),a=GL.Mesh.circle({size:1}),b=mat4.create(),d=void 0!==fa.anisotropic?fa.anisotropic:2,f={u_texture:0},k={};fa.allow3D&&(k.EXTRA_PROJECTION="");var l=z.WebGLCanvas.textures_atlas={};z.WebGLCanvas.clearAtlas=function(){l=z.WebGLCanvas.textures_atlas={}};var m=null,q=null,n=null,p=null,x=null,w=null,r=null,u=null,y=null,A=null;z.WebGLCanvas.set3DMatrix=function(v){v?b.set(v):mat4.identity(b);null==k.EXTRA_PROJECTION&&
(k.EXTRA_PROJECTION="",t(),f.u_projection=b);f.u_projection_enabled=!!v};t();E.createImageShader=function(v){return new GL.Shader(GL.Shader.QUAD_VERTEX_SHADER,"\n\t\t\tprecision highp float;\n\t\t\tuniform sampler2D u_texture;\n\t\t\tuniform vec4 u_color;\n\t\t\tuniform vec4 u_texture_transform;\n\t\t\tuniform vec2 u_viewport;\n\t\t\tvarying vec2 v_coord;\n\t\t\tvoid main() {\n\t\t\t\tvec2 uv = v_coord * u_texture_transform.zw + vec2(u_texture_transform.x,0.0);\n\t\t\t\tuv.y = uv.y - u_texture_transform.y + (1.0 - u_texture_transform.w);\n\t\t\t\tuv = clamp(uv,vec2(0.0),vec2(1.0));\n\t\t\t\tvec4 color = u_color * texture2D(u_texture, uv);\n\t\t\t\t"+
v+";\n\t\t\t\tgl_FragColor = color;\n\t\t\t}\n\t\t",k)};E.WebGLCanvas.vertex_shader=m;E._matrix=mat3.create();var G=mat3.create(),O=vec2.create(),S=vec4.create(),B=vec4.create(),I=vec2.create();E._stack=[];var J=E._stack_size=0,M=E.viewport_data.subarray(2,4);E.resize=function(){z.viewport(0,0,K.width,K.height);M=E.viewport_data.subarray(2,4)};E.translate=function(v,D){O[0]=v;O[1]=D;mat3.translate(this._matrix,this._matrix,O)};E.rotate=function(v){mat3.rotate(this._matrix,this._matrix,v);J+=v};E.scale=
function(v,D){O[0]=v;O[1]=D;mat3.scale(this._matrix,this._matrix,O)};E.resetTransform=function(){z._stack_size=0;this._matrix.set([1,0,0,0,1,0,0,0,1]);J=0};E.save=function(){if(!(32<=this._stack_size)){var v=this._stack_size==this._stack.length?this._stack[this._stack_size]={matrix:mat3.create(),fillColor:vec4.create(),strokeColor:vec4.create(),shadowColor:vec4.create(),globalAlpha:1,font:"",fontFamily:"",fontSize:14,fontMode:"",textAlign:"",clip_level:0}:this._stack[this._stack_size];this._stack_size++;
v.matrix.set(this._matrix);v.fillColor.set(this._fillcolor);v.strokeColor.set(this._strokecolor);v.shadowColor.set(this._shadowcolor);v.globalAlpha=this._globalAlpha;v.font=this._font;v.fontFamily=this._font_family;v.fontSize=this._font_size;v.fontMode=this._font_mode;v.textAlign=this.textAlign;v.clip_level=this.clip_level}};E.restore=function(){if(0==this._stack_size)mat3.identity(this._matrix),J=0;else{this._stack_size--;var v=this._stack[this._stack_size];this._matrix.set(v.matrix);this._fillcolor.set(v.fillColor);
this._strokecolor.set(v.strokeColor);this._shadowcolor.set(v.shadowColor);this._globalAlpha=v.globalAlpha;this._font=v.font;this._font_family=v.fontFamily;this._font_size=v.fontSize;this._font_mode=v.fontMode;this.textAlign=v.textAlign;var D=this.clip_level;this.clip_level=v.clip_level;J=Math.atan2(this._matrix[3],this._matrix[4]);D!=this.clip_level&&(0==this.clip_level?(z.enable(z.STENCIL_TEST),z.clearStencil(0),z.clear(z.STENCIL_BUFFER_BIT),z.disable(z.STENCIL_TEST)):(z.stencilFunc(z.LEQUAL,this.clip_level,
255),z.stencilOp(z.KEEP,z.KEEP,z.KEEP)))}};E.clip=function(){this.clip_level++;z.colorMask(!1,!1,!1,!1);z.depthMask(!1);z.enable(z.STENCIL_TEST);z.stencilFunc(z.EQUAL,this.clip_level-1,255);z.stencilOp(z.KEEP,z.KEEP,z.INCR);this.fill();z.colorMask(!0,!0,!0,!0);z.depthMask(!0);z.stencilFunc(z.EQUAL,this.clip_level,255);z.stencilOp(z.KEEP,z.KEEP,z.KEEP)};E.clipImage=function(v,D,H,N,C){this.clip_level++;z.colorMask(!1,!1,!1,!1);z.depthMask(!1);z.enable(z.STENCIL_TEST);z.stencilFunc(z.EQUAL,this.clip_level-
1,255);z.stencilOp(z.KEEP,z.KEEP,z.INCR);this.drawImage(v,D,H,N,C,x);z.colorMask(!0,!0,!0,!0);z.depthMask(!0);z.stencilFunc(z.EQUAL,this.clip_level,255);z.stencilOp(z.KEEP,z.KEEP,z.KEEP)};E.transform=function(v,D,H,N,C,Q){G[0]=v;G[1]=D;G[2]=0;G[3]=H;G[4]=N;G[5]=0;G[6]=C;G[7]=Q;G[8]=1;mat3.multiply(this._matrix,this._matrix,G);J=Math.atan2(this._matrix[0],this._matrix[1])};E.setTransform=function(v,D,H,N,C,Q){var R=this._matrix;R[0]=v;R[1]=D;R[2]=0;R[3]=H;R[4]=N;R[5]=0;R[6]=C;R[7]=Q;R[8]=1;J=Math.atan2(this._matrix[0],
this._matrix[1])};E.drawImage=function(v,D,H,N,C,Q){if(v){var R=v.videoWidth||v.width,ba=v.videoHeight||v.height;if(0!=R&&0!=ba){var U=la(v);U&&(9==arguments.length?(B.set([D/R,H/ba,N/R,C/ba]),D=arguments[5],H=arguments[6],N=arguments[7],C=arguments[8],Q=r):B.set([0,0,1,1]),O[0]=D,O[1]=H,I[0]=void 0===N?U.width:N,I[1]=void 0===C?U.height:C,U.bind(0),U!==v&&z.texParameteri(z.TEXTURE_2D,z.TEXTURE_MAG_FILTER,this.imageSmoothingEnabled?z.LINEAR:z.NEAREST),this.tintImages||(S[0]=S[1]=S[2]=1,S[3]=this._globalAlpha),
f.u_color=this.tintImages?this._fillcolor:S,f.u_position=O,f.u_size=I,f.u_transform=this._matrix,f.u_texture_transform=B,f.u_viewport=M,Q=Q||p,Q.uniforms(f).draw(e),b[14]-=.001)}}};E.createPattern=function(v){return la(v)};E._last_gradient_id=0;E._max_gradients=16;E._gradients_pool=[];da.prototype.addColorStop=function(v,D){D=hexColorToRGBA(D);var H=new Uint8Array(4);H[0]=255*Math.clamp(D[0],0,1);H[1]=255*Math.clamp(D[1],0,1);H[2]=255*Math.clamp(D[2],0,1);H[3]=255*Math.clamp(D[3],0,1);this.stops.push([v,
H]);this.stops.sort(function(N,C){return N[0]>C[0]?1:C[0]>N[0]?-1:0});this._must_update=!0};da.prototype.toTexture=function(){this._texture||(-1!=this.id&&(this._texture=E._gradients_pool[this.id]),this._texture||(this._texture=new GL.Texture(128,1,{format:z.RGBA,magFilter:z.LINEAR,wrap:z.CLAMP_TO_EDGE,minFilter:z.NEAREST}),-1!=this.id&&(E._gradients_pool[this.id]=this._texture)));if(!this._must_update)return this._texture;this._must_update=!1;if(1>this.stops.length)return this._texture;if(2>this.stops.length)return this._texture.fill(this.stops[0][1]),
this._texture;for(var v=0,D=this.stops[v],H=this.stops[v+1],N=new Uint8Array(512),C=0;128>C;C+=1){var Q=N.subarray(4*C,4*C+4),R=C/128;if(D[0]>R)if(0==v)Q.set(D[1]);else{v+=1;D=this.stops[v];H=this.stops[v+1];if(!H)break;--C}else if(D[0]<=R&&R<H[0])vec4.lerp(Q,D[1],H[1],(R-D[0])/(H[0]-D[0]));else if(H[0]<=R){v+=1;D=this.stops[v];H=this.stops[v+1];if(!H)break;--C}}if(128>C)for(v=C;128>v;v+=1)N.set(D[1],4*v);this._texture.uploadData(N);return this._texture};E.createLinearGradient=function(v,D,H,N){return new da(v,
D,H,N)};E.beginPath=function(){F=0};E.closePath=function(){3>F||(g[F]=g[0],g[F+1]=g[1],g[F+2]=1,F+=3)};E.moveTo=function(v,D){0==F?(g[F]=v,g[F+1]=D,g[F+2]=1):(g[F]=g[F-3],g[F+1]=g[F-2],g[F+2]=0,F+=3,g[F]=v,g[F+1]=D,g[F+2]=0);F+=3};E.lineTo=function(v,D){g[F]=v;g[F+1]=D;g[F+2]=1;F+=3};E.bezierCurveTo=function(v,D,H,N,C,Q){if(!(3>F))for(v=[[g[F-3],g[F-2]],[v,D],[H,N],[C,Q]],D=0;50>=D;D++){H=D/50;Q=3*(v[1][0]-v[0][0]);C=3*(v[2][0]-v[1][0])-Q;N=v[3][0]-v[0][0]-Q-C;var R=3*(v[1][1]-v[0][1]);var ba=3*(v[2][1]-
v[1][1])-R;var U=v[3][1]-v[0][1]-R-ba;var X=H*H;var Z=X*H;U=U*Z+ba*X+R*H+v[0][1];g[F]=N*Z+C*X+Q*H+v[0][0];g[F+1]=U;g[F+2]=1;F+=3}};E.quadraticCurveTo=function(v,D,H,N){if(!(3>F))for(var C=g[F-3],Q=g[F-2],R=0;50>=R;R++){var ba=R/50,U=1-ba,X=Q*U+D*ba,Z=D*U+N*ba;g[F]=(C*U+v*ba)*U+(v*U+H*ba)*ba;g[F+1]=X*U+Z*ba;g[F+2]=1;F+=3}};E.fill=function(){if(!(9>F)){c.uploadRange(0,4*F);f.u_viewport=M;var v=w;0<this._shadowcolor[3]&&(f.u_color=this._shadowcolor,this.save(),this.translate(this.shadowOffsetX,this.shadowOffsetY),
v.uniforms(f).drawRange(h,z.TRIANGLE_FAN,0,F/3),this.restore());f.u_color=this._fillcolor;f.u_transform=this._matrix;var D=this._fillStyle;D.constructor===da?(v=D.toTexture(),f.u_color=[1,1,1,this.globalAlpha],f.u_gradient=D.points,f.u_texture=0,f.u_itransform=mat3.invert(G,this._matrix),v.bind(0),v=y):D.constructor===GL.Texture&&(v=D,f.u_color=[1,1,1,this._globalAlpha],f.u_texture=0,S.set([0,0,1/v.width,1/v.height]),f.u_texture_transform=S,f.u_itransform=mat3.invert(G,this._matrix),v.bind(0),v=u);
v.uniforms(f).drawRange(h,z.TRIANGLE_FAN,0,F/3);b[14]-=.001}};E.strokeThin=function(){6>F||(c.uploadRange(0,4*F),z.setLineWidth(this.lineWidth),f.u_color=this._strokecolor,f.u_transform=this._matrix,f.u_viewport=M,w.uniforms(f).drawRange(h,z.LINE_STRIP,0,F/3))};var L=new Float32Array(3E4),P=new GL.Mesh,Y=P.createVertexBuffer("vertices",null,null,L,z.STREAM_DRAW);E.stroke=function(){if(!(6>F)){O[0]=this._matrix[0];O[1]=this._matrix[1];if(1>=this.lineWidth*vec2.length(O))return this.strokeThin();var v=
F,D=.5*this.lineWidth,H=0,N=0,C,Q,R=Q=C=0,ba=0;if(g[0]==g[F-3]&&g[1]==g[F-2]){H=g[F-3]-g[F-6];N=g[F-2]-g[F-5];var U=Math.sqrt(H*H+N*N);0!=U&&(H/=U,N/=U)}var X,Z=0;for(X=0;X<v-3;X+=3)C=H,Q=N,H=g[X+3]-g[X],N=g[X+4]-g[X+1],U=Math.sqrt(H*H+N*N),0!=U&&(H/=U,N/=U),0==X&&(R=H,ba=N),C=H+C,Q=N+Q,U=Math.sqrt(C*C+Q*Q),0!=U&&(C/=U,Q/=U),L[Z+0]=g[X]-Q*D,L[Z+1]=g[X+1]+C*D,L[Z+2]=1,L[Z+3]=g[X]+Q*D,L[Z+4]=g[X+1]-C*D,L[Z+5]=1,Z+=6;g[0]==g[F-3]&&g[1]==g[F-2]?(C=H+R,Q=N+ba,U=Math.sqrt(C*C+Q*Q),0!=U&&(C/=U,Q/=U),L[Z+
0]=g[X]-Q*D,L[Z+1]=g[X+1]+C*D,L[Z+2]=1,L[Z+3]=g[X]+Q*D,L[Z+4]=g[X+1]-C*D):(U=Math.sqrt(H*H+N*N),0!=U&&(C=H/U,Q=N/U),L[Z+0]=g[X]-(Q-C)*D,L[Z+1]=g[X+1]+(C+Q)*D,L[Z+2]=1,L[Z+3]=g[X]+(Q+C)*D,L[Z+4]=g[X+1]-(C-Q)*D);L[Z+5]=1;Z+=6;Y.upload(z.STREAM_DRAW);Y.uploadRange(0,4*Z);f.u_transform=this._matrix;f.u_viewport=M;0<this._shadowcolor[3]&&(f.u_color=this._shadowcolor,this.save(),this.translate(this.shadowOffsetX,this.shadowOffsetY),w.uniforms(f).drawRange(h,z.TRIANGLE_STRIP,0,Z/3),this.restore());f.u_color=
this._strokecolor;w.uniforms(f).drawRange(P,z.TRIANGLE_STRIP,0,Z/3);b[14]-=.001}};E.rect=function(v,D,H,N){g[F]=v;g[F+1]=D;g[F+2]=1;g[F+3]=v+H;g[F+4]=D;g[F+5]=1;g[F+6]=v+H;g[F+7]=D+N;g[F+8]=1;g[F+9]=v;g[F+10]=D+N;g[F+11]=1;g[F+12]=v;g[F+13]=D;g[F+14]=1;F+=15};E.roundRect=function(v,D,H,N,C,Q){var R,ba;if(0===C)this.rect(v,D,H,N);else{void 0===Q&&(Q=C);if(null!=C&&C.constructor===Array)if(1==C.length)var U=R=ba=Q=C[0];else if(2==C.length)U=Q=C[0],R=ba=C[1];else if(4==C.length)U=C[0],R=C[1],ba=C[2],
Q=C[3];else return;else U=C||0,R=C||0,ba=Q||0,Q=Q||0;C=F;if(0<U)for(var X=0;10>X;++X){var Z=X/10*Math.PI*.5;g[C]=v+U*(1-Math.cos(Z));g[C+1]=D+U*(1-Math.sin(Z));g[C+2]=1;C+=3}g[C+0]=v+U;g[C+1]=D;g[C+2]=1;g[C+3]=v+H-R;g[C+4]=D;g[C+5]=1;C+=6;if(0<R)for(X=0;10>X;++X)Z=X/10*Math.PI*.5,g[C+0]=v+H-R*(1-Math.sin(Z)),g[C+1]=D+R*(1-Math.cos(Z)),g[C+2]=1,C+=3;g[C+0]=v+H;g[C+1]=D+R;g[C+2]=1;g[C+3]=v+H;g[C+4]=D+N-Q;g[C+5]=1;C+=6;if(0<Q)for(X=0;10>X;++X)Z=X/10*Math.PI*.5,g[C+0]=v+H-Q*(1-Math.cos(Z)),g[C+1]=D+N-
Q*(1-Math.sin(Z)),g[C+2]=1,C+=3;g[C+0]=v+H-Q;g[C+1]=D+N;g[C+2]=1;g[C+3]=v+ba;g[C+4]=D+N;g[C+5]=1;C+=6;if(0<ba)for(X=0;10>X;++X)Z=X/10*Math.PI*.5,g[C+0]=v+ba*(1-Math.sin(Z)),g[C+1]=D+N-ba*(1-Math.cos(Z)),g[C+2]=1,C+=3;g[C+0]=v;g[C+1]=D+U;g[C+2]=1;F=C+3}};E.arc=function(v,D,H,N,C){var Q=Math.ceil(2*H*Math.max(Math.abs(this._matrix[0]),Math.abs(this._matrix[1]),Math.abs(this._matrix[3]),Math.abs(this._matrix[4]))+1);if(!(1>Q)){Q=Math.min(Q,1024);N=void 0===N?0:N;C=void 0===C?2*Math.PI:C;C=(C-N)/Q;for(var R=
0;R<=Q;R++){var ba=N+R*C;this.lineTo(v+Math.cos(ba)*H,D+Math.sin(ba)*H)}}};E.strokeRect=function(v,D,H,N){this.beginPath();this.rect(v,D,H,N);this.stroke()};E.fillRect=function(v,D,H,N){F=0;this._fillStyle.constructor==GL.Texture||this._fillStyle.constructor===da?(this.beginPath(),this.rect(v,D,H,N),this.fill()):(f.u_color=this._fillcolor,O[0]=v,O[1]=D,I[0]=H,I[1]=N,f.u_position=O,f.u_size=I,f.u_transform=this._matrix,f.u_viewport=M,n.uniforms(f).draw(e),b[14]-=.001)};E.clearRect=function(v,D,H,N){if(0!=
v||0!=D||H!=K.width||N!=K.height)z.enable(z.SCISSOR_TEST),z.scissor(v,D,H,N);z.clear(z.COLOR_BUFFER_BIT);v=z.viewport_data;z.scissor(v[0],v[1],v[2],v[3]);z.disable(z.SCISSOR_TEST)};E.fillCircle=function(v,D,H){F=0;this._fillStyle.constructor==GL.Texture||this._fillStyle.constructor===da?(this.beginPath(),this.arc(v,D,H,0,2*Math.PI),this.fill()):(f.u_color=this._fillcolor,O[0]=v,O[1]=D,I[0]=H,I[1]=H,f.u_position=O,f.u_size=I,f.u_transform=this._matrix,f.u_viewport=M,n.uniforms(f).draw(a),b[14]-=.001)};
E.start2D=function(){pa=window.gl;window.gl=this;this.disable(this.CULL_FACE);this.disable(this.DEPTH_TEST);this.disable(this.STENCIL_TEST);this.enable(this.BLEND);this.blendFuncSeparate(this.SRC_ALPHA,this.ONE_MINUS_SRC_ALPHA,this.ONE,this.ONE_MINUS_SRC_ALPHA);this.blendEquation(this.FUNC_ADD);this.lineWidth=1;F=0;mat4.identity(b);this.clip_level=0};E.finish2D=function(){F=0;z.lineWidth=1;window.gl=pa;z.disable(z.STENCIL_TEST)};var W=new Float32Array(3E3),aa=new Float32Array(2E3),ca=new GL.Mesh,
T=ca.createVertexBuffer("vertices",null,null,W,z.STREAM_DRAW),V=ca.createVertexBuffer("coords",null,null,aa,z.STREAM_DRAW);E.fillText=E.strokeText=function(v,D,H){if(null!==v&&void 0!==v){v.constructor!==String&&(v=String(v));var N=ha.call(this,this._font_family,this._font_mode),C=N.info,Q=1.1*this._font_size;1>Q&&(Q=1);for(var R=0,ba=0,U=v.length,X=C.kernings,Z=!0,ma=0,ka=0,ia=0;ia<U;ia++){var na=v.charCodeAt(ia);if(na=C[na]){var oa=X[v[ia]];Z&&(R-=Q*oa.nwidth*.25,Z=!1);W[ma+0]=D+R+.5*Q;W[ma+1]=
H+ba-.25*Q;W[ma+2]=1;ma+=3;aa[ka+0]=na[1];aa[ka+1]=na[2];ka+=2;R=(na=oa[v[ia+1]])?R+Q*na:R+Q*C.space}else 10==v.charCodeAt(ia)?(R=0,ba+=Q,Z=!0):R+=.5*Q}v=0;"right"==this.textAlign?v=R+.5*Q:"center"==this.textAlign&&(v=.5*(R+.5*Q));if(v)for(ia=0;ia<W.length;ia+=3)W[ia]-=v;N.bind(0);T.uploadRange(0,4*ma);V.uploadRange(0,4*ka);f.u_color=this._fillcolor;f.u_pointSize=Q*vec2.length(this._matrix);f.u_iCharSize=C.char_size/N.width;f.u_transform=this._matrix;f.u_viewport=M;f.u_angle_sincos||(f.u_angle_sincos=
vec2.create());f.u_angle_sincos[1]=Math.sin(-J);f.u_angle_sincos[0]=-Math.cos(-J);A.uniforms(f).drawRange(ca,z.POINTS,0,ma/3);return{x:R,y:ba}}};E.measureText=function(v){for(var D=ha.call(this,this._font_family,this._font_mode).info,H=Math.ceil(1.1*this._font_size),N=0,C=H*D.spacing/D.char_size-1,Q=0;Q<v.length;++Q){var R=D.kernings[v[Q]];N=R?N+R.nwidth:N+C/D.char_size}return{width:N*H,height:H}};E.getImageData=function(v,D,H,N){var C=new Uint8Array(H*N*4);z.readPixels(v,D,H,N,z.RGBA,z.UNSIGNED_BYTE,
C);return{data:C,width:H,height:N,resolution:1}};E.putImageData=function(v,D,H){v=new GL.Texture(v.width,v.height,{filter:z.NEAREST,pixel_data:v.data});v.renderQuad(D,H,v.width,v.height)};Object.defineProperty(z,"fillStyle",{get:function(){return this._fillStyle},set:function(v){v&&(this._fillStyle=v,hexColorToRGBA(v,this._fillcolor,this._globalAlpha))}});Object.defineProperty(z,"strokeStyle",{get:function(){return this._strokeStyle},set:function(v){v&&(this._strokeStyle=v,hexColorToRGBA(v,this._strokecolor,
this._globalAlpha))}});Object.defineProperty(z,"fillColor",{get:function(){return this._fillcolor},set:function(v){v&&(5>v.length?this._fillcolor.set(v):console.error("fillColor value has more than 4 components"))}});Object.defineProperty(z,"strokeColor",{get:function(){return this._strokecolor},set:function(v){v&&(5>v.length?this._strokecolor.set(v):console.error("strokeColor value has more than 4 components"))}});Object.defineProperty(z,"shadowColor",{get:function(){return this._shadowcolor},set:function(v){v&&
hexColorToRGBA(v,this._shadowcolor,this._globalAlpha)}});Object.defineProperty(z,"globalAlpha",{get:function(){return this._globalAlpha},set:function(v){this._globalAlpha=v;this._strokecolor[3]=this._fillcolor[3]=v}});Object.defineProperty(z,"globalCompositeOperation",{get:function(){return this._globalCompositeOperation},set:function(v){this._globalCompositeOperation=v;z.blendEquation(z.FUNC_ADD);switch(v){case "source-over":z.blendFunc(z.SRC_ALPHA,z.ONE_MINUS_SRC_ALPHA);break;case "difference":z.blendFunc(z.SRC_ALPHA,
z.ONE_MINUS_SRC_ALPHA),z.blendEquation(z.FUNC_REVERSE_SUBTRACT)}}});Object.defineProperty(z,"font",{get:function(){return this._font},set:function(v){this._font=v;v=v.split(" ");3==v.length?(this._font_mode=v[0],this._font_size=parseFloat(v[1]),Number.isNaN(this._font_size)&&(this._font_size=14),10>this._font_size&&(this._font_size=10),this._font_family=v[2]):2==v.length?(this._font_mode="normal",this._font_size=parseFloat(v[0]),Number.isNaN(this._font_size)&&(this._font_size=14),10>this._font_size&&
(this._font_size=10),this._font_family=v[1]):(this._font_mode="normal",this._font_family=v[0])}});E._fillcolor=vec4.fromValues(0,0,0,1);E._strokecolor=vec4.fromValues(0,0,0,1);E._shadowcolor=vec4.fromValues(0,0,0,0);E._globalAlpha=1;E._font="14px monospace";E._font_family="monospace";E._font_size="14px";E._font_mode="normal";E.clip_level=0;E.strokeStyle="rgba(0,0,0,1)";E.fillStyle="rgba(0,0,0,1)";E.shadowColor="transparent";E.shadowOffsetX=E.shadowOffsetY=0;E.globalAlpha=1;E.globalCompositeOperation=
"source-over";E.setLineWidth=E.lineWidth;E.lineWidth=4;E.imageSmoothingEnabled=!0;E.tintImages=!1;fa=["arcTo","isPointInPath","createImageData"];var ea=function(){},ja;for(ja in fa)E[fa[ja]]=ea;return E}enableWebGLCanvas.useInternationalFont=!1;enableWebGLCanvas.fontOffsetY=0;
